<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Flota - Conexión Blindada</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <script type="text/javascript" src="https://hst-api.wialon.com/wscommon/js/wialon.js"></script>

    <style>
        :root { --wialon-blue: #0045a5; }
        body { background-color: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--wialon-blue); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 100%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        #dashboard { display: none; padding-top: 20px; }
        .header-app { background: var(--wialon-blue); color: white; padding: 1rem; border-radius: 0 0 15px 15px; margin-bottom: 20px; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 36px; height: 36px; border-radius: 50%; border-left-color: #0045a5; animation: spin 1s linear infinite; display: inline-block; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card text-center">
            <h3 class="mb-3 fw-bold">Monitor Wialon</h3>
            <p id="statusLabel" class="text-primary small fw-bold">Sincronizando con Wialon...</p>
            <div id="loader" class="spinner mb-3"></div>
            <input type="password" id="tokenInput" class="form-control mb-3 text-center" placeholder="Pega aquí tu Token">
            <button onclick="attemptLogin()" id="btnLogin" class="btn btn-primary w-100 fw-bold" disabled>Esperando Conexión...</button>
        </div>
    </div>

    <div id="dashboard" class="container-fluid">
        <div class="header-app shadow text-center">
            <h2 class="h4 mb-0">Bitácora de Monitoreo Real-Time</h2>
        </div>
        <div class="card p-3 table-responsive shadow-sm">
            <table class="table table-hover align-middle">
                <thead class="table-light text-center">
                    <tr><th>Cliente</th><th>Subcliente</th><th>Unidad</th><th>Estado</th><th>Velocidad</th></tr>
                </thead>
                <tbody id="unitList"></tbody>
            </table>
        </div>
    </div>

    <script>
        var sess = null;

        // Función de verificación de SDK
        function initSDK() {
            if (typeof wialon !== 'undefined' && wialon.core && wialon.core.Session) {
                sess = wialon.core.Session.getInstance();
                document.getElementById('statusLabel').innerText = "Sistema Listo";
                document.getElementById('statusLabel').className = "text-success small fw-bold";
                document.getElementById('btnLogin').disabled = false;
                document.getElementById('btnLogin').innerText = "Entrar al Sistema";
                document.getElementById('loader').style.display = 'none';
            } else {
                // Si falla, intentamos recargar el script dinámicamente
                var script = document.createElement('script');
                script.src = "https://hst-api.wialon.com/wscommon/js/wialon.js";
                script.onload = () => console.log("Reintento exitoso");
                document.head.appendChild(script);
                setTimeout(initSDK, 2000);
            }
        }

        window.onload = initSDK;

        function attemptLogin() {
            const token = document.getElementById('tokenInput').value;
            const btn = document.getElementById('btnLogin');
            if(!token) return;

            btn.disabled = true;
            btn.innerText = "Validando...";

            sess.initSession("https://hst-api.wialon.com");
            sess.loginToken(token, "", (code) => {
                if (code) {
                    alert("Error Wialon: " + code);
                    btn.disabled = false;
                    btn.innerText = "Entrar al Sistema";
                    return;
                }
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                startApp();
            });
        }

        function startApp() {
            sess.loadLibrary("itemUnit");
            sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], () => {
                render();
                sess.addListener("dataUpdated", render);
            });
        }

        function render() {
            const units = sess.getItems("avl_unit") || [];
            const tbody = document.getElementById('unitList');
            tbody.innerHTML = "";
            units.forEach(u => {
                const id = u.getId();
                const pos = u.getPosition();
                const moving = pos && pos.s > 0;
                tbody.innerHTML += `
                    <tr>
                        <td><input class="form-control form-control-sm border-0 bg-light text-center" value="${localStorage.getItem('c_'+id)||''}" onchange="localStorage.setItem('c_${id}', this.value)" placeholder="Cliente"></td>
                        <td><input class="form-control form-control-sm border-0 bg-light text-center" value="${localStorage.getItem('s_'+id)||''}" onchange="localStorage.setItem('s_${id}', this.value)" placeholder="Sub"></td>
                        <td class="fw-bold text-center">${u.getName()}</td>
                        <td class="text-center"><span class="badge ${moving ? 'bg-success' : 'bg-danger'}">${moving ? 'MOV' : 'STOP'}</span></td>
                        <td class="text-primary fw-bold text-center">${pos ? pos.s : 0} km/h</td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>
