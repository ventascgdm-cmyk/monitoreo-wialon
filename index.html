<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>DSG - CargoQuin | C4 Multiplataforma</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>

    <style>
        body { background: #f0f4f8; color: #2c3e50; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; font-size: 0.75rem; }
        .login-bg { background: linear-gradient(135deg, #002a61 0%, #001122 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: white; width: 380px; border-radius: 12px; padding: 40px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header-bar { background: white; padding: 10px 20px; border-bottom: 4px solid #002a61; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .table-input { border: 1px solid #ced4da; padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; font-weight: 600; }
        .table-input:focus { border-color: #002a61; outline: none; box-shadow: inset 0 0 5px rgba(0,42,97,0.2); }
        .group-img { width: 25px; height: 25px; border-radius: 50%; object-fit: cover; margin-right: 5px; border: 1px solid #002a61; }
        th { background-color: #002a61 !important; color: white !important; font-weight: 600; text-align: center; vertical-align: middle;}
        .status-select { border-radius: 15px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.70rem; padding: 2px;}
        .audit-log { font-size: 0.7rem; background: #e9ecef; padding: 6px; border-radius: 5px; border-left: 3px solid #0d6efd; margin-bottom: 4px; text-align: left;}
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.jpg" alt="Logo" style="height: 55px; margin-bottom: 20px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
        <h5 class="text-primary fw-bold mb-4">C4 Multiplataforma</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario de Monitor">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a">
        <button onclick="autenticarUsuario()" class="btn btn-primary w-100 fw-bold py-2 shadow-sm"><i class="fa-solid fa-right-to-bracket"></i> INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Identif√≠cate para continuar</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.jpg" alt="Logo" style="height: 40px;" class="me-3" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
            <div>
                <h5 class="fw-bold m-0" style="color: #002a61;">C4 - BIT√ÅCORA MAESTRA</h5>
                <small class="text-muted fw-bold" id="lblUsuarioActivo"><i class="fa-solid fa-user-shield"></i> Monitor: </small>
            </div>
        </div>
        <div>
            <button class="btn btn-outline-primary btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje">‚ûï Viaje</button>
            <button class="btn btn-outline-secondary btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalGrupos">üìÅ Grupos</button>
            <button class="btn btn-outline-warning btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalHistorial" onclick="cargarHistorial()">üìú Historial</button>
            <button class="btn btn-danger btn-sm fw-bold me-3" id="btnAdmin" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i> ADMIN</button>
            <button onclick="exportarExcel()" class="btn btn-success btn-sm fw-bold"><i class="fa-solid fa-file-excel"></i> Exportar</button>
        </div>
    </div>

    <div class="container-fluid px-3">
        <div class="row mb-2">
            <div class="col-md-3"><input type="text" id="buscador" class="form-control form-control-sm shadow-sm" placeholder="üîç Buscar..." onkeyup="filtrarTabla()"></div>
        </div>
        <div class="card shadow border-0">
            <div class="table-responsive" style="height: 75vh;">
                <table class="table table-bordered table-hover align-middle text-center mb-0" id="tablaViajes">
                    <thead>
                        <tr>
                            <th width="8%">UNIDAD</th><th width="8%">GRUPO</th><th width="9%">OPERADOR</th><th width="9%">CLIENTE</th>
                            <th width="12%">RUTA (O ‚ûî D)</th><th width="8%">CONTENEDORES</th><th width="10%">TIEMPOS</th>
                            <th width="10%">ESTATUS</th><th width="12%">GPS & NOTIFICACI√ìN</th><th width="10%">AUDITOR√çA (NOTAS)</th><th width="4%">FIN</th>
                        </tr>
                    </thead>
                    <tbody id="units-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAdmin" tabindex="-1">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-gears"></i> Configuraci√≥n de Sistema</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div class="row">
              <div class="col-md-6 border-end">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-key"></i> Tokens Multiplataforma</h6>
                  <div class="input-group input-group-sm mb-2"><input type="text" id="nuevoToken" class="form-control" placeholder="Pegar Token Wialon"><button class="btn btn-success" onclick="agregarToken()">A√±adir</button></div>
                  <ul class="list-group list-group-sm" id="listaTokens" style="font-size:10px;"></ul>
              </div>
              <div class="col-md-6">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-users"></i> Gesti√≥n de Monitores</h6>
                  <div class="input-group input-group-sm mb-2"><input type="text" id="nu_user" class="form-control" placeholder="Usuario"><input type="password" id="nu_pass" class="form-control" placeholder="Pass"><button class="btn btn-primary" onclick="crearMonitor()">Crear</button></div>
                  <ul class="list-group list-group-sm" id="listaUsuarios"></ul>
              </div>
          </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalComentarios" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-info text-white"><h6 class="modal-title fw-bold" id="tituloComentarios">Centro de Mensajes</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body small">
          <div class="alert alert-warning p-2" id="msgUltimaNotif" style="font-size:10px;"></div>
          <div id="listaComentarios" class="mb-3" style="max-height: 250px; overflow-y: auto; padding: 5px;"></div>
          <div class="input-group">
              <input type="text" id="nuevoComentario" class="form-control form-control-sm" placeholder="Respuesta / Novedad del monitor...">
              <button class="btn btn-primary btn-sm fw-bold" onclick="guardarComentario()">Registrar Novedad</button>
          </div>
          <input type="hidden" id="comentario_unidad_id">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold">Nuevo Viaje</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><select id="nv_unidad" class="form-select form-select-sm mb-2"></select><select id="nv_grupo" class="form-select form-select-sm mb-2"></select><input type="text" id="nv_origen" class="form-control form-control-sm mb-2" placeholder="Origen"><input type="text" id="nv_destino" class="form-control form-control-sm mb-2" placeholder="Destino"><button onclick="iniciarViaje()" class="btn btn-primary btn-sm w-100 fw-bold mt-2">Crear Viaje</button></div></div></div></div>
<div class="modal fade" id="modalGrupos" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-secondary text-white"><h6 class="modal-title fw-bold">Grupos</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><div class="d-flex mb-3"><input type="text" id="mg_nombre" class="form-control form-control-sm me-2" placeholder="Nombre"><input type="text" id="mg_img" class="form-control form-control-sm me-2" placeholder="URL Img"><button onclick="crearGrupo()" class="btn btn-success btn-sm fw-bold">Crear</button></div><ul class="list-group" id="listaGrupos"></ul></div></div></div></div>

<script type="text/javascript">
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables C4
    let currentUser = null; 
    let configSistema = { tokens: [], usuarios: {} };
    let dataGrupos = {}; let viajesActivos = {}; let unidadesWialon = [];
    const estatusData = { "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s3":{nombre:"3. Cargando",col:"#EAEAEA"}, "s4":{nombre:"4. Descargando",col:"#D0F0C0"}, "s5":{nombre:"8. Finalizado",col:"#0055A5"} }; // Resumido por espacio

    // 2. SISTEMA DE AUTENTICACI√ìN
    function autenticarUsuario() {
        const u = document.getElementById("logUser").value.trim();
        const p = document.getElementById("logPass").value.trim();
        const statusEl = document.getElementById("status");
        
        if(!u || !p) return statusEl.innerText = "Llene sus datos.";
        statusEl.innerText = "Autenticando...";

        db.ref('sistema').once('value', s => {
            let sys = s.val() || { usuarios: { admin: { pass: "admin123", rol: "admin", nom: "Administrador Maestro" } }, tokens: [] };
            
            // Forzar creaci√≥n inicial de BD si no existe
            if(!s.val()) db.ref('sistema').set(sys);

            if(sys.usuarios[u] && sys.usuarios[u].pass === p) {
                currentUser = sys.usuarios[u];
                configSistema = sys;
                
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                document.getElementById("lblUsuarioActivo").innerHTML += currentUser.nom;
                
                if(currentUser.rol === "admin") document.getElementById("btnAdmin").style.display = "inline-block";
                
                cargarDatosSecundarios();
                iniciarMultiplesSesionesWialon();
            } else {
                statusEl.innerHTML = "<span class='text-danger'>Credenciales incorrectas</span>";
            }
        });
    }

    function cargarDatosSecundarios() {
        db.ref('grupos').on('value', s => { dataGrupos = s.val() || {}; actualizarListasGrupos(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; if(unidadesWialon.length>0) renderizarBitacora(); });
        if(currentUser.rol === "admin") renderizarAdmin();
    }

    // 3. MULTI-SESI√ìN WIALON (Carga arreglos de tokens simult√°neos)
    async function iniciarMultiplesSesionesWialon() {
        if(!configSistema.tokens || configSistema.tokens.length === 0) {
            if(currentUser.rol === "admin") alert("No hay tokens de Wialon configurados. Ve al Panel Admin.");
            return;
        }

        unidadesWialon = []; // Limpiar
        let loadedSessions = 0;

        // Iterar sobre cada plataforma/token
        const promesas = configSistema.tokens.map((tk, idx) => {
            return new Promise((resolve) => {
                let sess = wialon.core.Session.getInstance("WialonSess_" + idx);
                sess.initSession("https://hst-api.wialon.com");
                sess.loginToken(tk, "", (code) => {
                    if(!code) {
                        sess.loadLibrary("itemUnit");
                        sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024 | 4096, mode: 0}], () => {
                            let units = sess.getItems("avl_unit") || [];
                            unidadesWialon = unidadesWialon.concat(units); // Fusionar Flotas
                            sess.addListener("dataUpdated", renderizarBitacora); // Escuchar cambios en vivo
                            resolve(true);
                        });
                    } else resolve(false);
                });
            });
        });

        await Promise.all(promesas);
        actualizarSelectUnidades();
        renderizarBitacora();
    }

    // 4. RENDERIZADO MAESTRO
    function renderizarBitacora() {
        if(document.activeElement.tagName === "INPUT") return; 
        const tbody = document.getElementById('units-body');
        let html = "";

        unidadesWialon.forEach(u => {
            const id = u.getId();
            if (!viajesActivos[id]) return;
            const v = viajesActivos[id];
            const pos = u.getPosition();
            
            // C√°lculo Velocidad/Motor
            const speed = pos ? pos.s : 0;
            const motorOn = speed > 0 || (pos && pos.p && (pos.p.ign === 1 || pos.p.engine_ignition === 1));
            
            // √öltima Notificaci√≥n GPS
            let tGPS = pos && pos.t ? new Date(pos.t*1000) : null;
            let txtTGPS = tGPS ? tGPS.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : 'N/D';
            
            // Auditor√≠a (√öltima Respuesta de Monitor)
            let logsCount = v.bitacora ? Object.keys(v.bitacora).length : 0;
            let ultLog = "Sin registros";
            if(logsCount > 0) {
                let lastLogObj = Object.values(v.bitacora).pop();
                ultLog = `<div class="audit-log"><b class="text-primary">${lastLogObj.autor}:</b> ${lastLogObj.txt}<br><small class="text-muted"><i class="fa-regular fa-clock"></i> ${new Date(lastLogObj.fecha).toLocaleTimeString()}</small></div>`;
            }

            // Tiempos
            const tSal = v.t_salida ? `<div style="font-size:9px" class="text-success fw-bold">SAL: ${new Date(v.t_salida).toLocaleTimeString()}</div>` : `<button class="btn btn-sm btn-light p-0 text-primary" onclick="db.ref('viajes_activos/${id}/t_salida').set(Date.now()); auditoria('${id}','Marc√≥ Salida a Ruta');">Salida</button>`;
            
            // Color Estatus
            const bgSt = estatusData[v.estatus] ? estatusData[v.estatus].col : '#fff';
            const fgSt = ['#EAEAEA','#FFCCCC','#D0F0C0','#BCE3F9'].includes(bgSt) ? '#333' : '#fff';

            // HTML Fila
            html += `<tr style="background: rgba(255,255,255,0.8);">
                <td>
                    <div class="fw-bold text-primary fs-6">${u.getName()}</div>
                    <span class="badge ${motorOn?'bg-success':'bg-secondary'}"><i class="fa-solid fa-bolt"></i> Motor</span>
                </td>
                <td><img src="${(dataGrupos[v.grupo]||{}).imagen||''}" class="group-img d-block mx-auto mb-1"><span class="fw-bold" style="font-size:9px;">${(dataGrupos[v.grupo]||{}).nombre||'N/A'}</span></td>
                <td><input class="table-input" value="${v.operador||''}" placeholder="Operador" onblur="db.ref('viajes_activos/${id}/operador').set(this.value)"></td>
                <td>
                    <input class="table-input mb-1" value="${v.cliente||''}" placeholder="Cliente" onblur="db.ref('viajes_activos/${id}/cliente').set(this.value)">
                    <input class="table-input" value="${v.subcliente||''}" placeholder="Subcliente" onblur="db.ref('viajes_activos/${id}/subcliente').set(this.value)">
                </td>
                <td>
                    <div class="input-group input-group-sm mb-1"><span class="input-group-text p-1">O</span><input class="form-control p-1 fw-bold text-center" value="${v.origen||''}" onblur="db.ref('viajes_activos/${id}/origen').set(this.value)"></div>
                    <div class="input-group input-group-sm"><span class="input-group-text p-1">D</span><input class="form-control p-1 fw-bold text-center" value="${v.destino||''}" onblur="db.ref('viajes_activos/${id}/destino').set(this.value)"></div>
                </td>
                <td><textarea class="table-input" rows="2" placeholder="CMAU..." onblur="db.ref('viajes_activos/${id}/contenedores').set(this.value)">${v.contenedores||''}</textarea></td>
                <td>${tSal}</td>
                <td>
                    <select class="form-select status-select" style="background:${bgSt}; color:${fgSt};" onchange="db.ref('viajes_activos/${id}/estatus').set(this.value); auditoria('${id}','Cambi√≥ Estatus: '+this.options[this.selectedIndex].text)">
                        ${Object.keys(estatusData).map(k => `<option value="${k}" ${v.estatus===k?'selected':''} style="background:#fff;color:#000">${estatusData[k].nombre}</option>`).join('')}
                    </select>
                </td>
                <td>
                    <span class="badge ${speed>0?'bg-danger':'bg-dark'} fs-6 mb-1"><i class="fa-solid fa-gauge"></i> ${speed} km/h</span>
                    <div class="small fw-bold text-muted mb-1"><i class="fa-solid fa-satellite-dish"></i> GPS: ${txtTGPS}</div>
                    <div id="addr_${id}" style="font-size:9px; font-style:italic;" class="text-truncate">Consultando mapa...</div>
                </td>
                <td>
                    ${ultLog}
                    <button class="btn btn-sm btn-outline-primary p-0 px-2 fw-bold" onclick="abrirAuditoria('${id}', '${u.getName()}', '${txtTGPS}')"><i class="fa-solid fa-comment-dots"></i> Contestar</button>
                </td>
                <td><button onclick="finalizarViaje('${id}', '${u.getName()}')" class="btn btn-success btn-sm rounded-circle"><i class="fa-solid fa-check"></i></button></td>
            </tr>`;
            
            // Geocoding
            if (pos) { wialon.util.Gis.getLocations([{lon: pos.x, lat: pos.y}], function(c, addr) { let el = document.getElementById(`addr_${id}`); if(el&&addr) el.innerText = addr[0]; }); }
        });
        tbody.innerHTML = html;
        aplicarFiltroActual();
    }

    // 5. AUDITOR√çA (Monitores)
    function auditoria(idViaje, texto) {
        db.ref(`viajes_activos/${idViaje}/bitacora`).push({ autor: currentUser.nom, fecha: Date.now(), txt: texto });
    }

    function abrirAuditoria(id, unidadNom, tGps) {
        document.getElementById("tituloComentarios").innerText = `Registro Auditado: ${unidadNom}`;
        document.getElementById("comentario_unidad_id").value = id;
        document.getElementById("msgUltimaNotif").innerHTML = `<b>√öltimo reporte GPS:</b> ${tGps}<br><em>Es obligatorio validar esta posici√≥n.</em>`;
        
        const bit = viajesActivos[id].bitacora || {};
        let html = "";
        Object.values(bit).forEach(b => { 
            html += `<div class="audit-log"><strong class="text-primary">${b.autor}</strong> <span class="text-muted" style="font-size:9px;">[${new Date(b.fecha).toLocaleString()}]</span><br>${b.txt}</div>`; 
        });
        document.getElementById("listaComentarios").innerHTML = html;
        new bootstrap.Modal(document.getElementById('modalComentarios')).show();
    }

    function guardarComentario() {
        const id = document.getElementById("comentario_unidad_id").value;
        const txt = document.getElementById("nuevoComentario").value;
        if(!txt) return;
        auditoria(id, txt); // Guarda con el nombre del monitor
        document.getElementById("nuevoComentario").value = "";
        setTimeout(() => abrirAuditoria(id, document.getElementById("tituloComentarios").innerText.replace("Registro Auditado: ",""), ""), 300);
    }

    // 6. GESTI√ìN ADMIN
    function renderizarAdmin() {
        let ulT = document.getElementById("listaTokens"); ulT.innerHTML = "";
        (configSistema.tokens||[]).forEach((t, i) => { ulT.innerHTML += `<li class="list-group-item d-flex justify-content-between">Plataforma ${i+1}: ${t.substring(0,8)}... <button class="btn btn-sm btn-danger py-0" onclick="borrarToken(${i})">X</button></li>`; });
        
        let ulU = document.getElementById("listaUsuarios"); ulU.innerHTML = "";
        Object.keys(configSistema.usuarios).forEach(u => { ulU.innerHTML += `<li class="list-group-item d-flex justify-content-between"><b>${u}</b> (${configSistema.usuarios[u].rol}) <button class="btn btn-sm btn-danger py-0" onclick="db.ref('sistema/usuarios/${u}').remove()">X</button></li>`; });
    }
    
    function agregarToken() {
        let t = document.getElementById("nuevoToken").value.trim();
        if(!t) return;
        let tokens = configSistema.tokens || []; tokens.push(t);
        db.ref('sistema/tokens').set(tokens);
        document.getElementById("nuevoToken").value = "";
    }
    function borrarToken(idx) {
        let tokens = configSistema.tokens; tokens.splice(idx,1); db.ref('sistema/tokens').set(tokens);
    }
    function crearMonitor() {
        let u = document.getElementById("nu_user").value.trim(); let p = document.getElementById("nu_pass").value.trim();
        if(!u || !p) return;
        db.ref(`sistema/usuarios/${u}`).set({ pass: p, rol: "monitor", nom: u.toUpperCase() });
        document.getElementById("nu_user").value = ""; document.getElementById("nu_pass").value = "";
    }

    // 7. FUNCIONES B√ÅSICAS DE FLUJO
    function iniciarViaje() {
        const uId = document.getElementById("nv_unidad").value; if (!uId) return;
        db.ref('viajes_activos/' + uId).set({ grupo: document.getElementById("nv_grupo").value, origen: document.getElementById("nv_origen").value, destino: document.getElementById("nv_destino").value, estatus: "s1", bitacora: [{autor:"Sistema", fecha: Date.now(), txt: "Viaje Iniciado por " + currentUser.nom}] });
        bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide();
        actualizarSelectUnidades();
    }
    function finalizarViaje(id, nom) {
        if(!confirm(`¬øFinalizar ${nom}?`)) return;
        let v = viajesActivos[id]; v.unidad = nom; v.finTs = Date.now();
        db.ref('historial').push(v); db.ref('viajes_activos/'+id).remove();
        actualizarSelectUnidades();
    }
    function crearGrupo() { db.ref('grupos').push({ nombre: document.getElementById("mg_nombre").value, imagen: document.getElementById("mg_img").value || "https://cdn-icons-png.flaticon.com/512/3063/3063822.png" }); }
    function actualizarListasGrupos() {
        let sel = document.getElementById("nv_grupo"), list = document.getElementById("listaGrupos");
        sel.innerHTML = `<option value="">Sin Grupo</option>`; list.innerHTML = "";
        Object.keys(dataGrupos).forEach(k => {
            sel.innerHTML += `<option value="${k}">${dataGrupos[k].nombre}</option>`;
            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><img src="${dataGrupos[k].imagen}" class="group-img">${dataGrupos[k].nombre}</div><button onclick="db.ref('grupos/${k}').remove()" class="btn btn-sm btn-danger">X</button></li>`;
        });
    }
    function actualizarSelectUnidades() {
        const sel = document.getElementById("nv_unidad"); sel.innerHTML = `<option value="">Seleccione Unidad...</option>`;
        unidadesWialon.forEach(u => { if (!viajesActivos[u.getId()]) sel.innerHTML += `<option value="${u.getId()}">${u.getName()}</option>`; });
    }
    function filtrarTabla() { aplicarFiltroActual(); }
    function aplicarFiltroActual() { const txt = document.getElementById("buscador").value.toLowerCase(); document.querySelectorAll("#units-body tr").forEach(f => { let rText = f.innerText.toLowerCase(); f.querySelectorAll('input').forEach(i => rText += " " + i.value.toLowerCase()); f.style.display = rText.includes(txt) ? "" : "none"; }); }
    function exportarExcel() {
        let csv = "\uFEFFUNIDAD,OPERADOR,CLIENTE,ORIGEN,DESTINO,ESTATUS,SALIDA,UBICACION\n";
        document.querySelectorAll("#units-body tr").forEach(row => {
            if(row.style.display !== "none") {
                const c = row.cells;
                csv += `${c[0].innerText.replace('Motor','').trim()},${c[2].querySelector('input').value},${c[3].querySelector('input').value},${c[4].querySelectorAll('input')[0].value},${c[4].querySelectorAll('input')[1].value},${c[7].querySelector('select').options[c[7].querySelector('select').selectedIndex].text},${c[6].innerText.replace('Salida','').trim()},${c[8].innerText.replace(/,/g, "")}\n`;
            }
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a"); link.href = URL.createObjectURL(blob); link.download = "Bitacora_C4.csv"; link.click();
    }
</script>
</body>
</html>
