<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Diagnóstico MRL-501</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1e1e1e; color: #00ff00; font-family: monospace; padding: 20px; }
        .console-box { background: #000; border: 1px solid #00ff00; padding: 15px; border-radius: 5px; max-height: 400px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.85rem; color: #fff; }
        h4 { color: #00ff00; border-bottom: 1px solid #00ff00; padding-bottom: 5px; }
        .btn-scan { background: #00ff00; color: #000; font-weight: bold; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; margin-bottom: 20px; }
        .btn-scan:hover { background: #00cc00; }
    </style>
</head>
<body>

    <h2><i class="fa fa-bug"></i> MODO DIAGNÓSTICO: MRL-501</h2>
    <p>Este script bajará toda la información cruda de la unidad y del conductor para ver cómo están vinculados realmente.</p>
    
    <button class="btn-scan" onclick="escanear() ">INICIAR ESCANEO PROFUNDO</button>

    <div class="row">
        <div class="col-md-6">
            <h4>Datos crudos de Unidad: MRL-501</h4>
            <div id="output-unit" class="console-box">Esperando escaneo...</div>
        </div>
        <div class="col-md-6">
            <h4>Datos crudos de Conductor: Mario Alberto</h4>
            <div id="output-driver" class="console-box">Esperando escaneo...</div>
        </div>
    </div>

<script>
const TOKEN = "c75483c3bfdfac7b23852ca21dae8939311C012BD70E829C09FDF344A903689C2C6A6418";
const HOST = "https://hst-api.wialon.com";

// 4294967295 es el flag máximo de Wialon (0xFFFFFFFF) que trae TODA la info oculta
const FLAG_ALL = 4294967295; 

async function escanear() {
    document.getElementById("output-unit").innerText = "Consultando API...";
    document.getElementById("output-driver").innerText = "Consultando API...";

    try {
        const login = await api(HOST, "token/login", { token: TOKEN });
        const sid = login.eid;
        if (!sid) throw "Error de sesión. Verifica el token.";

        // 1. BUSCAR UNIDAD MRL-501 CON BANDERAS AL MÁXIMO
        const unitReq = await api(HOST, "core/search_items", {
            spec: { itemsType: "avl_unit", propName: "sys_name", propValueMask: "MRL-501", sortType: "sys_name" },
            force: 1, flags: FLAG_ALL, from: 0, to: 0
        }, sid);

        let unitData = "No se encontró la unidad MRL-501.";
        if (unitReq.items && unitReq.items.length > 0) {
            unitData = JSON.stringify(unitReq.items[0], null, 4);
        }
        document.getElementById("output-unit").innerText = unitData;

        // 2. BUSCAR A MARIO EN LOS RECURSOS
        const resReq = await api(HOST, "core/search_items", {
            spec: { itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
            force: 1, flags: FLAG_ALL, from: 0, to: 0
        }, sid);

        let driverData = "No se encontró a Mario Alberto González González.";
        if (resReq.items) {
            let found = false;
            resReq.items.forEach(res => {
                if (res.drvrs) {
                    Object.values(res.drvrs).forEach(d => {
                        // Buscamos a Mario por su nombre
                        if (d.n.toUpperCase().includes("MARIO ALBERTO GONZÁLEZ") || d.n.toUpperCase().includes("MARIO")) {
                            driverData = "ID Recurso: " + res.id + "\n\n" + JSON.stringify(d, null, 4);
                            found = true;
                        }
                    });
                }
            });
        }
        document.getElementById("output-driver").innerText = driverData;

    } catch (e) {
        document.getElementById("output-unit").innerText = "ERROR: " + e;
        document.getElementById("output-driver").innerText = "ERROR: " + e;
    }
}

function api(url, svc, params, sid = null) {
    return new Promise(resolve => {
        const cb = "cb_" + Math.random().toString(36).substring(7);
        window[cb] = d => { delete window[cb]; resolve(d); };
        const script = document.createElement("script");
        script.src = `${url}/wialon/ajax.html?svc=${svc}&params=${JSON.stringify(params)}&callback=${cb}${sid ? '&sid=' + sid : ''}`;
        document.head.appendChild(script);
    });
}
</script>
</body>
</html>
