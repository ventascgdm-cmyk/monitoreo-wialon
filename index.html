<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bit√°cora Log√≠stica Cloud - Sincronizada</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <script type="text/javascript" src="https://sdk.wialon.com/library/js/wialon.js"></script>

    <style>
        :root { --blue: #0045a5; --green: #28a745; }
        body { background: #f4f7f6; font-size: 0.75rem; color: #333; }
        .header { background: var(--blue); color: white; padding: 15px; border-bottom: 4px solid var(--green); }
        .table-input { border: 1px solid #ced4da; padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; }
        .table-input:focus { border-color: var(--blue); outline: none; background: #fff; }
        .address-text { font-size: 0.7rem; color: #666; font-style: italic; max-width: 180px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--blue); display:flex; align-items:center; justify-content:center; z-index:999; }
        .badge-mov { background-color: var(--green); }
        .badge-stop { background-color: #dc3545; }
        .card-login { width: 360px; border-radius: 20px; border: none; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card card-login p-4 text-center shadow-lg">
        <h4 class="fw-bold mb-3 text-primary">Log√≠stica Cloud</h4>
        <p class="small text-muted mb-4">Ingresa tu token de Wialon</p>
        <input type="password" id="tokenInput" class="form-control mb-3 text-center" placeholder="Wialon API Token">
        <button onclick="login()" class="btn btn-primary w-100 fw-bold py-2">Sincronizar Sistema</button>
        <div id="sdkStatus" class="mt-2 small text-muted">Verificando SDK...</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header shadow-sm mb-3">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold">PANEL DE CONTROL LOG√çSTICO REAL-TIME</h5>
            <button onclick="exportarExcel()" class="btn btn-sm btn-light fw-bold shadow-sm">üì• Descargar Reporte</button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="card shadow-sm border-0" style="border-radius: 12px;">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-dark">
                        <tr>
                            <th>Unidad</th>
                            <th>Cliente</th>
                            <th>Subcliente</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Estatus</th>
                            <th>Contenedores</th>
                            <th>Velocidad</th>
                            <th>Ubicaci√≥n Actual</th>
                            <th>Estado</th>
                        </tr>
                    </thead>
                    <tbody id="unitList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACI√ìN DE FIREBASE
    const firebaseConfig = {
        databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sess = null;

    // Verificar SDK al cargar la p√°gina
    window.onload = () => {
        setTimeout(() => {
            if (typeof wialon !== 'undefined') {
                sess = wialon.core.Session.getInstance();
                document.getElementById('sdkStatus').innerText = "SDK Listo ‚úÖ";
                document.getElementById('sdkStatus').classList.replace('text-muted', 'text-success');
            } else {
                document.getElementById('sdkStatus').innerText = "Error: SDK no carg√≥ ‚ùå";
                document.getElementById('sdkStatus').classList.replace('text-muted', 'text-danger');
            }
        }, 1000);
    };

    function login() {
        const token = document.getElementById('tokenInput').value;
        if(!token) return alert("Por favor ingresa tu token");
        
        if(!sess) return alert("El sistema de Wialon no ha respondido. Refresca la p√°gina.");

        sess.initSession("https://hst-api.wialon.com");
        sess.
