<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4 - OPERATIVO FINAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body.dark-mode { --bg-main: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --header-bg: #0d1b2a; --table-bg: #2c2c2c; --border-col: #444; }
        
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; transition: 0.3s; margin: 0; overflow-x: hidden;}
        .login-bg { background: linear-gradient(135deg, #002a61 0%, #001122 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: var(--bg-card); color: var(--text-main); width: 380px; border-radius: 12px; padding: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);}
        
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 70px); width: 100%; overflow: hidden; }
        .map-panel { height: 0%; width: 100%; transition: height 0.4s ease; border-bottom: 0 solid var(--header-bg); position: relative;}
        .workspace-container.show-map .map-panel { height: 45%; border-bottom: 4px solid var(--header-bg); }
        .table-panel { height: 100%; width: 100%; transition: height 0.4s ease; overflow-y: auto; padding: 15px; }
        .workspace-container.show-map .table-panel { height: 55%; }
        #map { width: 100%; height: 100%; z-index: 1;}
        
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.70rem; text-align: center; font-weight: 600; background: var(--table-bg); color: var(--text-main); text-transform: uppercase;}
        
        #mainTableHeader { position: sticky; top: 0; z-index: 10; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.60rem; font-weight: 700; text-align: center; vertical-align: middle; padding: 8px 4px; text-transform: uppercase; border-right: 1px solid rgba(255,255,255,0.2); resize: horizontal; overflow: hidden; position: relative; }
        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding: 6px 15px !important; text-transform: uppercase; }
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.75rem; font-weight: bold; text-align: left; padding: 4px 25px !important; }
        
        .col-unidad { width: 8%; }
        .col-operador { width: 9%; }
        .col-ruta { width: 11%; }
        .col-contenedores { width: 9%; }
        .col-horarios { width: 10%; }
        .col-estatus { width: 10%; }
        .col-gps { width: 28%; }
        .col-alertas { width: 4%; }
        .col-historial { width: 8%; }
        .col-accion { width: 3%; }

        .status-select { border-radius: 6px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.70rem; padding: 4px; background-color: transparent; outline: none; box-shadow: 0 1px 3px rgba(0,0,0,0.1); width: 100%; transition: all 0.2s;}
        
        .unit-name { cursor: pointer; text-decoration: underline; color: #2c3e50; font-weight: 900; font-size: 0.8rem; }
        .unit-lost { color: #dc3545; font-weight: bold; font-size: 0.8rem; }
        .lost-connection-row td { background-color: #ffe6e6 !important; }
        
        .speed-badge { font-size: 0.85rem; font-weight: bold; border-radius: 6px; width: 80px; text-align: center; color: white; display: inline-block; padding: 4px 0; margin-bottom: 3px;}
        .addr-link { font-size: 0.65rem; line-height: 1.2; color: #0d6efd; text-decoration: none; display: block; max-width: 100%; margin: 0 auto; font-weight: 600; text-align: center;}
        .addr-link:hover { text-decoration: underline; color: #0a58ca; }
        
        .cp { cursor: pointer; }
        .border-dashed { border-style: dashed !important; border-color: #aaa !important; }

        .leaflet-popup-content-wrapper { background: #2c3e50; color: #fff; border-radius: 6px; }
        .leaflet-popup-tip { background: #2c3e50; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="height: 65px; margin-bottom: 20px;">
        <h5 class="text-primary fw-bold mb-4">GRUDICOM TI & GPS</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a">
        <button onclick="autenticarUsuario()" class="btn btn-primary w-100 fw-bold py-2 shadow-sm"><i class="fa-solid fa-right-to-bracket"></i> INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Motor Multi-Host v10.0</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 40px;" class="me-3">
            <div>
                <h6 class="fw-bold m-0" style="color: var(--text-main);">C4 - BIT√ÅCORA GRUDICOM TI & GPS</h6>
                <small class="text-muted fw-bold" id="lblUsuarioActivo" style="font-size: 10px;">Monitor: </small>
            </div>
        </div>
        <div>
            <div class="dropdown d-inline-block me-2">
                <button class="btn btn-secondary btn-sm fw-bold dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="fa-solid fa-eye"></i> Columnas
                </button>
                <ul class="dropdown-menu shadow" style="font-size: 0.8rem;" id="colTogglerMenu">
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-operador', this.checked)"> Operador</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-ruta', this.checked)"> Ruta</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-contenedores', this.checked)"> Contenedores</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-horarios', this.checked)"> Horarios</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-alertas', this.checked)"> Alertas</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-historial', this.checked)"> Historial Log</label></li>
                </ul>
            </div>

            <button class="btn btn-warning btn-sm fw-bold me-2 text-dark" data-bs-toggle="modal" data-bs-target="#modalStatusTokens"><i class="fa-solid fa-satellite-dish"></i> Tokens</button>
            <button class="btn btn-info btn-sm fw-bold me-2 text-dark" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Ver Mapa</button>
            <button class="btn btn-dark btn-sm fw-bold me-2" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-outline-primary btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje" onclick="prepararNuevoViaje()"><i class="fa-solid fa-truck-fast"></i> Registrar Viaje</button>
            <button class="btn btn-danger btn-sm fw-bold me-2" id="btnAdmin" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i> ADMIN</button>
            <button class="btn btn-secondary btn-sm fw-bold" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i> Salir</button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map"></div></div>
        <div class="table-panel">
            <div class="row mb-2 align-items-center">
                <div class="col-md-4"><input type="text" id="buscador" class="form-control form-control-sm border-primary" placeholder="üîç Buscar unidad, destino, estatus..." onkeyup="filtrarTablaInteligente()"></div>
                <div class="col-md-8 text-end"><span id="syncIndicator" class="badge bg-secondary">Cargando flotas...</span></div>
            </div>
            <div class="card shadow-sm border-0 h-100 bg-transparent">
                <div class="table-responsive h-100">
                    <table class="table table-bordered table-sm align-middle text-center mb-0 bg-white" id="mainTable">
                        <thead id="mainTableHeader">
                            <tr class="header-columnas">
                                <th class="col-unidad">UNIDAD</th>
                                <th class="col-operador">OPERADOR</th>
                                <th class="col-ruta">RUTA (O ‚ûî D)</th>
                                <th class="col-contenedores">CONTENEDORES</th>
                                <th class="col-horarios">HORARIOS</th>
                                <th class="col-estatus">ESTATUS <i class="fa-solid fa-sort"></i></th>
                                <th class="col-gps">GPS & UBICACI√ìN</th>
                                <th class="col-alertas">ALERTAS</th>
                                <th class="col-historial">HISTORIAL LOG</th>
                                <th class="col-accion"><i class="fa-solid fa-gear"></i></th>
                            </tr>
                        </thead>
                        <tbody id="units-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalStatusTokens" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h6 class="modal-title fw-bold"><i class="fa-solid fa-satellite-dish"></i> ESTATUS GPS</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><ul class="list-group list-group-flush" id="listaStatusTokens"><li class="list-group-item text-muted text-center p-4">Cargando...</li></ul></div></div></div></div>
<div class="modal fade" id="modalAdmin" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-danger text-white"><h6 class="modal-title fw-bold">ADMINISTRACI√ìN MAESTRA</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-3 border-end"><h6>Tokens GPS</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="tk_nom" class="form-control form-control-sm mb-1" placeholder="Ej. RACEL"><input type="text" id="tk_url" class="form-control form-control-sm mb-1" value="https://hst-api.wialon.com"><input type="text" id="tk_val" class="form-control form-control-sm mb-1" placeholder="Token Largo"><button class="btn btn-success btn-sm w-100" onclick="agregarToken()">Guardar</button></div><ul class="list-group list-group-sm mt-2" id="listaTokensActivos"></ul></div><div class="col-md-3 border-end"><h6>Clientes</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="cli_nombre" class="form-control form-control-sm mb-1" placeholder="Empresa"><button onclick="crearCliente()" class="btn btn-success btn-sm w-100">A√±adir</button></div><ul class="list-group list-group-sm" id="listaClientesAdmin"></ul></div><div class="col-md-3 border-end"><h6>Subclientes</h6><div class="p-2 bg-light border rounded mb-2"><select id="sub_clientePadre" class="form-select form-select-sm mb-1"></select><input type="text" id="sub_nombre" class="form-control form-control-sm mb-1" placeholder="Sub-empresa"><button onclick="crearSubcliente()" class="btn btn-success btn-sm w-100">A√±adir</button></div><ul class="list-group list-group-sm" id="listaSubclientesAdmin"></ul></div><div class="col-md-3"><h6>Monitoristas</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="usr_id" class="form-control form-control-sm mb-1" placeholder="Usuario (login)"><input type="text" id="usr_nom" class="form-control form-control-sm mb-1" placeholder="Nombre completo"><input type="text" id="usr_pass" class="form-control form-control-sm mb-1" placeholder="Contrase√±a"><button onclick="crearUsuario()" class="btn btn-success btn-sm w-100">Crear</button></div><ul class="list-group list-group-sm" id="listaUsuariosAdmin"></ul></div></div></div></div></div></div>
<div class="modal fade" id="modalNuevoViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold">REGISTRAR UNIDAD</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><label>Unidad GPS:</label><input type="text" class="form-control form-control-sm mb-2 border-primary fw-bold" list="listaUnidadesTotales" id="nv_unidad_input" autocomplete="off" placeholder="Selecciona o escribe el nombre exacto..."><label>Operador:</label><input type="text" id="nv_operador" class="form-control form-control-sm mb-2" list="listaConductores" autocomplete="off"><div class="row mb-2"><div class="col-6"><label>Cliente:</label><select id="nv_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('nv_subcliente', this.value)"></select></div><div class="col-6"><label>Subcliente:</label><select id="nv_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div></div><div class="row"><div class="col-6"><label>Origen:</label><input type="text" id="nv_origen" class="form-control form-control-sm mb-2" list="listaGeocercas"></div><div class="col-6"><label>Destino:</label><input type="text" id="nv_destino" class="form-control form-control-sm mb-2" list="listaGeocercas"></div></div><button onclick="registrarViaje()" class="btn btn-primary btn-sm w-100 fw-bold mt-2">REGISTRAR EN BIT√ÅCORA</button></div></div></div></div>
<div class="modal fade" id="modalEditarViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h6>EDITAR VIAJE: <span id="edU_name"></span></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><input type="hidden" id="edU_id"><div class="row mb-2"><div class="col-6"><label>Cliente:</label><select id="ed_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('ed_subcliente', this.value)"></select></div><div class="col-6"><label>Subcliente:</label><select id="ed_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div></div><div class="row mb-2"><div class="col-6"><label>Origen:</label><input type="text" id="ed_origen" class="form-control form-control-sm" list="listaGeocercas"></div><div class="col-6"><label>Destino:</label><input type="text" id="ed_destino" class="form-control form-control-sm" list="listaGeocercas"></div></div><label>Operador:</label><input type="text" id="ed_operador" class="form-control form-control-sm mb-3" list="listaConductores"><button onclick="guardarEdicionViaje()" class="btn btn-success btn-sm w-100 fw-bold">ACTUALIZAR DATOS</button></div></div></div></div>
<div class="modal fade" id="modalLog" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-list-ul"></i> HISTORIAL: <span id="log_uName"></span></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-2"><div id="log_container" class="mb-3 border rounded p-2 bg-light" style="height:250px; overflow-y:auto; font-size:0.75rem;"></div><input type="hidden" id="log_uid"><div class="input-group"><input type="text" id="log_txt" class="form-control form-control-sm text-uppercase border-primary" placeholder="Escribe un evento o nota manual..."><button class="btn btn-primary btn-sm fw-bold" onclick="guardarLogManual()"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div></div>

<datalist id="listaGeocercas"></datalist><datalist id="listaConductores"></datalist><datalist id="listaUnidadesTotales"></datalist>

<script type="text/javascript">
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null, configSistema = { tokens: [] }, dataClientes = {}, viajesActivos = {};
    let unidadesGlobales = {}, ramDrivers = {}, geocercasNativas = [], activeSIDs = {}, pollingInterval = null;
    let lmap = null, mapVisible = false, mapLayerGroup = null;
    let estadoTokens = {}; 
    let datosAgrupadosGlobal = {}; 

    // SISTEMA GEOCODING NOMINATIM CON AUTO-ARRIBO Y CACH√â
    let geocodeCache = JSON.parse(localStorage.getItem('tms_geoCache')) || {}; 
    let geoQueue = [];
    let isGeocoding = false;

    let hiddenCols = JSON.parse(localStorage.getItem('tms_hiddenCols')) || {
        'col-operador': false, 'col-ruta': false, 'col-contenedores': false, 'col-horarios': false, 'col-alertas': false, 'col-historial': false
    };

    window.estatusData = { 
        "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s3":{nombre:"1.2 RETEN",col:"#7D3F00"}, "s4":{nombre:"1.3 Resguardo",col:"#5C338A"}, "s5":{nombre:"1.4 REGRESANDO",col:"#D97706"}, "s6":{nombre:"2. Incidencia",col:"#DC2626"}, "s7":{nombre:"3. Cargando",col:"#5c6c7c"}, "s8":{nombre:"4. Descargando",col:"#336699"}, "s9":{nombre:"5. Patio GDL",col:"#17a2b8"}, "s10":{nombre:"6. Patio Reynosa",col:"#20c997"}, "s11":{nombre:"7. Taller",col:"#9CA3AF"}, "s12":{nombre:"8. Finalizado",col:"#0055A5"}, "s13":{nombre:"9. Baja cobertura",col:"#FBBF24"}, "s14":{nombre:"ALIMENTOS",col:"#F59E0B"} 
    };

    function formatTimeFriendly(unixSecs) { 
        if(!unixSecs) return "--:--"; 
        let d = new Date(unixSecs * 1000); 
        let now = new Date();
        if(d.toDateString() === now.toDateString()) return d.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        return d.toLocaleDateString('es-MX', {day:'2-digit', month:'2-digit'}) + " " + d.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'}); 
    }
    
    function getLocalISO(unixMillis) {
        if(!unixMillis) return "";
        let tzoffset = (new Date()).getTimezoneOffset() * 60000;
        return (new Date(unixMillis - tzoffset)).toISOString().slice(0, 16);
    }

    function timeAgo(unixSecs) {
        if(!unixSecs) return "Desconocido";
        let diff = Math.floor(Date.now()/1000) - unixSecs;
        if(diff < 60) return `hace ${diff} seg`;
        if(diff < 3600) return `hace ${Math.floor(diff/60)} min`;
        return `hace ${Math.floor(diff/3600)} horas`;
    }

    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('tms_dark_mode', document.body.classList.contains('dark-mode')); }
    
    function inicializarMenuColumnas() {
        let inputs = document.querySelectorAll('#colTogglerMenu input');
        inputs.forEach(inp => {
            let colClass = inp.getAttribute('onchange').match(/'([^']+)'/)[1];
            inp.checked = !hiddenCols[colClass];
            toggleCol(colClass, inp.checked, false);
        });
    }

    function toggleCol(colClass, isVisible, save = true) {
        if(save) {
            hiddenCols[colClass] = !isVisible;
            localStorage.setItem('tms_hiddenCols', JSON.stringify(hiddenCols));
        }
        let elements = document.querySelectorAll('.' + colClass);
        elements.forEach(el => {
            if(isVisible) el.classList.remove('d-none');
            else el.classList.add('d-none');
        });
    }

    function initMap() { 
        lmap = L.map('map').setView([23.6, -102.5], 5); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(lmap); 
        mapLayerGroup = L.layerGroup().addTo(lmap);
    }
    function toggleMap() { document.getElementById("mainWorkspace").classList.toggle("show-map"); if(!lmap) initMap(); mapVisible = !mapVisible; setTimeout(() => { if(lmap) { lmap.invalidateSize(); actualizarMarcadoresMapa(); } }, 400); }
    function centrarUnidadMapa(lat, lng) { if(!mapVisible) toggleMap(); setTimeout(() => lmap.flyTo([lat, lng], 16), 400); }

    // PLANILLAS WHATSAPP EXACTAS (USANDO CONCATENACI√ìN +)
    function shareWA(u, loc, o, d, est, cont, cli, sub, vel, posY, posX) { 
        let estNombre = window.estatusData[est]?.nombre || "En Trayecto"; 
        let subText = sub !== 'N/A' ? ` -> ${sub}` : '';
        let mapLink = posY && posX ? `\nüìç *Ubicaci√≥n:* https://maps.google.com/?q=lat,lon{posY},${posX}` : `\nüìç *Ubicaci√≥n:* ${loc}`;
        
        let text = `*GRUDICOM TI & GPS - REPORTE DE UNIDAD*\n\n` +
                   `üè¢ *Cliente:* ${cli}${subText}\n\n` +
                   `üöõ *Unidad:* ${u}\n` +
                   `üì¶ *Contenedores:* ${cont||'N/A'}` + 
                   mapLink + `\n` +
                   `‚è±Ô∏è *Vel:* ${vel} km/h\n` +
                   `üö¶ *Estatus:* ${estNombre}\n` +
                   `üèÅ *Ruta:* ${o||'N/A'} ‚ûî ${d||'N/A'}\n\n` +
                   `_Reporte generado por sistema C4_`;
                   
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank'); 
    }

    function generarReporteGrupal(cId, sId, titulo) {
        if(!datosAgrupadosGlobal[cId] || !datosAgrupadosGlobal[cId][sId]) return;
        let arrViajes = datosAgrupadosGlobal[cId][sId];
        
        let txt = `*GRUDICOM TI & GPS - REPORTE DE FLOTA*\n` +
                  `üè¢ *${titulo}*\n\n`;
                  
        arrViajes.forEach(({v, u}) => {
            let name = v.unidadN || "Desconocida";
            let est = window.estatusData[v.estatus]?.nombre || "En Trayecto";
            let pos = u ? u.pos : null;
            let vel = pos ? pos.s : 0;
            let mapLink = pos ? `https://maps.google.com/?q=lat,lon{pos.y},${pos.x}` : (v.ubicacion_manual || "Manual");
            
            txt += `üöõ *Unidad:* ${name}\n` +
                   `üì¶ *Contenedores:* ${v.contenedores||'N/A'}\n` +
                   `üìç *Ubicaci√≥n:* ${mapLink}\n` +
                   `‚è±Ô∏è *Vel:* ${vel} km/h\n` +
                   `üö¶ *Estatus:* ${est}\n` +
                   `üèÅ *Ruta:* ${v.origen||'N/A'} ‚ûî ${v.destino||'N/A'}\n\n`;
        });
        txt += `_Reporte generado por sistema C4_`;
        
        window.open(`https://wa.me/?text=${encodeURIComponent(txt)}`, '_blank');
    }

    function registrarLog(viajeId, accion, detalle = "") { let usrName = currentUser ? currentUser.nom : "Sistema"; db.ref(`viajes_activos/${viajeId}/log`).push({ t: Date.now(), usr: usrName, act: accion, det: detalle }); }

    window.onload = function () {
        if(localStorage.getItem('tms_dark_mode') === 'true') document.body.classList.add('dark-mode');
        inicializarMenuColumnas();
        
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; actualizarListasAdmin(); renderizarBitacora(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; renderizarBitacora(); if(mapVisible) actualizarMarcadoresMapa(); });
        db.ref('sistema/tokens').on('value', s => { let tks = s.val() || {}; configSistema.tokens = Object.values(tks); actualizarListaTokensAdmin(tks); if(currentUser) arranqueMotor(); });
        document.getElementById("logPass").addEventListener("keyup", e => e.key === "Enter" && autenticarUsuario());
        document.getElementById("nv_unidad_input").addEventListener("input", function() { let uN = this.value.toUpperCase(); document.getElementById("nv_operador").value = ramDrivers[uN] || ""; });
        let sU = localStorage.getItem("tms_user"), sP = localStorage.getItem("tms_pass"); if(sU && sP) autenticarUsuario(sU, sP);
        
        // MOTOR NOMINATIM SEGURO (1 petici√≥n cada 1.1 seg para evitar bloqueos de IP)
        setInterval(procesarFilaDirecciones, 1100); 
    };

    function autenticarUsuario(aU, aP) {
        const u = aU || document.getElementById("logUser").value.trim(), p = aP || document.getElementById("logPass").value.trim();
        if(!u || !p) return;
        db.ref('sistema/usuarios/admin').set({ pass: "admin123", rol: "admin", nom: "Administrador Maestro" });
        db.ref('sistema/usuarios').once('value', s => {
            let sys = s.val() || {};
            if(sys[u] && sys[u].pass === p) {
                currentUser = sys[u]; localStorage.setItem("tms_user", u); localStorage.setItem("tms_pass", p);
                document.getElementById("loginOverlay").style.display = "none"; document.getElementById("dashboard").style.display = "block";
                document.getElementById("lblUsuarioActivo").innerText = "Monitor: " + currentUser.nom;
                if(currentUser.rol === "admin") document.getElementById("btnAdmin").style.display = "inline-block";
                arranqueMotor();
            } else { document.getElementById("status").innerText = "Credenciales Incorrectas"; document.getElementById("status").classList.replace("text-secondary", "text-danger"); }
        });
    }

    function peticionWialon(url, svc, params, sid=null) {
        return new Promise(resolve => {
            let script = document.createElement("script"); let cb = "wialon_cb_" + Date.now() + Math.floor(Math.random()*1000);
            let timeout = setTimeout(() => { delete window[cb]; script.remove(); resolve(null); }, 8000);
            window[cb] = d => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(d); };
            script.onerror = () => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(null); };
            let baseUrl = url.replace(/\/$/, ''); script.src = `${baseUrl}/wialon/ajax.html?svc=${svc}&params=${encodeURIComponent(JSON.stringify(params))}&callback=${cb}${sid?'&sid='+sid:''}`; document.head.appendChild(script);
        });
    }

    async function arranqueMotor() { if(pollingInterval) clearInterval(pollingInterval); await sincronizarFlotas(); pollingInterval = setInterval(sincronizarFlotas, 20000); }
    
    function renderStatusTokens() {
        const lista = document.getElementById("listaStatusTokens"); let html = "";
        for(let tk in estadoTokens) { let stat = estadoTokens[tk]; let badge = stat.status === 'OK' ? '<span class="badge bg-success">ONLINE</span>' : '<span class="badge bg-danger">OFFLINE</span>'; html += `<li class="list-group-item d-flex justify-content-between align-items-center p-3"><div class="fw-bold">${tk}</div> <div><span class="badge bg-secondary me-2">${stat.count} Unidades</span> ${badge}</div></li>`; }
        lista.innerHTML = html || '<li class="list-group-item text-center">No hay tokens</li>';
    }

    async function sincronizarFlotas() {
        let ind = document.getElementById("syncIndicator"); ind.innerText = "Sincronizando flotas..."; ind.className = "badge bg-warning text-dark";
        estadoTokens = {}; let tempUnits = {}, tempGeo = [], listDrv = new Set(), listUni = new Set(); let conexionesExitosas = 0;

        let promesas = configSistema.tokens.map(async (tk) => {
            if(!tk.url || !tk.token) return;
            if(!activeSIDs[tk.token]) { 
                let l = await peticionWialon(tk.url, "token/login", {token: tk.token}); 
                if(l && l.eid) activeSIDs[tk.token] = { sid: l.eid, uid: (l.user ? l.user.id : 0) }; 
            }
            let auth = activeSIDs[tk.token]; 
            if(!auth || !auth.sid) { estadoTokens[tk.nombre] = { status: 'ERR', count: 0 }; return; }

            let reqU = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 1025, from: 0, to: 0 }, auth.sid);
            if(reqU && reqU.items) {
                conexionesExitosas++; estadoTokens[tk.nombre] = { status: 'OK', count: reqU.items.length };
                let localMap = {}; 
                
                reqU.items.forEach(u => { 
                    let n = u.nm.toUpperCase(); 
                    tempUnits[u.id] = { id: u.id, name: n, pos: u.pos }; 
                    localMap[u.id] = n; 
                    listUni.add(n); 
                });
                
                let reqR = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 4353, from: 0, to: 0 }, auth.sid);
                if(reqR && reqR.items) reqR.items.forEach(r => { if(r.drv) Object.values(r.drv).forEach(d => { let dn = d.n.toUpperCase(); listDrv.add(dn); if(d.bu && localMap[d.bu]) ramDrivers[localMap[d.bu]] = dn; }); if(r.zl) Object.values(r.zl).forEach(z => tempGeo.push(z)); });
            } else { estadoTokens[tk.nombre] = { status: 'ERR', count: 0 }; }
        });

        await Promise.all(promesas); 
        unidadesGlobales = tempUnits; geocercasNativas = tempGeo;
        document.getElementById("listaUnidadesTotales").innerHTML = Array.from(listUni).map(n => `<option value="${n}">`).join('');
        document.getElementById("listaConductores").innerHTML = Array.from(listDrv).map(n => `<option value="${n}">`).join('');
        document.getElementById("listaGeocercas").innerHTML = tempGeo.map(z => `<option value="${z.n.toUpperCase()}">`).join('');
        
        if(conexionesExitosas > 0) { ind.className = "badge bg-success"; ind.innerText = Object.keys(unidadesGlobales).length + " Camiones En Vivo"; } 
        else { ind.className = "badge bg-danger"; ind.innerText = "Error GPS - Modo Manual"; }
        renderStatusTokens(); renderizarBitacora(); desencadenarGeocoding(); if(mapVisible) actualizarMarcadoresMapa();
    }

    // GEOCODIFICACI√ìN CON NOMINATIM (USANDO FILA DE ESPERA PARA EVITAR BANEO Y APLICAR AUTO-ARRIBO)
    function desencadenarGeocoding() {
        Object.keys(viajesActivos).forEach(vId => {
            let v = viajesActivos[vId];
            let uIdGps = null; Object.keys(unidadesGlobales).forEach(k => { if(unidadesGlobales[k].name === v.unidadN) uIdGps = k; });
            let u = unidadesGlobales[uIdGps]; 
            
            if(u && u.pos) {
                let geoKey = `${u.pos.y.toFixed(4)}_${u.pos.x.toFixed(4)}`;
                if(!geocodeCache[geoKey] && !geoQueue.find(i => i.key === geoKey)) {
                    // Agregamos a la fila con los datos necesarios para el Auto-Arribo
                    geoQueue.push({ key: geoKey, y: u.pos.y, x: u.pos.x, vId: vId, dest: v.destino });
                } else if(geocodeCache[geoKey]) {
                    // Si ya est√° en memoria cach√©, pintamos en el ID exacto y verificamos arribo
                    let el = document.getElementById("addr_" + vId);
                    if(el) el.innerHTML = `<i class="fa-solid fa-map-location-dot"></i> ${geocodeCache[geoKey]}`;
                    
                    let a = geocodeCache[geoKey];
                    if(v.destino && !v.t_arribo && a.toUpperCase().includes(v.destino.toUpperCase())) {
                        db.ref('viajes_activos/'+vId+'/t_arribo').set(Date.now());
                        registrarLog(vId, 'Arribo Autom√°tico (Por Cach√© GPS)');
                    }
                }
            }
        });
    }

    function procesarFilaDirecciones() {
        if(isGeocoding || geoQueue.length === 0) return;
        isGeocoding = true;
        let item = geoQueue.shift();
        
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${item.y}&lon=${item.x}&zoom=16`)
            .then(r => r.json())
            .then(d => {
                let fullAddr = d.display_name || "Sin direcci√≥n";
                
                // Cortamos un poco para que no sea inmensa en la tabla, pero conservamos la precisi√≥n
                let shortAddr = fullAddr.split(",").slice(0, 3).join(",");
                geocodeCache[item.key] = shortAddr;
                localStorage.setItem('tms_geoCache', JSON.stringify(geocodeCache));
                
                // Actualizamos todas las celdas de tabla que tengan esta coordenada (usando clases)
                let els = document.querySelectorAll(`.addr-span-${item.key}`);
                els.forEach(el => el.innerHTML = `<i class="fa-solid fa-map-location-dot"></i> ${shortAddr}`);

                // Tambi√©n actualizamos el ID exacto que solicitaste
                let elId = document.getElementById("addr_" + item.vId);
                if(elId) elId.innerHTML = `<i class="fa-solid fa-map-location-dot"></i> ${shortAddr}`;

                // AUTO-ARRIBO M√ÅGICO
                if(item.dest && fullAddr.toUpperCase().includes(item.dest.toUpperCase())) {
                    let v = viajesActivos[item.vId];
                    if(v && !v.t_arribo) {
                        db.ref('viajes_activos/'+item.vId+'/t_arribo').set(Date.now());
                        registrarLog(item.vId, 'Arribo Autom√°tico (GPS)');
                    }
                }
            })
            .catch(e => console.log("Geocode Err"))
            .finally(() => { isGeocoding = false; });
    }

    function actualizarMarcadoresMapa() {
        if(!lmap || !mapLayerGroup) return;
        mapLayerGroup.clearLayers();
        Object.keys(viajesActivos).forEach(vId => {
            let v = viajesActivos[vId];
            let uIdGps = null; Object.keys(unidadesGlobales).forEach(k => { if(unidadesGlobales[k].name === v.unidadN) uIdGps = k; });
            let u = unidadesGlobales[uIdGps];
            if(u && u.pos) {
                let isMoving = u.pos.s > 0;
                let colorIcon = isMoving ? '#28a745' : '#0d6efd';
                let course = u.pos.c || 0;
                let markerHtml = isMoving 
                    ? `<div style="transform: rotate(${course}deg); color: ${colorIcon}; font-size: 22px; text-shadow: 0 0 3px #fff;"><i class="fa-solid fa-location-arrow"></i></div>` 
                    : `<div style="color: ${colorIcon}; font-size: 22px; text-shadow: 0 0 3px #fff;"><i class="fa-solid fa-location-dot"></i></div>`;
                let customIcon = L.divIcon({ html: markerHtml, className: '', iconSize: [22, 22], iconAnchor: [11, 11] });
                let popupContent = `<div style="text-align:center; min-width: 130px;"><b style="font-size:15px; color:#f39c12;">${u.name}</b><br><b style="font-size:12px;">${u.pos.s} km/h</b><br><span style="color:#bdc3c7; font-size:10px;">${timeAgo(u.pos.t)}</span></div>`;
                L.marker([u.pos.y, u.pos.x], {icon: customIcon}).bindPopup(popupContent, {className: 'custom-popup'}).addTo(mapLayerGroup);
            }
        });
    }

    function construirBotonHorario(vId, timestampStr, dbField, textoVacio, claseColor) {
        if(!timestampStr) {
            return `<button class="btn btn-outline-secondary w-100 py-0 mb-1 fw-bold text-dark border-dashed" style="font-size:0.60rem; border-style:dashed;" onclick="registrarLog('${vId}', 'Marc√≥ ${textoVacio}'); db.ref('viajes_activos/${vId}/${dbField}').set(Date.now());">${textoVacio}</button>`;
        } else {
            let inicial = textoVacio.charAt(0);
            return `<div class="input-group input-group-sm mb-1 shadow-sm">
                        <span class="input-group-text bg-${claseColor} text-white fw-bold px-2 py-0" style="font-size:0.6rem; border:none;" title="${textoVacio}">${inicial}</span>
                        <input type="datetime-local" class="form-control px-1 py-0 text-center fw-bold text-${claseColor}" style="font-size:0.6rem; height:20px; border-color:var(--border-col);" value="${getLocalISO(timestampStr)}" onchange="let d=new Date(this.value).getTime(); if(d){ db.ref('viajes_activos/${vId}/${dbField}').set(d); registrarLog('${vId}', 'Modific√≥ horario de ${textoVacio}'); }">
                    </div>`;
        }
    }

    function renderizarBitacora() {
        if(document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT" || document.activeElement.tagName === "TEXTAREA") return;
        const tbody = document.getElementById('units-body'); let html = "";
        let tree = { "Sin_Cliente": { "N/A": [] } };
        
        Object.keys(dataClientes).forEach(cId => { tree[cId] = { "N/A": [] }; if(dataClientes[cId].subclientes) Object.keys(dataClientes[cId].subclientes).forEach(sId => tree[cId][sId] = []); });
        Object.keys(viajesActivos).forEach(vId => { let v = viajesActivos[vId], u = unidadesGlobales[vId] || null; let cId = v.cliente || "Sin_Cliente", sId = v.subcliente || "N/A"; if(!tree[cId]) tree[cId] = { "N/A": [] }; if(!tree[cId][sId]) tree[cId][sId] = []; tree[cId][sId].push({vId, u, v}); });
        
        datosAgrupadosGlobal = tree; 

        for(let cId in tree) {
            let cliData = dataClientes[cId] || {nombre: "SIN CLIENTE ASIGNADO"};
            let cliHtml = "";
            let btnWaCli = cId !== "Sin_Cliente" ? `<button class="btn btn-success btn-sm py-0 px-2 float-end shadow-sm border-light" onclick="generarReporteGrupal('${cId}', 'N/A', '${cliData.nombre}')"><i class="fa-brands fa-whatsapp"></i> Reporte WhatsApp</button>` : '';

            for(let sId in tree[cId]) {
                if(tree[cId][sId].length === 0) continue;
                let nomSub = sId !== "N/A" ? dataClientes[cId].subclientes[sId].nombre : "";
                let btnWaSub = sId !== "N/A" ? `<button class="btn btn-success btn-sm py-0 px-2 float-end shadow-sm border-light" onclick="generarReporteGrupal('${cId}', '${sId}', '${cliData.nombre} -> ${nomSub}')"><i class="fa-brands fa-whatsapp"></i> Reporte WhatsApp</button>` : '';
                
                if(sId !== "N/A" && dataClientes[cId].subclientes) cliHtml += `<tr class="header-subcliente shadow-sm"><td colspan="10">‚Ü≥ Subcliente: ${nomSub} ${btnWaSub}</td></tr>`;
                
                // ORDENAR POR ESTATUS
                tree[cId][sId].sort((a, b) => { let estA = a.v.estatus || ""; let estB = b.v.estatus || ""; return estA.localeCompare(estB); });

                tree[cId][sId].forEach(({vId, u, v}) => {
                    let nombreCamion = v.unidadN || v.unidadFallback || "Desconocida";
                    let uIdGps = null; Object.keys(unidadesGlobales).forEach(k => { if(unidadesGlobales[k].name === nombreCamion) uIdGps = k; });
                    let uData = unidadesGlobales[uIdGps];
                    let pos = uData ? uData.pos : null; let speed = pos ? pos.s : 0; let isLost = !pos; 
                    let geoKey = pos ? `${pos.y.toFixed(4)}_${pos.x.toFixed(4)}` : 'none';
                    
                    let uText = isLost ? `<span class="unit-name text-danger" title="Sin se√±al GPS">${nombreCamion}</span>` : `<span class="unit-name" onclick="centrarUnidadMapa(${pos.y}, ${pos.x})">${nombreCamion}</span>`;
                    let speedBg = "#343a40"; if(speed > 0 && speed < 100) speedBg = "#198754"; if(speed >= 100) speedBg = "#dc3545"; 
                    
                    let drvName = v.operador || (uData ? ramDrivers[uData.name] : "") || "";
                    let addr = uData ? (geocodeCache[geoKey] || "<i class='fa-solid fa-spinner fa-spin text-muted'></i> Buscando...") : "---";
                    let mapsLink = pos ? `https://maps.google.com/?q=lat,lon{pos.y},${pos.x}` : '#';
                    let posTextY = pos ? pos.y : null; let posTextX = pos ? pos.x : null;

                    let colEstatus = window.estatusData[v.estatus]?.col || '#000'; 

                    let btnSalida = construirBotonHorario(vId, v.t_salida, 't_salida', 'SALIDA', 'success');
                    let btnArribo = construirBotonHorario(vId, v.t_arribo, 't_arribo', 'ARRIBO', 'primary'); 
                    let btnFin = construirBotonHorario(vId, v.t_fin, 't_fin', 'FINALIZADO', 'dark');
                    
                    let logsObj = v.log || {}; let logsArr = Object.values(logsObj).sort((a,b)=>b.t - a.t);
                    let lastLog = logsArr.length > 0 ? `<div class="text-start mb-1 text-wrap" style="font-size:0.60rem; line-height:1.1; color:#444; max-width: 100%;"><b class="text-primary">${logsArr[0].usr}:</b> ${logsArr[0].act} <span class="text-muted">${logsArr[0].det||''}</span></div>` : `<div style="font-size:0.6rem; color:#888;">Sin eventos</div>`;

                    // Aqu√≠ insertamos el ID exacto que solicitaste en el c√≥digo
                    let ubiControl = isLost ? `<input class="form-control form-control-sm text-center text-uppercase p-0 mt-1 shadow-sm border-danger" style="font-size:0.60rem; height:20px;" value="${v.ubicacion_manual||''}" placeholder="Escribir ubicaci√≥n..." onblur="if(this.value !== '${v.ubicacion_manual||''}'){ registrarLog('${vId}', 'Ubicaci√≥n manual', this.value); db.ref('viajes_activos/${vId}/ubicacion_manual').set(this.value.toUpperCase()); }">` : `<a href="${mapsLink}" target="_blank" class="addr-link addr-span-${geoKey}" id="addr_${vId}" title="Abrir en Maps"><i class="fa-solid fa-map-location-dot"></i> ${addr}</a>`;

                    let searchData = `${nombreCamion} ${drvName} ${v.origen} ${v.destino} ${v.contenedores} ${cliData.nombre} ${nomSub} ${window.estatusData[v.estatus]?.nombre}`.toLowerCase();

                    let optionsHtml = Object.keys(window.estatusData).map(k=>{ return `<option value="${k}" style="color:${window.estatusData[k].col}; font-weight:bold;" ${v.estatus===k?'selected':''}>${window.estatusData[k].nombre}</option>`; }).join('');

                    cliHtml += `<tr class="data-row ${isLost?'lost-connection-row':''}" data-search="${searchData}">
                        <td class="col-unidad" style="vertical-align: middle;">${uText}</td>
                        <td class="col-operador ${hiddenCols['col-operador'] ? 'd-none' : ''}" style="vertical-align: middle;">
                            <div class="d-flex flex-column gap-1">
                                <input class="table-input border-0 border-bottom rounded-0 p-1 bg-transparent" value="${drvName}" placeholder="NOMBRE" onblur="if(this.value.toUpperCase() !== '${drvName.toUpperCase()}'){ registrarLog('${vId}', 'Cambi√≥ Operador', this.value); db.ref('viajes_activos/${vId}/operador').set(this.value.toUpperCase()); }">
                                <input class="table-input border-0 border-bottom rounded-0 p-1 bg-transparent text-primary" value="${v.telefono||''}" placeholder="TEL√âFONO" onblur="db.ref('viajes_activos/${vId}/telefono').set(this.value.toUpperCase())">
                            </div>
                        </td>
                        <td class="col-ruta ${hiddenCols['col-ruta'] ? 'd-none' : ''}" style="vertical-align: middle;">
                            <div class="position-relative ps-2">
                                <div style="position:absolute; left: 4px; top: 12px; bottom: 12px; width: 2px; background: var(--border-col);"></div>
                                <div class="d-flex align-items-center mb-1 position-relative">
                                    <i class="fa-solid fa-circle text-primary position-absolute" style="left: -7px; font-size: 8px;"></i>
                                    <input class="form-control form-control-sm border-0 border-bottom p-1 text-uppercase fw-bold bg-transparent" style="font-size:0.65rem;" value="${v.origen||''}" placeholder="ORIGEN" onblur="db.ref('viajes_activos/${vId}/origen').set(this.value.toUpperCase())">
                                </div>
                                <div class="d-flex align-items-center position-relative">
                                    <i class="fa-solid fa-location-dot text-danger position-absolute" style="left: -7px; font-size: 10px;"></i>
                                    <input class="form-control form-control-sm border-0 border-bottom p-1 text-uppercase fw-bold bg-transparent" style="font-size:0.65rem;" value="${v.destino||''}" placeholder="DESTINO" onblur="db.ref('viajes_activos/${vId}/destino').set(this.value.toUpperCase())">
                                </div>
                            </div>
                        </td>
                        <td class="col-contenedores ${hiddenCols['col-contenedores'] ? 'd-none' : ''}" style="vertical-align: middle;"><textarea class="table-input border rounded p-1 text-uppercase" style="min-height: 55px;" onblur="db.ref('viajes_activos/${vId}/contenedores').set(this.value.toUpperCase())">${v.contenedores||''}</textarea></td>
                        <td class="col-horarios ${hiddenCols['col-horarios'] ? 'd-none' : ''}" style="vertical-align: middle;">${btnSalida}${btnArribo}${btnFin}</td>
                        <td class="col-estatus" style="vertical-align: middle;">
                            <select class="form-select status-select shadow-sm" style="color:${colEstatus}; border-color:${colEstatus};" onchange="this.style.color = window.estatusData[this.value].col; this.style.borderColor = window.estatusData[this.value].col; registrarLog('${vId}', 'Cambi√≥ estatus a', this.options[this.selectedIndex].text); db.ref('viajes_activos/${vId}/estatus').set(this.value)">
                                ${optionsHtml}
                            </select>
                        </td>
                        <td class="col-gps" style="vertical-align: middle;">
                            <div class="d-flex flex-column align-items-center">
                                <div><i class="fa-solid fa-signal text-${isLost?'danger':'success'} me-1" style="font-size:10px;"></i><span class="speed-badge" style="background-color:${isLost?'#adb5bd':speedBg};">${speed} km/h</span></div>
                                <div class="mt-1 w-100">${ubiControl}<div style="font-size:8.5px; color:#666; margin-top:3px; font-weight:bold;">${pos ? formatTimeFriendly(pos.t) : '<span class="text-danger">Modo Manual</span>'}</div></div>
                            </div>
                        </td>
                        <td class="col-alertas ${hiddenCols['col-alertas'] ? 'd-none' : ''}" style="vertical-align: middle;">${v.alerta?'<span class="text-danger fw-bold" style="font-size:0.7rem;">'+v.alerta.txt+'</span>':'<span class="text-success fw-bold" style="font-size:0.7rem;">OK</span>'}</td>
                        <td class="col-historial ${hiddenCols['col-historial'] ? 'd-none' : ''}" style="vertical-align: middle;">${lastLog}<button class="btn btn-dark btn-sm p-0 w-100 fw-bold" style="font-size:0.65rem;" onclick="abrirModalLog('${vId}', '${nombreCamion}')"><i class="fa-solid fa-list-check"></i> Ver Historial</button></td>
                        <td class="col-accion" style="vertical-align: middle;">
                            <div class="d-flex flex-column gap-1 align-items-center">
                                <button onclick="shareWA('${nombreCamion}', '${addr}', '${v.origen}', '${v.destino}', '${v.estatus}', '${v.contenedores}', '${cliData.nombre}', '${nomSub}', '${speed}', '${posTextY}', '${posTextX}')" class="btn btn-outline-success btn-sm p-0" style="width: 25px; height: 25px;" title="WhatsApp"><i class="fa-brands fa-whatsapp"></i></button>
                                <button onclick="abrirEdicionViaje('${vId}', '${nombreCamion}')" class="btn btn-outline-primary btn-sm p-0" style="width: 25px; height: 25px;" title="Editar Cliente/Ruta"><i class="fa-solid fa-pencil"></i></button>
                                <button onclick="finalizarViaje('${vId}', '${nombreCamion}')" class="btn btn-outline-danger btn-sm p-0" style="width: 25px; height: 25px;" title="Archivar Viaje"><i class="fa-solid fa-trash"></i></button>
                            </div>
                        </td>
                    </tr>`;
                });
            }
            if(cliHtml !== "") html += `<tr class="header-cliente shadow"><td colspan="10">üì¶ CLIENTE: ${cliData.nombre} ${btnWaCli}</td></tr>` + cliHtml;
        }
        tbody.innerHTML = html || '<tr><td colspan="10" class="p-5 text-muted fs-5">A√∫n no hay viajes activos en la bit√°cora.</td></tr>';
        filtrarTablaInteligente();
    }

    function filtrarTablaInteligente() {
        let t = document.getElementById("buscador").value.toLowerCase();
        let rows = Array.from(document.querySelectorAll("#units-body tr"));
        rows.forEach(r => { if(r.classList.contains("data-row")) { r.style.display = (r.getAttribute("data-search") || "").includes(t) ? "" : "none"; } });
        let datosVisiblesSub = 0, datosVisiblesCli = 0;
        for (let i = rows.length - 1; i >= 0; i--) {
            let r = rows[i];
            if (r.classList.contains("data-row")) { if (r.style.display !== "none") { datosVisiblesSub++; datosVisiblesCli++; } } 
            else if (r.classList.contains("header-subcliente")) { r.style.display = datosVisiblesSub > 0 ? "" : "none"; datosVisiblesSub = 0; } 
            else if (r.classList.contains("header-cliente")) { r.style.display = datosVisiblesCli > 0 ? "" : "none"; datosVisiblesCli = 0; }
        }
    }

    function abrirModalLog(uId, uName) {
        document.getElementById("log_uid").value = uId; document.getElementById("log_uName").innerText = uName; document.getElementById("log_txt").value = "";
        let logsObj = viajesActivos[uId]?.log || {}; let logsArr = Object.values(logsObj).sort((a,b)=>b.t - a.t);
        let html = logsArr.map(l => `<div class="mb-1 border-bottom pb-1"><span class="text-muted fw-bold" style="font-size:0.65rem;">${new Date(l.t).toLocaleDateString()} ${new Date(l.t).toLocaleTimeString()} - ${l.usr}:</span> <b class="text-dark">${l.act}</b> <span class="text-primary">${l.det||''}</span></div>`).join('');
        document.getElementById("log_container").innerHTML = html || '<div class="text-muted text-center p-3 mt-4">Sin eventos. Escribe una nota abajo.</div>';
        new bootstrap.Modal(document.getElementById('modalLog')).show();
    }
    
    function guardarLogManual() {
        let uId = document.getElementById("log_uid").value, txt = document.getElementById("log_txt").value.toUpperCase(); if(!txt) return;
        registrarLog(uId, "Agreg√≥ Nota", txt);
        bootstrap.Modal.getInstance(document.getElementById('modalLog')).hide();
    }

    function registrarViaje() {
        let uN = document.getElementById("nv_unidad_input").value.toUpperCase(); if(!uN) return;
        let existe = Object.values(viajesActivos).some(v => v.unidadN === uN);
        if(existe && !confirm(`La unidad ${uN} ya tiene un viaje. ¬øAgregar uno simult√°neo?`)) return;

        let refPush = db.ref('viajes_activos').push();
        refPush.set({ cliente: document.getElementById("nv_cliente").value, subcliente: document.getElementById("nv_subcliente").value, origen: document.getElementById("nv_origen").value.toUpperCase(), destino: document.getElementById("nv_destino").value.toUpperCase(), estatus: "s1", operador: document.getElementById("nv_operador").value.toUpperCase(), unidadFallback: uN, unidadN: uN });
        registrarLog(refPush.key, "REGISTR√ì VIAJE", "Registr√≥ unidad en bit√°cora");
        bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide(); document.getElementById("nv_unidad_input").value = ""; document.getElementById("nv_operador").value = "";
    }

    function finalizarViaje(id, n) { if(confirm(`¬øArchivar viaje de la unidad ${n}?`)) { registrarLog(id, "FINALIZ√ì VIAJE", "Se archiva registro"); setTimeout(()=>db.ref('viajes_activos/'+id).remove(), 1000); } }
    function prepararNuevoViaje() { let s = document.getElementById("nv_cliente"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join(''); cargarSubclientesEnSelect('nv_subcliente', s.value); }
    function cargarSubclientesEnSelect(e, c) { let s = document.getElementById(e); s.innerHTML = '<option value="">N/A</option>'; if(c && dataClientes[c].subclientes) Object.keys(dataClientes[c].subclientes).forEach(k => s.innerHTML += `<option value="${k}">${dataClientes[c].subclientes[k].nombre}</option>`); }
    function abrirEdicionViaje(uId, uName) { let v = viajesActivos[uId]; if(!v) return; document.getElementById("edU_id").value = uId; document.getElementById("edU_name").innerText = uName; document.getElementById("ed_operador").value = v.operador || ""; document.getElementById("ed_origen").value = v.origen || ""; document.getElementById("ed_destino").value = v.destino || ""; let s = document.getElementById("ed_cliente"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join(''); s.value = v.cliente || ""; cargarSubclientesEnSelect('ed_subcliente', s.value); document.getElementById("ed_subcliente").value = v.subcliente || ""; new bootstrap.Modal(document.getElementById('modalEditarViaje')).show(); }
    function guardarEdicionViaje() { let uId = document.getElementById("edU_id").value; registrarLog(uId, "Edit√≥ Datos de Viaje", "Modific√≥ rutas/cliente/operador"); db.ref('viajes_activos/' + uId).update({ cliente: document.getElementById("ed_cliente").value, subcliente: document.getElementById("ed_subcliente").value, origen: document.getElementById("ed_origen").value.toUpperCase(), destino: document.getElementById("ed_destino").value.toUpperCase(), operador: document.getElementById("ed_operador").value.toUpperCase() }).then(() => { bootstrap.Modal.getInstance(document.getElementById('modalEditarViaje')).hide(); }); }
    function cerrarSesion() { localStorage.clear(); location.reload(); }

    function crearCliente() { db.ref('clientes').push({nombre: document.getElementById("cli_nombre").value.toUpperCase()}); document.getElementById("cli_nombre").value = ""; }
    function crearSubcliente() { db.ref(`clientes/${document.getElementById("sub_clientePadre").value}/subclientes`).push({nombre: document.getElementById("sub_nombre").value.toUpperCase()}); document.getElementById("sub_nombre").value = ""; }
    function crearUsuario() { let id = document.getElementById("usr_id").value.trim().toLowerCase(), nom = document.getElementById("usr_nom").value.trim(), pass = document.getElementById("usr_pass").value.trim(); if(id && nom && pass) { db.ref(`sistema/usuarios/${id}`).set({nom: nom, pass: pass, rol: "monitor"}); document.getElementById("usr_id").value=""; document.getElementById("usr_nom").value=""; document.getElementById("usr_pass").value=""; } }
    
    function actualizarListasAdmin() { 
        let s = document.getElementById("sub_clientePadre"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join(''); 
        document.getElementById("listaClientesAdmin").innerHTML = Object.keys(dataClientes).map(k => `<li class="list-group-item d-flex justify-content-between align-items-center p-1 fs-8">${dataClientes[k].nombre} <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('¬øBorrar Cliente?')) db.ref('clientes/${k}').remove()"></i></li>`).join('');
        let subHtml = ""; Object.keys(dataClientes).forEach(cId => { if(dataClientes[cId].subclientes) { Object.keys(dataClientes[cId].subclientes).forEach(sId => { subHtml += `<li class="list-group-item d-flex justify-content-between align-items-center p-1 fs-8"><b>${dataClientes[cId].nombre}</b> - ${dataClientes[cId].subclientes[sId].nombre} <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('¬øBorrar Subcliente?')) db.ref('clientes/${cId}/subclientes/${sId}').remove()"></i></li>`; }); } }); document.getElementById("listaSubclientesAdmin").innerHTML = subHtml;
        db.ref('sistema/usuarios').once('value', snap => { let usrs = snap.val() || {}; document.getElementById("listaUsuariosAdmin").innerHTML = Object.keys(usrs).map(k => k === 'admin' ? `<li class="list-group-item p-1 fs-8"><b>admin</b> (Maestro)</li>` : `<li class="list-group-item d-flex justify-content-between align-items-center p-1 fs-8"><b>${k}</b> <span class="text-truncate ps-1">${usrs[k].nom}</span> <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('¬øBorrar Usuario?')) db.ref('sistema/usuarios/${k}').remove()"></i></li>`).join(''); });
    }
    
    function agregarToken() { db.ref('sistema/tokens').push({nombre:document.getElementById("tk_nom").value.toUpperCase(), token:document.getElementById("tk_val").value, url:document.getElementById("tk_url").value}); alert("Token Guardado"); document.getElementById("tk_nom").value=""; document.getElementById("tk_val").value=""; }
    function actualizarListaTokensAdmin(tks) { const lista = document.getElementById("listaTokensActivos"); if(lista) { lista.innerHTML = Object.keys(tks || {}).map(id => `<li class="list-group-item d-flex justify-content-between p-1 fs-8"><b>${tks[id].nombre}</b> <small class="text-muted text-truncate w-50">(${tks[id].url})</small> <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('¬øBorrar Token?')) { db.ref('sistema/tokens/' + '${id}').remove().then(() => { location.reload(); }); }"></i></li>`).join(''); } }
</script>
</body>
</html>
