<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4 - FIX GPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --header-bg: #002a61; }
        body { background: #f0f4f8; font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; margin: 0; }
        .header-bar { background: white; padding: 10px 20px; border-bottom: 4px solid var(--header-bg); display: flex; justify-content: space-between; align-items: center; }
        .cliente-row { background: #336699; color: white; font-weight: bold; padding: 10px; text-align: left; }
        .badge-gps { font-size: 0.65rem; padding: 4px 8px; border-radius: 10px; }
    </style>
</head>
<body>

<div class="header-bar">
    <div class="d-flex align-items-center">
        <img src="TIGPS HD2.png" alt="Logo" style="height: 40px;" class="me-3">
        <h5 class="fw-bold m-0 text-primary">GRUDICOM TI & GPS</h5>
    </div>
    <div class="d-flex align-items-center">
        <div id="status-tokens" class="me-3"></div>
        <button class="btn btn-primary btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalViaje"><i class="fa-solid fa-plus"></i> Registrar Viaje</button>
        <button class="btn btn-secondary btn-sm fw-bold" onclick="location.reload()"><i class="fa-solid fa-rotate"></i></button>
    </div>
</div>

<div class="container-fluid mt-3">
    <div class="card shadow-sm border-0">
        <table class="table table-bordered align-middle text-center mb-0">
            <tbody id="main-table">
                <tr><td class="p-5 text-muted">Conectando con satÃ©lites...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<div class="modal fade" id="modalViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h6>NUEVO VIAJE</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body small">
        <label>Cliente:</label><select id="v_cli" class="form-select form-select-sm mb-2"></select>
        <label>Unidad (Selecciona de la lista):</label>
        <input type="text" id="v_uni" class="form-control form-control-sm mb-2" list="dl_unidades" placeholder="Escribe para buscar...">
        <label>Operador:</label><input type="text" id="v_ope" class="form-control form-control-sm mb-2">
        <button class="btn btn-primary w-100 fw-bold mt-2" onclick="guardarViaje()">INICIAR RUTA</button>
    </div>
</div></div></div>

<datalist id="dl_unidades"></datalist>

<script>
    const db = firebase.database({ databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" });
    let dataClientes = {}, viajesActivos = {}, unidadesGlobales = {};

    function init() {
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; updateUI(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; updateUI(); });
        
        // CARGA ASÃNCRONA DE TOKENS
        db.ref('sistema/tokens').once('value', s => {
            const tokens = s.val() ? Object.values(s.val()) : [];
            tokens.forEach(tk => {
                let sc = document.createElement("script"), cb = "w_"+Math.random().toString(36).substr(2,5);
                window[cb] = (d) => {
                    if(d && d.eid) cargarUnidadesGPS(tk, d.eid);
                    sc.remove();
                };
                sc.src = `${tk.url}/wialon/ajax.html?svc=token/login&params={"token":"${tk.token}"}&callback=${cb}`;
                document.head.appendChild(sc);
            });
        });
    }

    function cargarUnidadesGPS(tk, sid) {
        let sc = document.createElement("script"), cb = "u_"+Math.random().toString(36).substr(2,5);
        window[cb] = (d) => {
            if(d && d.items) {
                const dl = document.getElementById("dl_unidades");
                d.items.forEach(u => {
                    unidadesGlobales[u.nm.toUpperCase()] = u; // Guardamos datos del GPS
                    dl.innerHTML += `<option value="${u.nm.toUpperCase()}">`;
                });
            }
            updateUI(); sc.remove();
        };
        sc.src = `${tk.url}/wialon/ajax.html?svc=core/search_items&params={"spec":{"itemsType":"avl_unit","propName":"sys_name","propValueMask":"*","sortType":"sys_name"},"force":1,"flags":1025}&sid=${sid}&callback=${cb}`;
        document.head.appendChild(sc);
    }

    function updateUI() {
        const tbody = document.getElementById("main-table");
        let html = "";
        
        Object.keys(dataClientes).forEach(cId => {
            html += `<tr><td colspan="5" class="cliente-row">ðŸ“¦ CLIENTE: ${dataClientes[cId].nombre}</td></tr>`;
            html += `<tr class="bg-light fw-bold" style="font-size:0.65rem"><td>UNIDAD</td><td>OPERADOR</td><td>ESTATUS</td><td>VELOCIDAD</td><td>ÃšLTIMO REPORTE</td></tr>`;
            
            Object.keys(viajesActivos).forEach(vId => {
                const v = viajesActivos[vId];
                if(v.cliente === cId) {
                    // Buscamos si la unidad existe en el GPS
                    const gps = unidadesGlobales[v.unidadN.toUpperCase()] || null;
                    const vel = gps ? gps.pos.s : 0;
                    const time = gps ? new Date(gps.pos.t * 1000).toLocaleTimeString() : 'Sin seÃ±al';

                    html += `<tr>
                        <td class="fw-bold text-primary">${v.unidadN}</td>
                        <td>${v.operador || '---'}</td>
                        <td><span class="badge bg-success">En Ruta</span></td>
                        <td><span class="badge-gps ${vel > 0 ? 'bg-success text-white' : 'bg-secondary text-white'}">${vel} km/h</span></td>
                        <td><small>${time}</small></td>
                    </tr>`;
                }
            });
        });
        tbody.innerHTML = html;
        document.getElementById("v_cli").innerHTML = Object.keys(dataClientes).map(id => `<option value="${id}">${dataClientes[id].nombre}</option>`).join('');
    }

    function guardarViaje() {
        const uN = document.getElementById("v_uni").value.toUpperCase();
        if(!uN) return;
        db.ref('viajes_activos/' + uN).set({
            unidadN: uN,
            operador: document.getElementById("v_ope").value.toUpperCase(),
            cliente: document.getElementById("v_cli").value
        });
        bootstrap.Modal.getInstance(document.getElementById('modalViaje')).hide();
    }

    init();
</script>
</body>
</html>
