<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>DSG - CargoQuin | TMS Enterprise</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body.dark-mode { --bg-main: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --header-bg: #0d1b2a; --table-bg: #2c2c2c; --border-col: #444; }
        
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; transition: 0.3s; margin: 0; overflow-x: hidden;}
        
        .login-bg { background: linear-gradient(135deg, #002a61 0%, #001122 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: var(--bg-card); color: var(--text-main); width: 380px; border-radius: 12px; padding: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);}
        
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { background: var(--bg-card); border: 1px solid var(--border-col); }
        
        /* Pantalla Dividida (Tabla / Mapa) */
        .workspace-container { display: flex; height: calc(100vh - 70px); width: 100%; overflow: hidden; }
        .table-panel { width: 100%; transition: width 0.4s ease; overflow-y: auto; padding: 15px; }
        .map-panel { width: 0%; transition: width 0.4s ease; border-left: 3px solid var(--header-bg); display: none; position: relative;}
        .workspace-container.show-map .table-panel { width: 70%; }
        .workspace-container.show-map .map-panel { width: 30%; display: block; }
        #map { width: 100%; height: 100%; }
        
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; font-weight: 600; background: var(--table-bg); color: var(--text-main); }
        .table-input:focus { border-color: #002a61; outline: none; }
        
        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 0.95rem; font-weight: bold; text-align: left; border-top: 3px solid #002a61;}
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding-left: 20px !important; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.7rem; font-weight: 700; text-align: center; vertical-align: middle; padding: 6px; }
        
        .status-select { border-radius: 15px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.70rem; padding: 2px;}
        .maps-link { color: #0d6efd; font-weight: bold; text-decoration: none; }
        .audit-log { font-size: 0.7rem; background: #e9ecef; padding: 4px; border-radius: 4px; border-left: 3px solid #0d6efd; margin-bottom: 2px; text-align: left; line-height: 1.1; color: #333;}
        .time-input { font-size: 10px !important; text-align: center; font-weight: bold; cursor: pointer;}
        
        @keyframes blink-warning { 0% { background-color: rgba(220, 53, 69, 0.1); } 50% { background-color: rgba(220, 53, 69, 0.4); } 100% { background-color: rgba(220, 53, 69, 0.1); } }
        .inactive-row { animation: blink-warning 2.5s infinite; }
        .dark-mode .modal-content { background-color: var(--bg-card); color: var(--text-main); }
        .dark-mode .list-group-item { background-color: var(--table-bg); color: var(--text-main); border-color: var(--border-col); }
        .unit-name { cursor: pointer; text-decoration: underline; color: #0d6efd; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.jpg" alt="Logo" style="height: 55px; margin-bottom: 20px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
        <h5 class="text-primary fw-bold mb-4">TMS Enterprise</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a">
        <button onclick="autenticarUsuario()" class="btn btn-primary w-100 fw-bold py-2 shadow-sm"><i class="fa-solid fa-right-to-bracket"></i> INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Inicia sesi√≥n o presiona Enter</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.jpg" alt="Logo" style="height: 40px;" class="me-3" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
            <div>
                <h5 class="fw-bold m-0" style="color: var(--text-main);"><span class="text-primary">C4</span> - BIT√ÅCORA MAESTRA</h5>
                <small class="text-muted fw-bold" id="lblUsuarioActivo"><i class="fa-solid fa-user-shield"></i> Monitor: </small>
            </div>
        </div>
        <div>
            <button class="btn btn-info btn-sm fw-bold me-2 text-dark" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Ver Mapa</button>
            <button class="btn btn-dark btn-sm fw-bold me-2" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-outline-primary btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje" onclick="prepararNuevoViaje()"><i class="fa-solid fa-truck-fast"></i> Registrar Viaje</button>
            <button class="btn btn-outline-warning btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalHistorial" onclick="cargarHistorial()"><i class="fa-solid fa-clock-rotate-left"></i> Historial</button>
            <button class="btn btn-danger btn-sm fw-bold me-2" id="btnAdmin" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i> ADMIN</button>
            <button class="btn btn-secondary btn-sm fw-bold" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i> Salir</button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="table-panel">
            <div class="row mb-2 align-items-center">
                <div class="col-md-4"><input type="text" id="buscador" class="form-control form-control-sm shadow-sm" placeholder="üîç Buscar unidad, destino..." onkeyup="filtrarTabla()"></div>
                <div class="col-md-8 text-end">
                    <span id="syncIndicator" class="badge bg-secondary"><i class="fa-solid fa-satellite-dish"></i> Esperando conexi√≥n...</span>
                </div>
            </div>
            <div class="card shadow border-0 h-100">
                <div class="table-responsive h-100">
                    <table class="table table-bordered table-hover align-middle text-center mb-0" id="tablaViajes">
                        <tbody id="units-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="map-panel"><div id="map"></div></div>
    </div>
</div>

<div class="modal fade" id="modalAdmin" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-gears"></i> Administrador Central</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div class="row">
              <div class="col-md-3 border-end">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-server"></i> Tokens API</h6>
                  <div class="p-2 bg-light border rounded mb-2 text-dark">
                      <input type="text" id="tk_nom" class="form-control form-control-sm mb-1" style="text-transform:uppercase;" placeholder="Nombre Plataforma">
                      <input type="text" id="tk_url" class="form-control form-control-sm mb-1" placeholder="URL Servidor" value="https://hst-api.wialon.com">
                      <input type="text" id="tk_val" class="form-control form-control-sm mb-1" placeholder="Token de Acceso">
                      <button class="btn btn-success btn-sm w-100 fw-bold" onclick="agregarToken()">A√±adir Token</button>
                  </div>
                  <ul class="list-group list-group-sm" id="listaTokens" style="font-size:10px;"></ul>
              </div>
              
              <div class="col-md-3 border-end">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-id-card"></i> Asignar Operadores</h6>
                  <div class="p-2 bg-light border rounded mb-2 text-dark">
                      <input class="form-control form-control-sm mb-1" list="listaUnidadesTotales" id="op_unidad" style="text-transform:uppercase;" placeholder="Unidad (Ej. HC-450)" autocomplete="off">
                      <input type="text" id="op_nombre" class="form-control form-control-sm mb-1" style="text-transform: uppercase;" placeholder="Nombre del Operador">
                      <button onclick="vincularOperador()" class="btn btn-primary btn-sm w-100 fw-bold">Guardar Asignaci√≥n</button>
                  </div>
                  <ul class="list-group list-group-sm" id="listaOperadoresAdmin" style="font-size:10px; max-height: 250px; overflow-y: auto;"></ul>
              </div>

              <div class="col-md-3 border-end">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-building"></i> Clientes (Grupos)</h6>
                  <div class="p-2 bg-light border rounded mb-2 text-dark">
                      <input type="text" id="cli_nombre" class="form-control form-control-sm mb-1" style="text-transform: uppercase;" placeholder="Nombre Cliente">
                      <div class="mb-1 text-center fs-5">
                          <span style="cursor:pointer;" onclick="document.getElementById('cli_icono').value='üöõ'">üöõ</span>
                          <span style="cursor:pointer;" onclick="document.getElementById('cli_icono').value='üöö'">üöö</span>
                          <span style="cursor:pointer;" onclick="document.getElementById('cli_icono').value='üè¢'">üè¢</span>
                      </div>
                      <input type="hidden" id="cli_icono" value="üöõ">
                      <button onclick="crearCliente()" class="btn btn-success btn-sm w-100 fw-bold">Guardar Cliente</button>
                  </div>
                  <ul class="list-group list-group-sm" id="listaClientesAdmin"></ul>
              </div>
              
              <div class="col-md-3">
                  <h6 class="fw-bold text-primary"><i class="fa-solid fa-sitemap"></i> Subclientes y Usuarios</h6>
                  <div class="p-2 bg-light border rounded mb-2 text-dark">
                      <select id="sub_clientePadre" class="form-select form-select-sm mb-1"></select>
                      <input type="text" id="sub_nombre" class="form-control form-control-sm mb-1" style="text-transform: uppercase;" placeholder="Nombre Subcliente">
                      <button onclick="crearSubcliente()" class="btn btn-success btn-sm w-100 fw-bold mb-2">Guardar Subcliente</button>
                      <hr>
                      <input type="text" id="nu_user" class="form-control form-control-sm mb-1" style="text-transform: uppercase;" placeholder="Usuario Monitor">
                      <input type="password" id="nu_pass" class="form-control form-control-sm mb-1" placeholder="Contrase√±a">
                      <button onclick="crearMonitor()" class="btn btn-danger btn-sm w-100 fw-bold">Crear Monitor</button>
                  </div>
                  <ul class="list-group list-group-sm" id="listaUsuarios"></ul>
                  <ul class="list-group list-group-sm mt-2" id="listaSubclientesAdmin"></ul>
              </div>
          </div>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-truck-fast"></i> Registrar Nuevo Viaje</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
            <div class="modal-body small">
                <label class="fw-bold">Buscar Unidad (Multi-Token):</label>
                <input class="form-control form-control-sm mb-2" list="listaUnidadesTotales" id="nv_unidad_input" style="text-transform: uppercase;" placeholder="Escribe la unidad..." autocomplete="off">
                
                <label class="fw-bold text-primary"><i class="fa-solid fa-id-card"></i> Operador (De Base de Datos):</label>
                <input type="text" id="nv_operador" class="form-control form-control-sm mb-2 border-primary" style="text-transform: uppercase;" placeholder="Autom√°tico o Escribir Manual..." autocomplete="off">

                <div class="row mb-2">
                    <div class="col-6">
                        <label class="fw-bold">Cliente Principal:</label>
                        <select id="nv_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('nv_subcliente', this.value)"></select>
                    </div>
                    <div class="col-6">
                        <label class="fw-bold">Subcliente:</label>
                        <select id="nv_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select>
                    </div>
                </div>

                <div class="row">
                    <div class="col-6"><label class="fw-bold">Origen:</label><input type="text" id="nv_origen" class="form-control form-control-sm mb-2" style="text-transform: uppercase;" placeholder="Salida..." autocomplete="off"></div>
                    <div class="col-6"><label class="fw-bold">Destino (Auto-Arribo):</label><input type="text" id="nv_destino" class="form-control form-control-sm mb-2" style="text-transform: uppercase;" placeholder="Llegada..." autocomplete="off"></div>
                </div>
                <button onclick="registrarViaje()" class="btn btn-primary btn-sm w-100 fw-bold mt-2"><i class="fa-solid fa-play"></i> Registrar Viaje</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-pen"></i> Modificar Viaje</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><input type="hidden" id="edit_viaje_id"><div class="row mb-2"><div class="col-6"><label class="fw-bold">Cambiar Cliente:</label><select id="ev_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('ev_subcliente', this.value)"></select></div><div class="col-6"><label class="fw-bold">Cambiar Subcliente:</label><select id="ev_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div></div><button onclick="guardarEdicionViaje()" class="btn btn-dark btn-sm w-100 fw-bold mt-2">Guardar Cambios</button></div></div></div></div>

<div class="modal fade" id="modalComentarios" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-info text-white"><h6 class="modal-title fw-bold" id="tituloComentarios">Centro de Mensajes</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><div class="alert alert-warning p-2" id="msgUltimaNotif" style="font-size:11px; display:none;"></div><div id="listaComentarios" class="mb-3" style="max-height: 250px; overflow-y: auto; padding: 5px;"></div><div class="input-group"><input type="text" id="nuevoComentario" class="form-control form-control-sm" placeholder="Escribe nota o atiende alerta..."><button class="btn btn-primary btn-sm fw-bold" onclick="guardarComentario()">Agregar</button></div><input type="hidden" id="comentario_unidad_id"></div></div></div></div>

<div class="modal fade" id="modalHistorial" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-warning"><h6 class="modal-title fw-bold">Historial</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body small"><div class="table-responsive"><table class="table table-bordered table-striped text-center text-nowrap"><thead class="table-dark"><tr><th>Unidad</th><th>Cliente</th><th>Inicio</th><th>Fin</th><th>Origen ‚ûî Destino</th></tr></thead><tbody id="listaHistorial"></tbody></table></div></div></div></div></div>

<datalist id="listaUnidadesTotales"></datalist>

<script type="text/javascript">
    // 1. FIREBASE
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null; let configSistema = { tokens: [], usuarios: {} };
    let dataClientes = {}; let viajesActivos = {}; let historialGlobal = {}; let dbOperadores = {}; 
    
    // Motor Propio API
    let unidadesGlobales = {}; // Aqu√≠ vivir√°n los camiones vivos
    let mapUnidades = {}; // Para el buscador
    let pollingInterval = null;
    
    // Mapa y Geocoding
    let lmap = null; let mapMarkers = {}; let mapVisible = false; let geocodeCache = {};

    const estatusData = { "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s3":{nombre:"1.2 RETEN",col:"#7D3F00"}, "s4":{nombre:"1.3 Resguardo",col:"#5C338A"}, "s5":{nombre:"2. Incidencia",col:"#FFCCCC"}, "s6":{nombre:"3. Cargando",col:"#EAEAEA"}, "s7":{nombre:"4. Descargando",col:"#D0F0C0"}, "s8":{nombre:"5. Patio GDL",col:"#BCE3F9"}, "s9":{nombre:"6. Patio Reynosa",col:"#C2DEDB"}, "s10":{nombre:"7. Taller",col:"#B5A6A6"}, "s11":{nombre:"8. Finalizado",col:"#0055A5"} };

    function formatDateForInput(ms) { if (!ms) return ""; const d = new Date(ms); return new Date(d - d.getTimezoneOffset() * 60000).toISOString().slice(0, 16); }
    function toggleDarkMode() { document.body.classList.toggle('dark-mode'); localStorage.setItem('tms_dark_mode', document.body.classList.contains('dark-mode')); }

    function initMap() { lmap = L.map('map').setView([23.6345, -102.5528], 5); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', { attribution: '¬© OpenStreetMap' }).addTo(lmap); }
    function toggleMap() { const ws = document.getElementById("mainWorkspace"); mapVisible = !mapVisible; if(mapVisible) { ws.classList.add("show-map"); if(!lmap) initMap(); setTimeout(() => { lmap.invalidateSize(); actualizarMarcadoresMapa(); }, 400); } else { ws.classList.remove("show-map"); } }
    function centrarUnidadMapa(lat, lng) { if(!mapVisible) toggleMap(); setTimeout(() => { lmap.flyTo([lat, lng], 14, { animate: true, duration: 1.5 }); }, 400); }

    function actualizarMarcadoresMapa() {
        if(!mapVisible || !lmap) return;
        Object.keys(unidadesGlobales).forEach(id => {
            if(viajesActivos[id]) {
                const u = unidadesGlobales[id];
                if(u.pos && u.pos.x) {
                    let text = `<b>${u.name}</b><br>Velocidad: ${u.pos.s} km/h`;
                    if(!mapMarkers[id]) { mapMarkers[id] = L.marker([u.pos.y, u.pos.x]).addTo(lmap).bindPopup(text); } 
                    else { mapMarkers[id].setLatLng([u.pos.y, u.pos.x]).setPopupContent(text); }
                }
            } else { if(mapMarkers[id]) { lmap.removeLayer(mapMarkers[id]); delete mapMarkers[id]; } }
        });
    }

    window.onload = function () {
        if(localStorage.getItem('tms_dark_mode') === 'true') document.body.classList.add('dark-mode');
        
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; actualizarListasAdmin(); });
        db.ref('operadores').on('value', s => { dbOperadores = s.val() || {}; renderizarAdmin(); });
        
        db.ref('viajes_activos').on('value', s => { 
            viajesActivos = s.val() || {}; 
            renderizarBitacora(); actualizarDatalistUnidades(); actualizarMarcadoresMapa(); 
        });
        db.ref('historial').on('value', s => { historialGlobal = s.val() || {}; });
        
        db.ref('sistema/tokens').on('value', s => {
            let nuevosTokens = s.val() || [];
            if(currentUser && JSON.stringify(nuevosTokens) !== JSON.stringify(configSistema.tokens)) {
                configSistema.tokens = nuevosTokens; if(currentUser.rol === 'admin') renderizarAdmin(); arranqueCentral(); 
            } else { configSistema.tokens = nuevosTokens; }
        });

        document.getElementById("logPass").addEventListener("keyup", function(e) { if (e.key === "Enter") autenticarUsuario(); });
        document.getElementById("logUser").addEventListener("keyup", function(e) { if (event.key === "Enter") document.getElementById("logPass").focus(); });

        document.getElementById("nv_unidad_input").addEventListener("input", function() {
            let val = this.value.trim().toUpperCase(); let opInput = document.getElementById("nv_operador");
            if(dbOperadores[val]) { opInput.value = dbOperadores[val].toUpperCase(); } else { opInput.value = ""; }
        });

        let savedUser = localStorage.getItem("tms_user"); let savedPass = localStorage.getItem("tms_pass");
        if(savedUser && savedPass) { autenticarUsuario(savedUser, savedPass); }
    };

    function autenticarUsuario(autoUser, autoPass) {
        const u = autoUser || document.getElementById("logUser").value.trim(); const p = autoPass || document.getElementById("logPass").value.trim();
        if(!u || !p) return; document.getElementById("status").innerText = "Verificando...";
        db.ref('sistema').once('value', s => {
            let sys = s.val() || { usuarios: { admin: { pass: "admin123", rol: "admin", nom: "Admin" } }, tokens: [] };
            if(!s.val()) db.ref('sistema').set(sys);
            if(sys.usuarios[u] && sys.usuarios[u].pass === p) {
                currentUser = sys.usuarios[u]; configSistema = sys;
                localStorage.setItem("tms_user", u); localStorage.setItem("tms_pass", p);
                document.getElementById("loginOverlay").style.display = "none"; document.getElementById("dashboard").style.display = "block";
                document.getElementById("lblUsuarioActivo").innerHTML = `<i class="fa-solid fa-user-shield"></i> Monitor: ${currentUser.nom}`;
                if(currentUser.rol === "admin") { document.getElementById("btnAdmin").style.display = "inline-block"; renderizarAdmin(); }
                arranqueCentral();
            } else { document.getElementById("status").innerHTML = "<span class='text-danger'>Error de acceso</span>"; localStorage.removeItem("tms_user"); localStorage.removeItem("tms_pass"); }
        });
    }
    function cerrarSesion() { localStorage.removeItem("tms_user"); localStorage.removeItem("tms_pass"); location.reload(); }

    // =========================================================================
    // 3. MOTOR API FETCH (A prueba de bloqueos, r√°pido y estable)
    // =========================================================================
    async function wialonAPI(url, svc, params, sid=null) {
        let fd = new URLSearchParams();
        if(params) fd.append("params", JSON.stringify(params));
        if(sid) fd.append("sid", sid);
        try {
            let res = await fetch(`${url}/wialon/ajax.html?svc=${svc}`, { method: 'POST', body: fd });
            return await res.json();
        } catch(e) { return null; }
    }

    async function arranqueCentral() {
        if(pollingInterval) clearInterval(pollingInterval);
        await descargarFlotas();
        pollingInterval = setInterval(descargarFlotas, 20000); // 20 segs para no saturar 
    }

    async function descargarFlotas() {
        let ind = document.getElementById("syncIndicator");
        if(Object.keys(unidadesGlobales).length === 0) ind.innerHTML = "<i class='fa-solid fa-spinner fa-spin'></i> Conectando API...";
        
        if(!configSistema.tokens || configSistema.tokens.length === 0) { ind.className = "badge bg-danger"; ind.innerHTML = "Sin Tokens"; return; }

        let tempUnidades = { ...unidadesGlobales }; // Respaldo por si falla internet
        let successCount = 0;

        for (let tkObj of configSistema.tokens) {
            let url = (tkObj.url || "https://hst-api.wialon.com").replace(/\/$/, ""); 
            let tk = tkObj.token || tkObj;
            
            let login = await wialonAPI(url, 'token/login', {token: tk});
            if(login && login.eid) {
                successCount++;
                let sid = login.eid;
                let req = await wialonAPI(url, 'core/search_items', {
                    spec: {itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name"},
                    force: 1, flags: 1025, from: 0, to: 0
                }, sid);
                
                if(req && req.items) {
                    req.items.forEach(u => {
                        tempUnidades[u.id] = { id: u.id, name: u.nm.toUpperCase(), pos: u.pos, tk: tkObj.nombre };
                        mapUnidades[u.nm.toUpperCase()] = u.id; // Llenado seguro para buscador
                    });
                }
                wialonAPI(url, 'core/logout', {}, sid); // Logout limpio
            }
        }

        unidadesGlobales = tempUnidades;
        actualizarDatalistUnidades(); 
        
        if(successCount > 0) {
            ind.className = "badge bg-success"; ind.innerHTML = `<i class='fa-solid fa-check-double'></i> ${Object.keys(unidadesGlobales).length} Camiones`;
        } else { ind.className = "badge bg-danger"; ind.innerHTML = "Error de Red"; }

        renderizarBitacora(); actualizarMarcadoresMapa(); updateAddressesBackground();
    }

    function actualizarDatalistUnidades() {
        const dl = document.getElementById("listaUnidadesTotales"); dl.innerHTML = ""; 
        Object.values(unidadesGlobales).forEach(u => {
            if(!viajesActivos[u.id]) { let opt = document.createElement("option"); opt.value = u.name; dl.appendChild(opt); }
        });
    }

    function updateAddressesBackground() {
        Object.keys(viajesActivos).forEach(id => {
            let u = unidadesGlobales[id];
            if(u && u.pos && u.pos.x) {
                let key = u.pos.y.toFixed(3) + "," + u.pos.x.toFixed(3);
                let el = document.getElementById(`addr_${id}`);
                
                if(geocodeCache[key]) {
                    if(el) el.innerText = geocodeCache[key]; checkArribo(id, viajesActivos[id], geocodeCache[key]);
                } else {
                    fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${u.pos.y}&lon=${u.pos.x}&zoom=15&addressdetails=0`)
                    .then(r => r.json()).then(d => {
                        let addr = d.display_name || `${u.pos.y.toFixed(5)}, ${u.pos.x.toFixed(5)}`;
                        geocodeCache[key] = addr; if(el) el.innerText = addr; checkArribo(id, viajesActivos[id], addr);
                    }).catch(()=>{ if(el) el.innerText = `Coord: ${u.pos.y.toFixed(4)}, ${u.pos.x.toFixed(4)}`; });
                }
            }
        });
    }

    function checkArribo(id, v, dirStr) {
        if(v.destino && !v.t_arribo && dirStr.toUpperCase().includes(v.destino.toUpperCase())) {
            registrarTiempo(id, 't_arribo'); auditoria(id, `AUTO-ARRIBO: Localizado en ${v.destino}`);
        }
    }

    // 4. RENDERIZADO VISUAL A PRUEBA DE FALLOS
    function renderizarBitacora() {
        if(document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT") return; 
        const tbody = document.getElementById('units-body'); let html = "";

        let tree = { "Sin_Cliente": { "__n/a__": [] } };
        Object.keys(dataClientes).forEach(cId => { tree[cId] = { "__n/a__": [] }; if(dataClientes[cId].subclientes) { Object.keys(dataClientes[cId].subclientes).forEach(sId => tree[cId][sId] = []); } });

        // DIBUJAMOS LA TABLA BAS√ÅNDONOS EN FIREBASE, AS√ç NUNCA SE BORRAN SI WIALON FALLA
        Object.keys(viajesActivos).forEach(id => {
            let v = viajesActivos[id]; 
            // Si la API fall√≥, rescatamos el nombre de Firebase, si no, usamos el vivo
            let u = unidadesGlobales[id] || { id: id, name: v.unidadFallback || "Sin Conexi√≥n", pos: null }; 
            
            let cId = v.cliente || "Sin_Cliente"; let sId = v.subcliente || "__n/a__";
            if(!tree[cId]) tree[cId] = {"__n/a__": []}; if(!tree[cId][sId]) tree[cId][sId] = [];
            tree[cId][sId].push({u: u, v: v});
        });

        const headerColumnasHTML = `<tr class="header-columnas"><th width="10%">UNIDAD</th><th width="10%">OPERADOR</th><th width="15%">RUTA (O ‚ûî D)</th><th width="9%">CONTENEDORES</th><th width="11%">HORARIOS</th><th width="10%">ESTATUS</th><th width="15%">GPS & UBICACI√ìN</th><th width="8%">ALERTAS</th><th width="8%">AUDITOR√çA</th><th width="4%">ACCI√ìN</th></tr>`;

        for(let cId in tree) {
            let hasUnitsClient = false; let cliHtml = ""; let cliData = dataClientes[cId] || {nombre: "SIN CLIENTE ASIGNADO", icono: "‚ùì"};
            for(let sId in tree[cId]) {
                if(tree[cId][sId].length === 0) continue; hasUnitsClient = true;
                if(sId !== "__n/a__") { let subNom = dataClientes[cId].subclientes[sId].nombre; cliHtml += `<tr><td colspan="10" class="header-subcliente shadow-sm">‚Ü≥ Subcliente: ${subNom}</td></tr>`; }
                cliHtml += headerColumnasHTML; 

                tree[cId][sId].forEach(item => {
                    const u = item.u; const v = item.v; const id = u.id; const pos = u.pos;
                    const rowClass = (pos && pos.t && ((Date.now()/1000 - pos.t) > 1800)) ? "inactive-row" : "";
                    const speed = pos ? pos.s : 0; 
                    const iconMotor = speed > 0 ? `<i class="fa-solid fa-bolt text-success"></i>` : `<i class="fa-regular fa-circle text-danger"></i>`;
                    
                    let currentDriver = v.operador || ''; 
                    const tSal = v.t_salida ? `<div class="input-group input-group-sm mb-1"><span class="input-group-text bg-success text-white py-0 px-1" style="font-size:9px;">S</span><input type="datetime-local" class="form-control time-input py-0 px-1" value="${formatDateForInput(v.t_salida)}" onchange="modificarTiempo('${id}','t_salida',this.value)"></div>` : `<button class="btn btn-outline-success btn-sm py-0 mb-1 w-100 fw-bold" style="font-size:9px;" onclick="registrarTiempo('${id}','t_salida')">Salida</button>`;
                    const tArr = v.t_arribo ? `<div class="input-group input-group-sm"><span class="input-group-text bg-danger text-white py-0 px-1" style="font-size:9px;">A</span><input type="datetime-local" class="form-control time-input py-0 px-1" value="${formatDateForInput(v.t_arribo)}" onchange="modificarTiempo('${id}','t_arribo',this.value)"></div>` : `<button class="btn btn-outline-danger btn-sm py-0 w-100 fw-bold" style="font-size:9px;" onclick="registrarTiempo('${id}','t_arribo')">Arribo</button>`;

                    let alertaUI = `<span class="text-muted small">OK</span>`;
                    if(v.alerta) alertaUI = `<div class="text-danger fw-bold" style="font-size:9px; line-height:1;"><i class="fa-solid fa-bell fa-shake"></i> ${new Date(v.alerta.ts).toLocaleTimeString()}<br>${v.alerta.txt}</div>`;
                    let ultLog = ""; if(v.bitacora) { let l = Object.values(v.bitacora).pop(); ultLog = `<div class="audit-log"><b class="text-primary">${l.autor}:</b> ${l.txt}</div>`; }
                    const bgSt = estatusData[v.estatus] ? estatusData[v.estatus].col : '#fff'; const fgSt = ['#EAEAEA','#FFCCCC','#D0F0C0','#BCE3F9'].includes(bgSt) ? '#333' : '#fff';

                    let clickMap = pos ? `onclick="centrarUnidadMapa(${pos.y}, ${pos.x})"` : "";
                    const mapLink = pos ? `https://maps.google.com/?q=${pos.y},${pos.x}` : '#';
                    
                    let keyDir = pos ? (pos.y.toFixed(3) + "," + pos.x.toFixed(3)) : "";
                    let dirActual = geocodeCache[keyDir] || (pos ? "Buscando..." : "Sin GPS");

                    cliHtml += `<tr class="${rowClass}">
                        <td class="fw-bold fs-6 unit-name" ${clickMap} title="Ver en el mapa">${u.name}</td>
                        <td><input class="table-input" value="${currentDriver}" onblur="db.ref('viajes_activos/${id}/operador').set(this.value.toUpperCase())"></td>
                        <td><div class="input-group input-group-sm mb-1"><span class="input-group-text p-1 bg-light">O</span><input class="form-control p-1 fw-bold text-center" style="text-transform:uppercase;" value="${v.origen||''}" onblur="db.ref('viajes_activos/${id}/origen').set(this.value.toUpperCase())"></div><div class="input-group input-group-sm"><span class="input-group-text p-1 bg-light">D</span><input class="form-control p-1 fw-bold text-center" style="text-transform:uppercase;" value="${v.destino||''}" onblur="db.ref('viajes_activos/${id}/destino').set(this.value.toUpperCase())"></div></td>
                        <td><textarea class="table-input" rows="2" placeholder="CMAU..." style="text-transform:uppercase;" onblur="db.ref('viajes_activos/${id}/contenedores').set(this.value.toUpperCase())">${v.contenedores||''}</textarea></td>
                        <td class="align-middle">${tSal}${tArr}</td>
                        <td><select class="form-select status-select" style="background:${bgSt}; color:${fgSt};" onchange="db.ref('viajes_activos/${id}/estatus').set(this.value); auditoria('${id}','Estatus a: '+this.options[this.selectedIndex].text)">${Object.keys(estatusData).map(k => `<option value="${k}" ${v.estatus===k?'selected':''} style="background:#fff;color:#000">${estatusData[k].nombre}</option>`).join('')}</select></td>
                        <td><div class="d-flex align-items-center justify-content-center gap-2 mb-1"><span class="fs-5">${iconMotor}</span><span class="badge ${speed>0?'bg-danger':'bg-dark'} fs-6">${speed} km/h</span></div><a href="${mapLink}" target="_blank" class="maps-link d-block" title="Maps"><i class="fa-solid fa-map-location-dot"></i> <span id="addr_${id}" style="font-size:10px; color:var(--text-main);">${dirActual}</span></a></td>
                        <td>${alertaUI}<button class="btn btn-sm btn-outline-danger p-0 px-2 fw-bold mt-1 w-100" onclick="abrirAuditoria('${id}', '${u.name}', 'Alerta')"><i class="fa-solid fa-reply"></i> Atender</button></td>
                        <td>${ultLog}<button class="btn btn-sm btn-primary p-0 px-2 fw-bold w-100" onclick="abrirAuditoria('${id}', '${u.name}', '')"><i class="fa-solid fa-plus"></i> Nota</button></td>
                        <td class="align-middle"><div class="d-flex flex-column gap-1"><button onclick="abrirEditarViaje('${id}', '${cId}', '${sId}')" class="btn btn-outline-primary btn-sm p-1" title="Modificar Cliente/Grupo"><i class="fa-solid fa-pen"></i></button><button onclick="finalizarViaje('${id}', '${u.name}')" class="btn btn-outline-danger btn-sm p-1" title="Archivar"><i class="fa-solid fa-box-archive"></i></button></div></td>
                    </tr>`;
                });
            }
            if(hasUnitsClient) { html += `<tr><td colspan="10" class="header-cliente shadow-sm">${cliData.icono} CLIENTE: ${cliData.nombre}</td></tr>` + cliHtml; }
        }
        tbody.innerHTML = html; aplicarFiltroActual();
    }

    // 5. REGISTRAR VIAJES
    function prepararNuevoViaje() {
        actualizarDatalistUnidades(); let sel = document.getElementById("nv_cliente"); sel.innerHTML = `<option value="">Seleccione Cliente...</option>`;
        Object.keys(dataClientes).forEach(k => { sel.innerHTML += `<option value="${k}">${dataClientes[k].nombre}</option>`; });
        document.getElementById("nv_unidad_input").value = ""; document.getElementById("nv_operador").value = "";
    }
    function cargarSubclientesEnSelect(elId, cId, pre = "") {
        let sel = document.getElementById(elId); sel.innerHTML = `<option value="">N/A</option>`;
        if(cId && dataClientes[cId] && dataClientes[cId].subclientes) { Object.keys(dataClientes[cId].subclientes).forEach(sId => { let isSel = (sId === pre) ? "selected" : ""; sel.innerHTML += `<option value="${sId}" ${isSel}>${dataClientes[cId].subclientes[sId].nombre}</option>`; }); }
    }
    function registrarViaje() {
        let uNom = document.getElementById("nv_unidad_input").value.trim().toUpperCase();
        let uId = mapUnidades[uNom]; 
        if (!uId) return alert("Unidad no encontrada en el sistema. Aseg√∫rate de seleccionarla de la lista desplegable.");
        
        db.ref('viajes_activos/' + uId).set({ 
            cliente: document.getElementById("nv_cliente").value, subcliente: document.getElementById("nv_subcliente").value, origen: document.getElementById("nv_origen").value.toUpperCase(), destino: document.getElementById("nv_destino").value.toUpperCase(), estatus: "s1", operador: document.getElementById("nv_operador").value.trim().toUpperCase(), unidadFallback: uNom, bitacora: [{autor: currentUser.nom, fecha: Date.now(), txt: "Registr√≥ Viaje"}] 
        });
        bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide(); actualizarDatalistUnidades(); 
    }
    function abrirEditarViaje(uId, cC, cS) { document.getElementById("edit_viaje_id").value = uId; let selC = document.getElementById("ev_cliente"); selC.innerHTML = `<option value="">Sin Cliente</option>`; Object.keys(dataClientes).forEach(k => { let isSel = (k === cC) ? "selected" : ""; selC.innerHTML += `<option value="${k}" ${isSel}>${dataClientes[k].nombre}</option>`; }); cargarSubclientesEnSelect("ev_subcliente", cC, cS); new bootstrap.Modal(document.getElementById('modalEditarViaje')).show(); }
    function guardarEdicionViaje() { let id = document.getElementById("edit_viaje_id").value; db.ref(`viajes_activos/${id}/cliente`).set(document.getElementById("ev_cliente").value); db.ref(`viajes_activos/${id}/subcliente`).set(document.getElementById("ev_subcliente").value); auditoria(id, "Reasign√≥ cliente/grupo."); bootstrap.Modal.getInstance(document.getElementById('modalEditarViaje')).hide(); }

    // ADMIN 
    function renderizarAdmin() {
        let ulT = document.getElementById("listaTokens"); ulT.innerHTML = ""; (configSistema.tokens||[]).forEach((tk, i) => { ulT.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><b>${tk.nombre||'Plataforma'}</b><br><small class="text-muted">${tk.url||'Wialon'}</small></div><button class="btn btn-sm btn-danger py-0" onclick="borrarToken(${i})"><i class="fa-solid fa-trash"></i></button></li>`; });
        let ulU = document.getElementById("listaUsuarios"); ulU.innerHTML = ""; Object.keys(configSistema.usuarios).forEach(u => { ulU.innerHTML += `<li class="list-group-item d-flex justify-content-between"><b>${u}</b> (${configSistema.usuarios[u].rol}) <button class="btn btn-sm btn-danger py-0" onclick="db.ref('sistema/usuarios/${u}').remove()"><i class="fa-solid fa-trash"></i></button></li>`; });
        let ulO = document.getElementById("listaOperadoresAdmin"); ulO.innerHTML = ""; Object.keys(dbOperadores).forEach(uni => { ulO.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center"><div><b class="text-primary">${uni}</b><br>${dbOperadores[uni]}</div><button class="btn btn-sm btn-outline-danger py-0" onclick="db.ref('operadores/${uni}').remove()"><i class="fa-solid fa-trash"></i></button></li>`; });
        actualizarListasAdmin();
    }
    function agregarToken() { let val = document.getElementById("tk_val").value.trim(); if(!val) return; let tokens = [...(configSistema.tokens || [])]; tokens.push({ nombre: document.getElementById("tk_nom").value.trim().toUpperCase() || "WIALON", url: document.getElementById("tk_url").value.trim() || "https://hst-api.wialon.com", token: val }); db.ref('sistema/tokens').set(tokens); document.getElementById("tk_nom").value=""; document.getElementById("tk_val").value=""; }
    function borrarToken(idx) { if(!confirm("¬øEliminar plataforma?")) return; let tokens = [...(configSistema.tokens || [])]; tokens.splice(idx,1); db.ref('sistema/tokens').set(tokens); }
    function crearCliente() { db.ref('clientes').push({ nombre: document.getElementById("cli_nombre").value.toUpperCase(), icono: document.getElementById("cli_icono").value || "üöõ" }); document.getElementById("cli_nombre").value=""; }
    function crearSubcliente() { let cId = document.getElementById("sub_clientePadre").value; let sNom = document.getElementById("sub_nombre").value.toUpperCase(); if(!cId || !sNom) return; db.ref(`clientes/${cId}/subclientes`).push({ nombre: sNom }); document.getElementById("sub_nombre").value=""; }
    function vincularOperador() { let uNom = document.getElementById("op_unidad").value.trim().toUpperCase(); let oNom = document.getElementById("op_nombre").value.trim().toUpperCase(); if(!uNom || !oNom) return; db.ref(`operadores/${uNom}`).set(oNom); document.getElementById("op_unidad").value = ""; document.getElementById("op_nombre").value = ""; }
    function actualizarListasAdmin() {
        let lCli = document.getElementById("listaClientesAdmin"); lCli.innerHTML=""; let selPadre = document.getElementById("sub_clientePadre"); selPadre.innerHTML=`<option value="">Seleccionar Cliente...</option>`; let lSub = document.getElementById("listaSubclientesAdmin"); lSub.innerHTML="";
        Object.keys(dataClientes).forEach(cId => { lCli.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>${dataClientes[cId].icono} ${dataClientes[cId].nombre}</span><button onclick="db.ref('clientes/${cId}').remove()" class="btn btn-sm btn-danger py-0">X</button></li>`; selPadre.innerHTML += `<option value="${cId}">${dataClientes[cId].nombre}</option>`; if(dataClientes[cId].subclientes) Object.keys(dataClientes[cId].subclientes).forEach(sId => { lSub.innerHTML += `<li class="list-group-item d-flex justify-content-between"><span>[${dataClientes[cId].nombre}] -> ${dataClientes[cId].subclientes[sId].nombre}</span><button onclick="db.ref('clientes/${cId}/subclientes/${sId}').remove()" class="btn btn-sm btn-warning py-0">X</button></li>`; }); });
    }

    // AUDITOR√çA Y FLUJO
    function registrarTiempo(id, tipo) { db.ref(`viajes_activos/${id}/${tipo}`).set(Date.now()); auditoria(id, `Marc√≥ ${tipo === 't_salida' ? 'Salida' : 'Arribo'}.`); }
    function modificarTiempo(id, tipo, val) { if(!val) { db.ref(`viajes_activos/${id}/${tipo}`).remove(); return; } db.ref(`viajes_activos/${id}/${tipo}`).set(new Date(val).getTime()); auditoria(id, `Modific√≥ hora manualmente.`); }
    function auditoria(idViaje, texto) { db.ref(`viajes_activos/${idViaje}/bitacora`).push({ autor: currentUser.nom, fecha: Date.now(), txt: texto }); }
    function abrirAuditoria(id, uNom, tipoMsj) { document.getElementById("tituloComentarios").innerText = `Auditor√≠a: ${uNom}`; document.getElementById("comentario_unidad_id").value = id; let msgEl = document.getElementById("msgUltimaNotif"); if(tipoMsj === "Alerta" && viajesActivos[id].alerta) { msgEl.style.display = "block"; msgEl.innerHTML = `<b>Atendiendo Alerta:</b> ${viajesActivos[id].alerta.txt}`; } else { msgEl.style.display = "none"; } let html = ""; Object.values(viajesActivos[id].bitacora||{}).forEach(b => { html += `<div class="audit-log"><strong class="text-primary">${b.autor}</strong> <span class="text-muted" style="font-size:9px;">[${new Date(b.fecha).toLocaleString()}]</span><br>${b.txt}</div>`; }); document.getElementById("listaComentarios").innerHTML = html; new bootstrap.Modal(document.getElementById('modalComentarios')).show(); }
    function guardarComentario() { const id = document.getElementById("comentario_unidad_id").value; const txt = document.getElementById("nuevoComentario").value; if(!txt) return; auditoria(id, txt); document.getElementById("nuevoComentario").value = ""; if(viajesActivos[id].alerta) db.ref(`viajes_activos/${id}/alerta`).remove(); setTimeout(() => abrirAuditoria(id, document.getElementById("tituloComentarios").innerText.replace("Auditor√≠a: ",""), ""), 300); }
    function crearMonitor() { let u = document.getElementById("nu_user").value.trim().toUpperCase(); let p = document.getElementById("nu_pass").value.trim(); if(!u||!p) return; db.ref(`sistema/usuarios/${u}`).set({ pass: p, rol: "monitor", nom: u }); document.getElementById("nu_user").value=""; document.getElementById("nu_pass").value=""; }
    function finalizarViaje(id, nom) { if(!confirm(`¬øArchivar viaje?`)) return; let v = viajesActivos[id]; v.unidad = nom; v.finTs = Date.now(); db.ref('historial').push(v); db.ref('viajes_activos/'+id).remove(); actualizarDatalistUnidades(); if(mapMarkers[id]) { lmap.removeLayer(mapMarkers[id]); delete mapMarkers[id]; } }
    function cargarHistorial() { let html = ""; Object.keys(historialGlobal).reverse().forEach(k => { const h = historialGlobal[k]; html += `<tr><td>${h.unidad||''}</td><td>${(dataClientes[h.cliente]||{}).nombre||''}<br><small>${(dataClientes[h.cliente]?.subclientes?.[h.subcliente]?.nombre)||''}</small></td><td>${h.inicioTs?new Date(h.inicioTs).toLocaleDateString():''}</td><td>${h.finTs?new Date(h.finTs).toLocaleDateString():''}</td><td>${h.origen||''} ‚ûî ${h.destino||''}</td></tr>`; }); document.getElementById("listaHistorial").innerHTML = html; }
    function filtrarTabla() { const txt = document.getElementById("buscador").value.toLowerCase(); document.querySelectorAll("#units-body tr").forEach(f => { if(f.classList.contains("header-cliente")||f.classList.contains("header-subcliente")||f.classList.contains("header-columnas")) return; let rText = f.innerText.toLowerCase(); f.querySelectorAll('input').forEach(i => rText += " " + i.value.toLowerCase()); f.style.display = rText.includes(txt) ? "" : "none"; }); }
    function aplicarFiltroActual(){ filtrarTabla(); }
</script>
</body>
</html>
