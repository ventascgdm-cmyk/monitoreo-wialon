<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body.dark-mode { --bg-main: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --header-bg: #0d1b2a; --table-bg: #2c2c2c; --border-col: #444; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; margin: 0; overflow: hidden;}
        
        .login-bg { background: #001a33; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); }
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 75px); width: 100%; }
        
        .map-panel { height: 0%; width: 100%; transition: height 0.4s ease; border-bottom: 0 solid var(--header-bg); position: relative; z-index: 10; overflow: hidden; }
        .workspace-container.show-map .map-panel { height: 40%; border-bottom: 4px solid var(--header-bg); }
        .table-panel { height: 100%; width: 100%; transition: height 0.4s ease; overflow-y: auto; padding: 15px; }
        .workspace-container.show-map .table-panel { height: 60%; }
        #map { width: 100%; height: 100%; }

        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 1rem; font-weight: bold; text-align: left; padding: 10px !important; }
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding: 8px 25px !important; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.7rem; font-weight: 700; text-align: center; vertical-align: middle; }
        
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; background: var(--table-bg); color: var(--text-main); text-transform: uppercase;}
        .diag-pill { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-weight: bold; }
        .diag-ok { background: #d1e7dd; color: #0f5132; }
        .diag-error { background: #f8d7da; color: #842029; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="width: 200px; margin-bottom: 25px;">
        <h5 class="text-primary fw-bold mb-4">GRUDICOM TI & GPS | C4</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario" value="admin">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a" value="admin123">
        <button id="btnEnter" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">INSTALAR Y ENTRAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Iniciando sistema...</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 40px;" class="me-3">
            <div><h5 class="fw-bold m-0">GRUDICOM TI & GPS</h5><small id="lblMonitor" class="text-muted">Cargando...</small></div>
        </div>
        <div class="d-flex align-items-center">
            <div id="tokenDiagnostics" class="me-3 d-flex"></div>
            <button class="btn btn-info btn-sm fw-bold me-2" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Mapa</button>
            <button class="btn btn-outline-primary btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje"><i class="fa-solid fa-truck-fast"></i> Nuevo Viaje</button>
            <button class="btn btn-danger btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i> ADMIN</button>
            <button class="btn btn-secondary btn-sm fw-bold ms-2" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>
    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map"></div></div>
        <div class="table-panel">
            <div id="reinicioAlerta" class="alert alert-warning py-1 mb-2 small fw-bold" style="display:none;">‚ö†Ô∏è Base de datos vac√≠a. Usa ADMIN para configurar.</div>
            <div class="card shadow border-0"><div class="table-responsive"><table class="table table-bordered align-middle text-center mb-0" id="mainTable"><tbody id="units-body"></tbody></table></div></div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAdmin" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content">
    <div class="modal-header bg-danger text-white"><h6 class="modal-title fw-bold">CONFIGURACI√ìN MAESTRA</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body small"><div class="row">
        <div class="col-md-4 border-end"><h6>1. Tokens Wialon</h6><div class="p-2 bg-light border rounded mb-2">
            <input type="text" id="tk_n" class="form-control form-control-sm mb-1" placeholder="Nombre (DSG)">
            <input type="text" id="tk_v" class="form-control form-control-sm mb-1" placeholder="Token">
            <button class="btn btn-success btn-sm w-100" onclick="guardarToken()">Guardar Token</button>
        </div><ul class="list-group list-group-sm" id="listaTokensAdmin"></ul></div>
        <div class="col-md-4 border-end"><h6>2. Clientes</h6><div class="p-2 bg-light border rounded mb-2">
            <input type="text" id="cli_n" class="form-control form-control-sm mb-1" placeholder="Cliente">
            <button class="btn btn-primary btn-sm w-100" onclick="crearCliente()">Crear</button>
        </div><ul class="list-group list-group-sm" id="listaClientesAdmin"></ul></div>
        <div class="col-md-4"><h6>3. Subclientes</h6><div class="p-2 bg-light border rounded mb-2">
            <select id="sub_p" class="form-select form-select-sm mb-1"></select>
            <input type="text" id="sub_n" class="form-control form-control-sm mb-1" placeholder="Subcliente">
            <button class="btn btn-primary btn-sm w-100" onclick="crearSubcliente()">Crear</button>
        </div></div>
    </div></div>
</div></div></div>

<script type="text/javascript">
    const db = firebase.database({ databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" });
    let dataClientes = {}, viajesActivos = {}, unidadesWialon = {}, activeSIDs = {}, lmap = null;

    const estatusData = { "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s11":{nombre:"8. Finalizado",col:"#0055A5"} };

    function entrar() {
        const u = document.getElementById("logUser").value.trim();
        const p = document.getElementById("logPass").value.trim();

        if (u === "admin" && p === "admin123") {
            // AUTO-INSTALACI√ìN: Si Firebase est√° vac√≠o, creamos la estructura base
            db.ref('sistema/usuarios/admin').set({nom: "Administrador Maestro", pass: "admin123", rol: "admin"});
            
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            iniciarApp();
        } else {
            document.getElementById("status").innerText = "Credenciales incorrectas";
        }
    }

    document.getElementById("btnEnter").onclick = entrar;
    document.getElementById("logPass").onkeyup = e => { if(e.key === "Enter") entrar(); };

    function iniciarApp() {
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; renderizar(); actualizarAdminListas(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; renderizar(); });
        db.ref('sistema/tokens').on('value', s => { 
            const tks = s.val() ? Object.values(s.val()) : [];
            tks.forEach(tk => conectarWialon(tk));
        });
    }

    function renderizar() {
        const tbody = document.getElementById('units-body');
        let html = "";
        
        if (Object.keys(dataClientes).length === 0) {
            document.getElementById("reinicioAlerta").style.display = "block";
            tbody.innerHTML = '<tr><td colspan="8" class="p-5 text-muted">Base de datos limpia. Configura Clientes en ADMIN.</td></tr>';
            return;
        }

        document.getElementById("reinicioAlerta").style.display = "none";
        Object.keys(dataClientes).forEach(cId => {
            html += `<tr><td colspan="8" class="header-cliente shadow">üì¶ CLIENTE: ${dataClientes[cId].nombre}</td></tr>`;
            html += `<tr class="header-columnas"><th>UNIDAD</th><th>OPERADOR</th><th>RUTA</th><th>üì¶</th><th>HORARIOS</th><th>ESTATUS</th><th>GPS</th><th>ACCI√ìN</th></tr>`;
            // Las unidades aparecer√°n cuando registres viajes activos
        });
        tbody.innerHTML = html;
    }

    // GESTI√ìN ADMIN
    function crearCliente() { const n = document.getElementById("cli_n").value.toUpperCase(); if(n) db.ref('clientes').push({nombre: n}); document.getElementById("cli_n").value = ""; }
    function guardarToken() { const n = document.getElementById("tk_n").value.toUpperCase(), v = document.getElementById("tk_v").value; if(n && v) db.ref('sistema/tokens').push({nombre:n, token:v, url:"https://hst-api.wialon.com"}); document.getElementById("tk_n").value=""; document.getElementById("tk_v").value=""; }
    function actualizarAdminListas() {
        let s = document.getElementById("sub_p"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join('');
    }
    function crearSubcliente() { const p = document.getElementById("sub_p").value, n = document.getElementById("sub_n").value.toUpperCase(); if(p && n) db.ref(`clientes/${p}/subclientes`).push({nombre: n}); document.getElementById("sub_n").value=""; }
    function toggleMap() { document.getElementById("mainWorkspace").classList.toggle("show-map"); if(!lmap) { lmap = L.map('map').setView([23.6, -102.5], 5); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(lmap); } setTimeout(()=>lmap.invalidateSize(), 400); }
</script>
</body>
</html>
