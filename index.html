<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>MÓDULO DE PRUEBAS - CONDUCTORES (API CRUDA)</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background: #f8fafc; font-family: 'Inter', sans-serif; font-size: 0.85rem; }
    </style>
</head>
<body class="p-4">
    <div class="container bg-white p-4 rounded shadow-sm">
        <h3 class="fw-bold text-primary mb-3"><i class="fa-solid fa-flask"></i> Laboratorio: Motor de Choferes Multi-Host</h3>
        <p class="text-secondary">Este módulo usa la <strong>API Cruda de Wialon (AJAX Directo)</strong>. Si esto funciona aquí, significa que funcionará perfecto dentro de la Bitácora gigante sin chocar con otros Tokens.</p>
        
        <div class="input-group mb-3 mt-4">
            <span class="input-group-text bg-dark text-white"><i class="fa-solid fa-key"></i></span>
            <input type="text" id="token" class="form-control" value="9929a644617dd97b53d18cd6491fad66CEFFEDAAAEA1386033D128438DC0D19FFEA54F87" placeholder="Token Wialon">
            <button class="btn btn-primary fw-bold px-4" onclick="iniciarPrueba()">Conectar y Extraer</button>
        </div>

        <div id="log" class="alert alert-info d-none fw-bold shadow-sm"></div>

        <table class="table table-bordered table-hover align-middle mt-4 shadow-sm text-center">
            <thead class="table-dark">
                <tr>
                    <th>Unidad</th>
                    <th>Chofer Actual</th>
                    <th>Teléfono</th>
                    <th>Código</th>
                    <th style="width: 350px;">Asignar Nuevo</th>
                </tr>
            </thead>
            <tbody id="tabla-body">
                <tr><td colspan="5" class="text-center text-muted p-5 fs-5"><i class="fa-solid fa-satellite-dish fa-spin text-primary mb-3 fs-2"></i><br>Esperando conexión...</td></tr>
            </tbody>
        </table>
    </div>

<script>
    let activeSid = null;
    let unidadesGlobales = [];
    let driversHtml = '<option value="">-- ASIGNAR WIALON --</option>';

    function logMsg(msg, isError=false) {
        let el = document.getElementById("log");
        el.classList.remove("d-none");
        el.className = isError ? "alert alert-danger fw-bold shadow-sm" : "alert alert-success fw-bold shadow-sm";
        el.innerHTML += `<i class="fa-solid fa-circle-check"></i> ` + msg + "<br>";
    }

    // EL MOTOR DE API CRUDA (El mismo que usa la Bitácora)
    function peticionWialon(url, svc, params, sid=null) {
        return new Promise(resolve => {
            let script = document.createElement("script"); 
            let cb = "wialon_cb_" + Date.now() + Math.floor(Math.random()*1000);
            let timeout = setTimeout(() => { delete window[cb]; script.remove(); resolve(null); }, 8000);
            window[cb] = d => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(d); };
            script.onerror = () => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(null); };
            let baseUrl = url.replace(/\/$/, ''); 
            script.src = `${baseUrl}/wialon/ajax.html?svc=${svc}&params=${encodeURIComponent(JSON.stringify(params))}&callback=${cb}${sid?'&sid='+sid:''}`; 
            document.head.appendChild(script);
        });
    }

    async function iniciarPrueba() {
        document.getElementById("log").innerHTML = "";
        let tk = document.getElementById("token").value.trim();
        if(!tk) return alert("Pon un token válido");
        
        let url = "https://hst-api.wialon.com";

        logMsg("Iniciando Login a Wialon...");
        let login = await peticionWialon(url, "token/login", {token: tk});
        if(!login || !login.eid) return logMsg("Fallo al iniciar sesión. Token inválido o sin permisos.", true);
        
        activeSid = login.eid;
        logMsg("Login Exitoso. SID de Sesión: " + activeSid);

        // 1. EXTRAER UNIDADES (Flag 1 = base info)
        logMsg("Buscando Unidades...");
        let reqU = await peticionWialon(url, "core/search_items", { 
            spec: {itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, 
            force: 1, flags: 1, from: 0, to: 0 
        }, activeSid);
        
        if(!reqU || !reqU.items) return logMsg("Error: No se encontraron unidades.", true);
        unidadesGlobales = reqU.items;

        // 2. EXTRAER CONDUCTORES (Flag 257 = 1 base + 256 drivers)
        logMsg("Extrayendo Lista de Choferes...");
        let reqR = await peticionWialon(url, "core/search_items", { 
            spec: {itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, 
            force: 1, flags: 257, from: 0, to: 0 
        }, activeSid);

        let mapConductoresEnUnidad = {}; 
        let listaGlobalConductores = [];

        if(reqR && reqR.items) {
            reqR.items.forEach(res => {
                if(res.drv) {
                    for(let k in res.drv) {
                        let d = res.drv[k];
                        let info = { n: d.n, p: d.p || "", c: d.c || "N/A", dId: d.id, rId: res.id };
                        listaGlobalConductores.push(info);
                        // Si el chofer ya está amarrado a un camión (d.bu), lo guardamos en el mapa
                        if(d.bu) { mapConductoresEnUnidad[d.bu] = info; }
                    }
                }
            });
        }

        logMsg(`¡Éxito! Se extrajeron ${listaGlobalConductores.length} conductores.`);

        // Construir opciones del Select
        driversHtml = '<option value="">-- ASIGNAR WIALON --</option>';
        listaGlobalConductores.sort((a,b)=>a.n.localeCompare(b.n)).forEach(d => {
            driversHtml += `<option value="${d.rId}_${d.dId}">${d.n} ${d.p ? '['+d.p+']' : ''}</option>`;
        });

        renderizarTabla(unidadesGlobales, mapConductoresEnUnidad);
    }

    function renderizarTabla(units, mapConductores) {
        let tbody = document.getElementById("tabla-body");
        let html = "";
        
        units.forEach(u => {
            let c = mapConductores[u.id] || { n: "<span class='text-muted'><i>Sin asignar</i></span>", p: "---", c: "---" };
            let waLink = c.p !== "---" && c.p ? `<a href="https://wa.me/${c.p.replace(/\D/g,'')}" target="_blank" class="badge bg-success text-white text-decoration-none"><i class="fa-brands fa-whatsapp"></i> ${c.p}</a>` : `<span class="text-muted">---</span>`;

            html += `<tr>
                <td class="text-start ps-3"><b class="text-primary" style="font-size:1.1rem;">${u.nm}</b></td>
                <td class="fw-bold text-dark">${c.n}</td>
                <td>${waLink}</td>
                <td><span class="badge bg-secondary font-monospace">${c.c}</span></td>
                <td>
                    <div class="input-group input-group-sm">
                        <select class="form-select fw-bold text-secondary" id="sel_${u.id}">${driversHtml}</select>
                        <button class="btn btn-primary fw-bold" onclick="vincular(${u.id})"><i class="fa-solid fa-link"></i> Vincular</button>
                    </div>
                </td>
            </tr>`;
        });
        tbody.innerHTML = html;
    }

    // 3. VINCULAR CHOFER (API Raw)
    async function vincular(unitId) {
        let val = document.getElementById("sel_" + unitId).value;
        if(!val) return alert("Selecciona un conductor primero.");
        
        let arr = val.split("_");
        let resId = parseInt(arr[0]);
        let drvId = parseInt(arr[1]);

        let params = {
            resourceId: resId,
            unitId: parseInt(unitId),
            driverId: drvId,
            time: 0,
            mode: 1 // 1 = Bind (Asignar)
        };

        let btn = event.currentTarget;
        let oldHtml = btn.innerHTML;
        btn.innerHTML = `<i class="fa-solid fa-spinner fa-spin"></i>`;

        let res = await peticionWialon("https://hst-api.wialon.com", "resource/bind_unit_driver", params, activeSid);
        
        if(res && res.error) {
            alert("Error Wialon: Código " + res.error);
            btn.innerHTML = oldHtml;
        } else {
            alert("¡Conductor Vinculado Exitosamente!");
            iniciarPrueba(); // Recargar tabla para ver el cambio
        }
    }
</script>
</body>
</html>
