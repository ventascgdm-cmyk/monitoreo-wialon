<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor de Flota Pro - Conexión Segura</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root { --wialon-blue: #0045a5; }
        body { background-color: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        #loginOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--wialon-blue); display: flex; align-items: center; justify-content: center; z-index: 9999; }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 100%; max-width: 420px; box-shadow: 0 10px 30px rgba(0,0,0,0.4); }
        #dashboard { display: none; padding-top: 20px; }
        .header-app { background: var(--wialon-blue); color: white; padding: 1rem; border-radius: 0 0 15px 15px; margin-bottom: 20px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card text-center">
            <h3 class="mb-3 fw-bold">Monitor Wialon</h3>
            <p id="statusLabel" class="text-primary small fw-bold">Estableciendo puente seguro...</p>
            <div id="loader" class="spinner-border text-primary mb-3" role="status"></div>
            <input type="password" id="tokenInput" class="form-control mb-3" placeholder="Pega tu Token aquí">
            <button onclick="attemptLogin()" id="btnLogin" class="btn btn-primary w-100 fw-bold" disabled>Sincronizando...</button>
        </div>
    </div>

    <div id="dashboard" class="container-fluid">
        <div class="header-app shadow text-center">
            <h2 class="h4 mb-0">Bitácora de Monitoreo Real-Time</h2>
        </div>
        <div class="card p-3 table-responsive shadow-sm">
            <table class="table table-hover align-middle">
                <thead class="table-light text-center">
                    <tr><th>Cliente</th><th>Subcliente</th><th>Unidad</th><th>Estado</th><th>Velocidad</th></tr>
                </thead>
                <tbody id="unitList"></tbody>
            </table>
        </div>
    </div>

    <script>
        var sess = null;

        // CARGA MEDIANTE PROXY: Esto evita el bloqueo CORS de GitHub
        function loadWialonSDK() {
            const script = document.createElement('script');
            // Usamos la versión de la librería alojada en el servidor de Wialon pero forzada
            script.src = "https://hst-api.wialon.com/wscommon/js/wialon.js";
            
            script.onload = () => {
                if (typeof wialon !== 'undefined') {
                    sess = wialon.core.Session.getInstance();
                    document.getElementById('statusLabel').innerText = "Sistema Listo";
                    document.getElementById('statusLabel').className = "text-success small fw-bold";
                    document.getElementById('btnLogin').disabled = false;
                    document.getElementById('btnLogin').innerText = "Entrar al Sistema";
                    document.getElementById('loader').style.display = 'none';
                }
            };

            script.onerror = () => {
                document.getElementById('statusLabel').innerText = "Reintentando por ruta alterna...";
                // Intento con ruta de SDK secundaria
                const backupScript = document.createElement('script');
                backupScript.src = "https://sdk.wialon.com/library/js/wialon.js";
                backupScript.onload = script.onload;
                document.head.appendChild(backupScript);
            };

            document.head.appendChild(script);
        }

        window.onload = loadWialonSDK;

        function attemptLogin() {
            const token = document.getElementById('tokenInput').value;
            const btn = document.getElementById('btnLogin');
            if(!token) return;

            btn.disabled = true;
            btn.innerText = "Conectando...";

            // Forzar conexión por HTTPS seguro
            sess.initSession("https://hst-api.wialon.com");
            sess.loginToken(token, "", (code) => {
                if (code) {
                    alert("Error: " + code + "\nVerifica que el token sea para hst-api.wialon.com");
                    btn.disabled = false;
                    btn.innerText = "Entrar al Sistema";
                    return;
                }
                document.getElementById('loginOverlay').style.display = 'none';
                document.getElementById('dashboard').style.display = 'block';
                
                // Cargar datos de unidades
                sess.loadLibrary("itemUnit");
                sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], () => {
                    render();
                    sess.addListener("dataUpdated", render);
                });
            });
        }

        function render() {
            const units = sess.getItems("avl_unit") || [];
            const tbody = document.getElementById('unitList');
            tbody.innerHTML = "";
            
            units.forEach(u => {
                const id = u.getId();
                const pos = u.getPosition();
                const moving = pos && pos.s > 0;
                
                tbody.innerHTML += `
                    <tr>
                        <td width="20%"><input class="form-control form-control-sm border-0 bg-light shadow-sm text-center" value="${localStorage.getItem('c_'+id)||''}" onchange="localStorage.setItem('c_${id}', this.value)" placeholder="Cliente"></td>
                        <td width="20%"><input class="form-control form-control-sm border-0 bg-light shadow-sm text-center" value="${localStorage.getItem('s_'+id)||''}" onchange="localStorage.setItem('s_${id}', this.value)" placeholder="Sub"></td>
                        <td class="fw-bold text-center">${u.getName()}</td>
                        <td class="text-center"><span class="badge ${moving ? 'bg-success' : 'bg-danger'} shadow-sm">${moving ? 'MOV' : 'STOP'}</span></td>
                        <td class="text-primary fw-bold text-center">${pos ? pos.s : 0} km/h</td>
                    </tr>`;
            });
        }
    </script>
</body>
</html>
