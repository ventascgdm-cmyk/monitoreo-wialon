<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Monitoreo - Acceso Seguro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="text/javascript" src="https://hst-api.wialon.com/wscommon/js/wialon.js"></script>

    <style>
        :root { --wialon-blue: #0045a5; }
        body { background-color: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 69, 165, 0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(5px);
        }
        .login-card { background: white; padding: 2rem; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        #dashboard { display: none; }
        .header-app { background: var(--wialon-blue); color: white; padding: 1.5rem; border-radius: 0 0 15px 15px; }
        .card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card text-center">
            <h3 class="mb-3">Bienvenido</h3>
            <p class="text-muted small">Ingresa tu Token de Wialon</p>
            <input type="password" id="tokenInput" class="form-control mb-3" placeholder="Wialon API Token">
            <div class="form-check text-start mb-3">
                <input class="form-check-input" type="checkbox" id="rememberMe">
                <label class="form-check-label small" for="rememberMe">Recordar mi sesión</label>
            </div>
            <button onclick="attemptLogin()" id="btnLogin" class="btn btn-primary w-100 fw-bold">Entrar al Sistema</button>
            <div id="loginError" class="text-danger mt-2 small" style="display:none;"></div>
        </div>
    </div>

    <div id="dashboard" class="container-fluid">
        <div class="header-app mb-4 shadow text-center">
            <h2 class="h4 mb-0">Monitor de Flota</h2>
            <small id="userDisplay">Conectado</small>
        </div>

        <div class="row">
            <div class="col-lg-3 text-center mb-4">
                <div class="card p-3">
                    <h6>Estado de Motor</h6>
                    <canvas id="fleetChart"></canvas>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="card p-3 table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Cliente</th><th>Subcliente</th><th>Unidad</th><th>Motor</th><th>Velocidad</th>
                            </tr>
                        </thead>
                        <tbody id="unitList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Variables globales
        var sess = null;
        var myChart = null;

        // Intentar inicializar el SDK varias veces si es necesario
        function initWialon() {
            if (typeof wialon !== 'undefined') {
                sess = wialon.core.Session.getInstance();
                console.log("SDK de Wialon listo para usarse.");
            } else {
                console.log("Reintentando cargar SDK...");
                setTimeout(initWialon, 1000); // Reintenta cada segundo
            }
        }

        window.onload = () => {
            initWialon();
            const savedToken = localStorage.getItem('wialon_token');
            if(savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                document.getElementById('rememberMe').checked = true;
            }
        };

        function attemptLogin() {
            const token = document.getElementById('tokenInput').value;
            const btn = document.getElementById('btnLogin');
            const errorMsg = document.getElementById('loginError');

            if (!sess) {
                alert("El SDK de Wialon aún no carga. Por favor refresca la página (Ctrl+F5).");
                return;
            }

            btn.disabled = true;
            btn.innerText = "Conectando...";

            sess.initSession("https://hst-api.wialon.com");
            sess.loginToken(token, "", (code) => {
                if (code) {
                    btn.disabled = false;
                    btn.innerText = "Entrar al Sistema";
                    errorMsg.innerText = "Error " + code + ": " + wialon.core.Errors.getErrorText(code);
                    errorMsg.style.display = "block";
                    return;
                }

                if(document.getElementById('rememberMe').checked) {
                    localStorage.setItem('wialon_token', token);
                }

                document.getElementById('loginOverlay').style.display = "none";
                document.getElementById('dashboard').style.display = "block";
                
                // Cargar datos
                sess.loadLibrary("itemUnit");
                sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], () => {
                    updateUI();
                    sess.addListener("dataUpdated", updateUI);
                });
            });
        }

        function updateUI() {
            const units = sess.getItems("avl_unit");
            const tbody = document.getElementById('unitList');
            tbody.innerHTML = "";
            let on = 0, off = 0;

            units.forEach(unit => {
                const id = unit.getId();
                const pos = unit.getPosition();
                const isEngOn = pos && pos.s > 0;
                if(isEngOn) on++; else off++;

                const c = localStorage.getItem(`c_${id}`) || "";
                const s = localStorage.getItem(`s_${id}`) || "";

                tbody.innerHTML += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light" value="${c}" onchange="localStorage.setItem('c_${id}', this.value)"></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light" value="${s}" onchange="localStorage.setItem('s_${id}', this.value)"></td>
                        <td><strong>${unit.getName()}</strong></td>
                        <td><span class="badge ${isEngOn ? 'bg-success' : 'bg-danger'}">${isEngOn ? 'ON' : 'OFF'}</span></td>
                        <td>${pos ? pos.s : 0} km/h</td>
                    </tr>
                `;
            });
            drawChart(on, off);
        }

        function drawChart(on, off) {
            const ctx = document.getElementById('fleetChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['On', 'Off'],
                    datasets: [{ data: [on, off], backgroundColor: ['#28a745', '#dc3545'] }]
                }
            });
        }
    </script>
</body>
</html>
