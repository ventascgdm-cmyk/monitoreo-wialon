<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Monitoreo - Acceso Seguro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wscommon/js/wialon.js"></script>
    <style>
        :root { --wialon-blue: #0045a5; }
        body { background-color: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        
        /* Pantalla de Login */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 69, 165, 0.9);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999; backdrop-filter: blur(5px);
        }
        .login-card { background: white; padding: 2rem; border-radius: 15px; width: 100%; max-width: 400px; box-shadow: 0 10px 25px rgba(0,0,0,0.2); }
        
        /* Dashboard (Oculto inicialmente) */
        #dashboard { display: none; }
        
        .header-app { background: var(--wialon-blue); color: white; padding: 1.5rem; border-radius: 0 0 15px 15px; }
        .card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card text-center">
            <h3 class="mb-3">Bienvenido</h3>
            <p class="text-muted small">Ingresa tu Token de Wialon para comenzar</p>
            <input type="password" id="tokenInput" class="form-control mb-3" placeholder="Wialon API Token">
            <div class="form-check text-start mb-3">
                <input class="form-check-input" type="checkbox" id="rememberMe">
                <label class="form-check-label small" for="rememberMe">Recordar mi sesión</label>
            </div>
            <button onclick="attemptLogin()" id="btnLogin" class="btn btn-primary w-100 fw-bold">Entrar al Sistema</button>
            <div id="loginError" class="text-danger mt-2 small" style="display:none;">Token inválido o error de conexión.</div>
        </div>
    </div>

    <div id="dashboard" class="container-fluid">
        <div class="header-app mb-4 shadow">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="h4 mb-0">Monitor de Flota</h2>
                    <span id="userDisplay" class="badge bg-light text-primary">Cargando usuario...</span>
                </div>
                <div class="col-md-6 text-md-end">
                    <button onclick="exportToExcel()" class="btn btn-success btn-sm fw-bold">Descargar Excel</button>
                    <button onclick="logout()" class="btn btn-outline-light btn-sm ms-2">Cerrar Sesión</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3">
                <div class="card p-3 text-center mb-4">
                    <h6>Distribución de Motor</h6>
                    <canvas id="fleetChart"></canvas>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="card p-3 table-responsive">
                    <table class="table table-hover">
                        <thead class="table-light">
                            <tr>
                                <th>Cliente</th>
                                <th>Subcliente</th>
                                <th>Unidad</th>
                                <th>Motor</th>
                                <th>Velocidad</th>
                                <th>Coordenadas</th>
                            </tr>
                        </thead>
                        <tbody id="unitList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
    let sess; // Declarar la variable vacía al inicio
    let myChart;

    window.onload = () => {
        // Inicializar sess SÓLO cuando la página y el SDK estén listos
        if (typeof wialon !== 'undefined') {
            sess = wialon.core.Session.getInstance();
            console.log("Wialon SDK cargado correctamente");
        } else {
            alert("Error: No se pudo cargar el SDK de Wialon. Verifica tu conexión.");
        }
        
        const savedToken = localStorage.getItem('wialon_token');
        if(savedToken) {
            document.getElementById('tokenInput').value = savedToken;
            document.getElementById('rememberMe').checked = true;
        }
    };

        function attemptLogin() {
    const token = document.getElementById('tokenInput').value;
    const btn = document.getElementById('btnLogin');
    const errorMsg = document.getElementById('loginError');

    if(!token) return alert("Por favor, ingresa un token");

    btn.disabled = true;
    btn.innerText = "Conectando...";
    console.log("Intentando conectar con token:", token.substring(0,5) + "...");

    sess.initSession("https://hst-api.wialon.com");
    sess.loginToken(token, "", (code) => {
        // Si el código es distinto de 0, hay un error
        if (code) {
            btn.disabled = false;
            btn.innerText = "Entrar al Sistema";
            errorMsg.style.display = "block";
            errorMsg.innerText = "Error Wialon: " + wialon.core.Errors.getErrorText(code) + " (Código: " + code + ")";
            console.error("Error de login:", code);
            return;
        }

        console.log("¡Conexión exitosa!");
        // ... resto del código original ...
        if(document.getElementById('rememberMe').checked) {
            localStorage.setItem('wialon_token', token);
        }
        document.getElementById('loginOverlay').style.display = "none";
        document.getElementById('dashboard').style.display = "block";
        initData();
    });
}

        function initData() {
            sess.loadLibrary("itemUnit");
            sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024 | 4096, mode: 0}], () => {
                updateUI();
                sess.addListener("dataUpdated", updateUI);
            });
        }

        function updateUI() {
            const units = sess.getItems("avl_unit");
            const tbody = document.getElementById('unitList');
            tbody.innerHTML = "";
            let on = 0, off = 0;

            units.forEach(unit => {
                const id = unit.getId();
                const pos = unit.getPosition();
                const isEngOn = pos && pos.s > 0;
                if(isEngOn) on++; else off++;

                const c = localStorage.getItem(`c_${id}`) || "";
                const s = localStorage.getItem(`s_${id}`) || "";

                tbody.innerHTML += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light" value="${c}" onchange="localStorage.setItem('c_${id}', this.value)" placeholder="Cliente"></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light" value="${s}" onchange="localStorage.setItem('s_${id}', this.value)" placeholder="Sub"></td>
                        <td><strong>${unit.getName()}</strong></td>
                        <td><span class="badge ${isEngOn ? 'bg-success' : 'bg-danger'}">${isEngOn ? 'ON' : 'OFF'}</span></td>
                        <td>${pos ? pos.s : 0} km/h</td>
                        <td class="small text-muted">${pos ? pos.y.toFixed(4)+","+pos.x.toFixed(4) : 'N/A'}</td>
                    </tr>
                `;
            });
            drawChart(on, off);
        }

        function drawChart(on, off) {
            const ctx = document.getElementById('fleetChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Encendido', 'Apagado'],
                    datasets: [{ data: [on, off], backgroundColor: ['#28a745', '#dc3545'] }]
                },
                options: { plugins: { legend: { position: 'bottom' } } }
            });
        }

        function exportToExcel() {
            const units = sess.getItems("avl_unit");
            let csv = "\uFEFFCLIENTE,SUBCLIENTE,UNIDAD,MOTOR,VELOCIDAD\n";
            units.forEach(u => {
                const id = u.getId();
                const pos = u.getPosition();
                csv += `${localStorage.getItem('c_'+id)||'N/A'},${localStorage.getItem('s_'+id)||'N/A'},${u.getName()},${(pos && pos.s > 0)?'ON':'OFF'},${pos?pos.s:0}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Reporte.csv";
            link.click();
        }

        function logout() {
            localStorage.removeItem('wialon_token');
            location.reload();
        }
    </script>
</body>

</html>

