<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>C4 - Gestión Maestra de Conductores</title>
    <script type="text/javascript" src="//code.jquery.com/jquery-latest.min.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background: #f8fafc; padding: 20px; font-size: 0.85rem; }
        .unit-table { width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .unit-table th { background: #0f172a; color: white; padding: 12px; text-align: left; text-transform: uppercase; font-size: 0.7rem; }
        .unit-table td { padding: 10px; border-bottom: 1px solid #e2e8f0; }
        .drv-container { display: flex; align-items: center; gap: 8px; font-weight: bold; color: #0284c7; }
        .badge-geo { background: #d1fae5; color: #065f46; padding: 4px 8px; border-radius: 6px; font-weight: 700; font-size: 0.75rem; border: 1px solid #10b981; }
        .btn-bind { background: #3b82f6; color: white; border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-weight: bold; }
        .btn-bind:hover { background: #2563eb; }
        select { padding: 5px; border-radius: 4px; border: 1px solid #cbd5e1; outline: none; }
    </style>
</head>
<body>

    <h2 style="font-weight: 900; color: #1e293b;">OPERATIVO C4: <span style="color: #3b82f6;">GESTIÓN GPS</span></h2>
    <div id="log" style="margin-bottom: 15px; font-weight: bold; color: #64748b;">Conectando a Wialon...</div>

    <table class="unit-table">
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Conductor Actual</th>
                <th>Teléfono</th>
                <th>Geocerca / Ubicación</th>
                <th>Asignar Nuevo</th>
                <th>Acción</th>
            </tr>
        </thead>
        <tbody id="units-body"></tbody>
    </table>

<script type="text/javascript">
    const TOKEN = "9929a644617dd97b53d18cd6491fad66CEFFEDAAAEA1386033D128438DC0D19FFEA54F87";
    var all_drivers = {}; 
    var geocercas_list = [];
    var select_options = ""; 

    function init() {
        var sess = wialon.core.Session.getInstance();
        
        // Cargamos librerías: Conductores, Iconos y Geocercas (Zonas)
        sess.loadLibrary("resourceDrivers");
        sess.loadLibrary("resourceZones"); 
        sess.loadLibrary("itemIcon");

        // Flags: Base para unidades (1) + Posición (1024) y Base para recursos + Drivers (256) + Zonas (4096)
        var unit_flags = wialon.util.Number.or(wialon.item.Item.dataFlag.base, 1024);
        var res_flags = wialon.util.Number.or(wialon.item.Item.dataFlag.base, wialon.item.Resource.dataFlag.drivers, wialon.item.Resource.dataFlag.zones);

        sess.updateDataFlags(
            [{type: "type", data: "avl_unit", flags: unit_flags, mode: 0},
             {type: "type", data: "avl_resource", flags: res_flags, mode: 0}],
            function (code) {
                if (code) { console.error("Error:", code); return; }

                var units = sess.getItems("avl_unit");
                var ress = sess.getItems("avl_resource");

                // 1. Mapeamos Conductores (con teléfono) y Geocercas
                ress.forEach(res => {
                    // Procesar Geocercas
                    var zones = res.getZones() || {};
                    for (var zId in zones) { geocercas_list.push(zones[zId]); }

                    // Procesar Conductores
                    var drivers = res.getDrivers() || {};
                    for (var dId in drivers) {
                        var d = drivers[dId];
                        var phone = d.p && d.p.ph ? d.p.ph : "---"; // Extraer teléfono de propiedades
                        
                        if (!all_drivers[d.bu]) all_drivers[d.bu] = [];
                        all_drivers[d.bu].push({ id: d.id, name: d.n, phone: phone, resId: res.getId(), icon: res.getDriverImageUrl(d, 32) });
                        
                        select_options += `<option value="${res.getId()}_${d.id}">${d.n}</option>`;
                    }
                });

                // 2. Renderizamos la tabla
                var html = "";
                units.forEach(u => {
                    var u_id = u.getId();
                    var pos = u.getPosition();
                    var drvName = "<i>Sin conductor</i>";
                    var drvPhone = "---";
                    var drvIcon = "";

                    if (all_drivers[u_id]) {
                        var d = all_drivers[u_id][0]; // Tomamos el primer conductor vinculado
                        drvName = d.name;
                        drvPhone = d.phone;
                        drvIcon = `<img src="${d.icon}" width="20">`;
                    }

                    // Detección de Geocerca en tiempo real
                    var zonaActual = "En ruta";
                    if (pos) {
                        geocercas_list.forEach(z => {
                            if (z.pointIn(pos.x, pos.y)) zonaActual = `<span class="badge-geo">${z.n}</span>`;
                        });
                    }

                    html += `
                        <tr id="row_${u_id}">
                            <td><b>${u.getName()}</b></td>
                            <td><div class="drv-container">${drvIcon} ${drvName}</div></td>
                            <td><a href="tel:${drvPhone}" style="text-decoration:none; color:#475569; font-weight:bold;"><i class="fa fa-phone me-1"></i>${drvPhone}</a></td>
                            <td>${zonaActual}</td>
                            <td><select id="sel_${u_id}">${select_options}</select></td>
                            <td><button class="btn-bind" onclick="vincular('${u_id}')">Asignar</button></td>
                        </tr>`;
                });
                document.getElementById("units-body").innerHTML = html;
                document.getElementById("log").innerText = "Unidades sincronizadas con éxito.";
            }
        );
    }

    function vincular(u_id) {
        var sess = wialon.core.Session.getInstance();
        var unit = sess.getItem(u_id);
        var val = document.getElementById("sel_" + u_id).value;
        var [resId, drvId] = val.split("_");
        var res = sess.getItem(resId);
        var driver = res.getDriver(drvId);
        
        // Ejecutamos la vinculación física en Wialon
        res.bindDriverToUnit(driver, unit, 0, true, function(code) {
            if (code) { alert("Error: " + wialon.core.Errors.getErrorText(code)); return; }
            alert("Conductor " + driver.n + " asignado a " + unit.getName());
            location.reload(); 
        });
    }

    $(document).ready(function () {
        wialon.core.Session.getInstance().initSession("https://hst-api.wialon.com");
        wialon.core.Session.getInstance().loginToken(TOKEN, "", (code) => {
            if (!code) init();
        });
    });
</script>
</body>
</html>
