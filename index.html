<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4 - OPERATIVO MASTER</title>
    
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
    <meta http-equiv="Pragma" content="no-cache" />
    <meta http-equiv="Expires" content="0" />

    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800;900&display=swap');

        :root { --bg-main: #f1f5f9; --bg-card: #ffffff; --text-main: #334155; --header-bg: #0f172a; --border-col: #e2e8f0; --accent: #0284c7;}
        
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Inter', sans-serif; font-size: 0.75rem; margin: 0; padding: 0; height: 100vh; overflow: hidden !important; display: flex; flex-direction: column; }
        
        .login-bg { background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: var(--bg-card); color: var(--text-main); width: 380px; border-radius: 16px; padding: 40px; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5);}
        
        #dashboard { display: flex; flex-direction: column; flex: 1; height: 100%; overflow: hidden; }
        .header-bar { background: var(--bg-card); padding: 8px 24px; border-bottom: 2px solid var(--border-col); box-shadow: 0 2px 5px rgba(0,0,0,0.05); flex-shrink: 0; display: flex; align-items: center; justify-content: space-between; }
        
        .workspace-container { display: flex; flex-direction: column; flex: 1; width: 100%; overflow: hidden; }
        .map-panel { flex-basis: 0%; height: 0; overflow: hidden; transition: all 0.4s ease; border-bottom: 0px solid var(--accent); flex-shrink: 0;}
        .workspace-container.show-map .map-panel { flex-basis: 40%; height: 40%; border-bottom: 3px solid var(--accent); }
        #map { width: 100%; height: 100%; z-index: 1;}
        
        .table-panel { display: flex; flex-direction: column; flex: 1; padding: 0 10px 10px 10px; overflow: hidden; }
        .table-wrapper { flex: 1; overflow-y: auto; overflow-x: auto; border-radius: 6px; padding-bottom: 150px; background: white;}
        
        .table-custom { width: max-content; min-width: 100%; border-collapse: separate; border-spacing: 0 2px; margin-top: 0; table-layout: fixed; }
        
        /* ENCABEZADOS DE COLUMNA CENTRADOS Y MAXIMIZADOS */
        .header-columnas th { 
            background: var(--header-bg); color: #f8fafc; font-size: 0.70rem; font-weight: 800; text-align: center; vertical-align: middle; padding: 6px 2px; text-transform: uppercase; letter-spacing: 0.05em;
            position: sticky; top: 0; z-index: 10; border-bottom: 3px solid var(--accent); white-space: nowrap; user-select: none; line-height: 1.2;
        }
        
        .resizer { position: absolute; right: 0; top: 0; width: 6px; height: 100%; cursor: col-resize; z-index: 100; background: transparent; transition: 0.2s; }
        .resizer:hover, .resizing { background: rgba(2, 132, 199, 0.5); border-right: 2px solid var(--accent); }
        
        .data-row td { background: transparent !important; padding: 4px 4px; vertical-align: middle; border-top: 1px solid var(--border-col); border-bottom: 1px solid var(--border-col); transition: all 0.2s ease; overflow: visible !important; }
        .data-row td:first-child { border-left: 1px solid var(--border-col); border-top-left-radius: 6px; border-bottom-left-radius: 6px; }
        .data-row td:last-child { border-right: 1px solid var(--border-col); border-top-right-radius: 6px; border-bottom-right-radius: 6px; }
        .data-row:hover td { background: rgba(241, 245, 249, 0.8) !important; transform: translateY(-1px); }
        
        .lost-connection-row { outline: 1px dashed #ef4444; outline-offset: -1px; border-radius: 6px;}
        .external-gps-cell { background-color: rgba(14, 165, 233, 0.05) !important; border: 1px dashed #0ea5e9 !important; border-radius: 6px; }
        .stale-row td { background-color: #fee2e2 !important; border-top: 1px dashed #ef4444; border-bottom: 1px dashed #ef4444;}
        .stale-row td:first-child { border-left: 1px dashed #ef4444;} .stale-row td:last-child { border-right: 1px dashed #ef4444;}
        
        /* ENCABEZADOS CLIENTE GRUDICOM CORPORATIVO (BLANCO Y AZUL) */
        .header-cliente td { 
            background: #ffffff !important; 
            color: #0f172a !important; 
            padding: 12px 15px !important; 
            border: none !important; 
            border-top: 4px solid var(--accent) !important;
            border-bottom: 2px solid #e2e8f0 !important;
        }
        .header-subcliente td { background: #f8fafc !important; color: #475569 !important; font-size: 0.95rem; font-weight: 800; padding: 6px 10px !important; border: none !important; text-align: center; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid #e2e8f0 !important;}
        
        .client-logo { height: 60px; max-width: 250px; object-fit: contain; vertical-align: middle; border-radius: 6px; background: white; padding: 4px; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .client-logo-sub { height: 30px; max-width: 100px; object-fit: contain; vertical-align: middle; margin-right: 10px; border-radius: 4px; background: white; padding: 2px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }

        .input-ghost { border: 1px solid transparent; background: transparent; border-radius: 4px; padding: 2px 4px; width: 100%; font-size: 0.7rem; font-weight: 700; color: inherit; text-transform: uppercase; text-align: center; transition: all 0.2s; outline: none; }
        .input-ghost:hover { border-color: var(--border-col); background: rgba(255,255,255,0.8); }
        .input-ghost:focus { border-color: var(--accent); background: var(--bg-card); box-shadow: 0 0 0 2px rgba(2, 132, 199, 0.2); }
        
        .status-select-btn { border-radius: 12px; font-weight: 800; font-size: 0.65rem; padding: 2px 6px; background: transparent; border: 1.5px solid; width: 100%; display: flex; justify-content: space-between; align-items: center; transition: 0.2s;}
        .status-select-btn:hover { background-color: rgba(255,255,255,0.8); transform: scale(1.02); }
        
        .unit-name { cursor: pointer; color: var(--accent); font-weight: 900; font-size: 1.1rem; letter-spacing: 0.5px; display: block; text-align: center; transition: 0.2s;}
        .unit-name:hover { color: #0369a1; text-decoration: underline; }
        
        .wa-btn { background: #22c55e; color: white; padding: 3px 8px; border-radius: 6px; text-decoration: none; font-weight: bold; font-size: 0.65rem; transition: 0.3s; display: inline-block;}
        .wa-btn:hover { background: #16a34a; color: white; transform: scale(1.05); }
        
        .badge-geo { background: #f0fdf4; color: #15803d; font-weight: 800; padding: 2px 6px; border-radius: 4px; border: 1px dashed #22c55e; font-size: 0.65rem; display: inline-block; max-width: 160px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;}
        .speed-badge { font-size: 0.75rem; font-weight: 900; border-radius: 6px; padding: 2px 8px; text-align: center; color: white; display: inline-block; box-shadow: 0 1px 2px rgba(0,0,0,0.1);}
        
        .addr-container { max-height: 38px; overflow-y: auto; overflow-x: hidden; white-space: normal; word-break: break-word; font-size: 0.80rem; line-height: 1.1; color: #0f172a; font-weight: 900; padding-right: 4px; text-align: left; margin-top:2px;}
        .addr-container::-webkit-scrollbar { width: 3px; }
        .addr-container::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        .addr-link { text-decoration: none; display: block; width: 100%; transition: 0.2s;}
        .addr-link:hover .addr-container { color: var(--accent); text-decoration: underline;}
        
        .cp { cursor: pointer; }
        .dropdown-menu { z-index: 1050 !important; }
        .dropdown-menu-custom { border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: none; padding: 8px; min-width: 200px; }
        .dropdown-item-custom { border-radius: 8px; padding: 8px 12px; font-weight: 700; transition: 0.2s; font-size: 0.75rem; margin-bottom: 4px;}
        .dropdown-item-custom:hover { background-color: #f1f5f9; transform: translateX(3px); }

        #imgPreviewCaptura { max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
        .leaflet-popup-content-wrapper { border-radius: 8px; box-shadow: 0 10px 20px rgba(0,0,0,0.3); padding: 0; }
        .leaflet-popup-content { margin: 10px 15px; line-height: 1.2; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="height: 100px; margin-bottom: 20px;">
        <h5 class="fw-bold mb-4" style="color: #0f172a;">GRUDICOM TI & GPS</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center bg-light" placeholder="Usuario">
        <input type="password" id="logPass" class="form-control mb-4 text-center bg-light" placeholder="ContraseÃ±a">
        <button onclick="autenticarUsuario()" class="btn btn-primary w-100 fw-bold py-2 shadow-sm rounded-pill"><i class="fa-solid fa-right-to-bracket"></i> INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Motor C4 Master v37.0 (Anti-Crash Edition)</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 60px;" class="me-3">
            <div class="d-none d-md-block">
                <h3 class="fw-bold m-0 text-primary" style="letter-spacing:-0.5px; font-size: 1.8rem;">GRUDICOM TI & GPS <span class="text-secondary opacity-50">| C4</span></h3>
                <div class="text-muted fw-bold mt-1" id="lblUsuarioActivo" style="font-size: 0.85rem;"><i class="fa-solid fa-user-shield me-1"></i> Monitor: </div>
            </div>
        </div>
        
        <div class="search-bar-container flex-grow-1 px-4" style="max-width: 350px;">
            <div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden border border-secondary" style="background: white;">
                <span class="input-group-text bg-white border-0"><i class="fa-solid fa-magnifying-glass text-muted"></i></span>
                <input type="text" id="buscador" class="form-control border-0 bg-white shadow-none py-2" style="font-size: 0.80rem; font-weight: bold;" placeholder="Buscar unidad, operador..." onkeyup="filtrarTablaInteligente()">
            </div>
        </div>

        <div class="btn-action-group d-flex align-items-center">
            <div class="dropdown d-inline-block me-2">
                <button class="btn btn-light fw-bold dropdown-toggle border shadow-sm rounded-pill px-4 py-2" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="fa-solid fa-gear text-primary me-1"></i> Panel
                </button>
                <ul class="dropdown-menu shadow-lg border-0 rounded-4 p-2" style="font-size: 0.8rem; width: 280px;" id="colTogglerMenu">
                    <li><div class="px-3 py-2 fw-bold text-center text-dark bg-light rounded mb-2" id="menuSyncIndicator"><i class="fa-solid fa-satellite-dish text-primary"></i> Sincronizando...</div></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-3 py-1 fw-bold text-secondary" style="font-size:0.65rem;">SISTEMA</li>
                    <li><a class="dropdown-item cp py-2" data-bs-toggle="modal" data-bs-target="#modalStatusTokens"><i class="fa-solid fa-key me-2 text-warning"></i> Tokens Wialon</a></li>
                    <li><a class="dropdown-item cp py-2" onclick="resetColumnas()"><i class="fa-solid fa-arrows-rotate me-2 text-secondary"></i> Restaurar Tabla Original</a></li>
                    <li><a class="dropdown-item cp py-2" id="btnAdminMenu" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-user-shield me-2 text-danger"></i> Admin DB</a></li>
                    <li><hr class="dropdown-divider"></li>
                    <li class="px-3 py-1 fw-bold text-secondary" style="font-size:0.65rem;">MOVER Y OCULTAR COLUMNAS</li>
                    <div id="column-toggles"></div>
                </ul>
            </div>
            <button class="btn btn-info fw-bold me-1 text-dark shadow-sm rounded-pill px-3 py-2" onclick="toggleMap()"><i class="fa-solid fa-map me-1"></i> Mapa</button>
            <button class="btn btn-primary fw-bold me-1 shadow-sm rounded-pill px-3 py-2" onclick="prepararNuevoViaje()"><i class="fa-solid fa-plus"></i> Nuevo Viaje</button>
            <button class="btn btn-outline-danger fw-bold rounded-pill px-3 py-2" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map"></div></div>
        <div class="table-panel">
            <div class="table-wrapper" id="scrollContainer">
                <table class="table-custom text-center" id="mainTable">
                    <tbody id="units-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalAcciones" tabindex="-1">
    <div class="modal-dialog modal-sm modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-dark text-white border-0 py-3">
                <h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-gear me-2"></i> OPCIONES: <span id="acc_uName" class="text-info"></span></h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light rounded-bottom-4 p-4 d-flex flex-column gap-3">
                <input type="hidden" id="acc_vId">
                <button class="btn btn-primary fw-bold py-2 shadow-sm" onclick="ejecutarAccion('edit')"><i class="fa-solid fa-pencil me-2 fs-5 align-middle"></i> Editar Viaje</button>
                <button class="btn btn-danger fw-bold py-2 shadow-sm" onclick="ejecutarAccion('arch')"><i class="fa-solid fa-trash me-2 fs-5 align-middle"></i> Archivar Viaje</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalPreviewCaptura" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-camera-retro me-2"></i> CAPTURA GENERADA CON Ã‰XITO</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light p-3 text-center">
                <div style="max-height: 400px; overflow-y: auto; border: 1px solid #cbd5e1; border-radius: 8px; background: #fff; margin-bottom: 15px;">
                    <img id="imgPreviewCaptura" src="" alt="Vista Previa">
                </div>
                <div class="d-flex justify-content-center gap-3 flex-wrap">
                    <button class="btn btn-primary fw-bold shadow-sm px-4" onclick="descargarCaptura()"><i class="fa-solid fa-download me-2"></i> Descargar</button>
                    <button class="btn btn-dark fw-bold shadow-sm px-4" onclick="copiarCaptura()"><i class="fa-solid fa-copy me-2"></i> Copiar Imagen (WhatsApp Web)</button>
                    <button class="btn btn-success fw-bold shadow-sm px-4" onclick="compartirCaptura()"><i class="fa-solid fa-share-nodes me-2"></i> Compartir (MÃ³vil)</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-truck-fast me-2"></i> REGISTRO BATCH DE VIAJES</h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light rounded-bottom-4 p-4">
                <div class="bg-white p-3 rounded-4 shadow-sm mb-3">
                    <div class="form-check form-switch mb-3 bg-light p-2 rounded border border-info" style="font-size:0.85rem;">
                        <input class="form-check-input ms-1 cp" type="checkbox" id="nv_externa">
                        <label class="form-check-label fw-bold text-info ms-2 cp" for="nv_externa"><i class="fa-solid fa-globe"></i> MODO UNIDADES EXTERNAS MANUALES</label>
                    </div>
                    <div class="row mb-2">
                        <div class="col-md-6"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Cliente:</label><input type="text" id="nv_cliente" class="form-control form-control-sm bg-light fw-bold text-uppercase" list="list_clientes" placeholder="Escribe el cliente..."></div>
                        <div class="col-md-6"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Subcliente (Opcional):</label><input type="text" id="nv_subcliente" class="form-control form-control-sm bg-light fw-bold text-uppercase" list="list_subclientes" placeholder="Escribe el subcliente..."></div>
                    </div>
                </div>
                
                <div class="bg-white p-3 rounded-4 shadow-sm border border-primary">
                    <h6 class="fw-bold text-primary mb-3"><i class="fa-solid fa-list-check me-2"></i> AÃ‘ADIR UNIDADES AL LOTE</h6>
                    <div id="nv_filas_container"></div>
                    <button onclick="agregarFilaNV()" class="btn btn-outline-primary btn-sm w-100 fw-bold mb-3 border-dashed" style="border-style: dashed;"><i class="fa-solid fa-plus me-1"></i> AÃ‘ADIR OTRA UNIDAD AL LOTE</button>
                    <button onclick="registrarViajesMultiples()" class="btn btn-primary w-100 fw-bold py-2 rounded-pill shadow fs-6">ðŸš€ INICIAR TODOS LOS VIAJES</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalEditarViaje" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow-lg rounded-4">
            <div class="modal-header bg-primary text-white border-0 py-3">
                <h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-pencil me-2"></i> EDITAR VIAJE: <span id="edU_name" class="text-info"></span></h6>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body bg-light rounded-bottom-4 p-4">
                <div class="bg-white p-3 rounded-4 shadow-sm">
                    <input type="hidden" id="edU_id">
                    <div class="row mb-3">
                        <div class="col-6"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Cliente:</label><input type="text" id="ed_cliente" class="form-control form-control-sm bg-light fw-bold text-uppercase" list="list_clientes"></div>
                        <div class="col-6"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Subcliente:</label><input type="text" id="ed_subcliente" class="form-control form-control-sm bg-light fw-bold text-uppercase" list="list_subclientes"></div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-12 mb-2"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Origen:</label><input type="text" id="ed_origen" class="form-control form-control-sm bg-light text-uppercase" list="listaGeocercas"></div>
                        <div class="col-12"><label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Destino(s):</label><textarea id="ed_destino" class="form-control form-control-sm bg-light text-uppercase" rows="3" placeholder="MÃºltiples destinos permitidos"></textarea></div>
                    </div>
                    <label class="fw-bold text-secondary mb-1" style="font-size:0.75rem;">Operador Manual (Opcional):</label><input type="text" id="ed_operador" class="form-control form-control-sm mb-3 bg-light text-uppercase" list="listaConductores">
                    <button onclick="guardarEdicionViaje()" class="btn btn-success w-100 fw-bold py-2 rounded-pill shadow-sm">GUARDAR CAMBIOS</button>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalLog" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-dark text-white border-0 py-2"><h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-list-ul"></i> HISTORIAL: <span id="log_uName"></span></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-3 bg-light rounded-bottom-4"><div id="log_container" class="mb-3 bg-white border border-light rounded-4 p-2 shadow-sm" style="height:200px; overflow-y:auto; font-size:0.75rem;"></div><input type="hidden" id="log_uid"><div class="input-group input-group-sm shadow-sm rounded-pill overflow-hidden"><input type="text" id="log_txt" class="form-control border-0 text-uppercase bg-white px-3" placeholder="Nota manual..."><button class="btn btn-primary fw-bold px-3" onclick="guardarLogManual()"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div></div>
<div class="modal fade" id="modalStatusTokens" tabindex="-1"><div class="modal-dialog"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-warning text-dark border-0 py-2"><h6 class="modal-title fw-bold m-0"><i class="fa-solid fa-satellite-dish"></i> ESTATUS GPS</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><ul class="list-group list-group-flush rounded-bottom-4" id="listaStatusTokens"></ul></div></div></div></div>
<div class="modal fade" id="modalAdmin" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content border-0 shadow-lg rounded-4"><div class="modal-header bg-danger text-white border-0 py-2"><h6 class="modal-title fw-bold m-0">ADMINISTRACIÃ“N MAESTRA</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body bg-light rounded-bottom-4 p-3"><div class="row g-2"><div class="col-lg-2 col-md-4"><div class="bg-white p-2 rounded-3 shadow-sm h-100"><h6 class="fw-bold text-primary border-bottom pb-1" style="font-size:0.8rem;">Tokens GPS</h6><input type="text" id="tk_nom" class="form-control form-control-sm mb-1 bg-light" placeholder="Ej. RACEL"><input type="text" id="tk_url" class="form-control form-control-sm mb-1 bg-light" value="https://hst-api.wialon.com"><input type="text" id="tk_val" class="form-control form-control-sm mb-1 bg-light" placeholder="Token Largo"><button class="btn btn-primary btn-sm w-100 fw-bold rounded-pill py-0" onclick="agregarToken()">Guardar</button><ul class="list-group list-group-sm mt-2" id="listaTokensActivos" style="font-size:0.7rem;"></ul></div></div><div class="col-lg-3 col-md-4"><div class="bg-white p-2 rounded-3 shadow-sm h-100"><h6 class="fw-bold text-primary border-bottom pb-1" style="font-size:0.8rem;">Operadores Manuales</h6><input class="form-control form-control-sm mb-1 bg-light" list="listaUnidadesTotales" id="op_unidad" placeholder="Unidad" autocomplete="off"><input type="text" id="op_nombre" class="form-control form-control-sm mb-1 bg-light" placeholder="Nombre ChÃ³fer"><button onclick="vincularOperador()" class="btn btn-primary btn-sm w-100 fw-bold rounded-pill py-0">Vincular</button><ul class="list-group list-group-sm mt-2" id="listaOperadoresAdmin" style="font-size:0.7rem;"></ul></div></div><div class="col-lg-2 col-md-4"><div class="bg-white p-2 rounded-3 shadow-sm h-100"><h6 class="fw-bold text-primary border-bottom pb-1" style="font-size:0.8rem;">Clientes</h6><input type="text" id="cli_nombre" class="form-control form-control-sm mb-1 bg-light" placeholder="Empresa"><input type="file" id="cli_logo_file" accept="image/*" class="form-control form-control-sm mb-1 bg-light" title="Seleccionar Logo" style="font-size:0.6rem;"><button onclick="crearCliente()" class="btn btn-primary btn-sm w-100 fw-bold rounded-pill py-0">AÃ±adir</button><input type="file" id="edit_cli_logo_file" accept="image/*" style="display:none;" onchange="if(this.files && this.files[0] && window.currentEditCli){let reader = new FileReader(); reader.onload = e => {db.ref('clientes/' + window.currentEditCli).update({logo: e.target.result}); this.value = '';}; reader.readAsDataURL(this.files[0]);}"><ul class="list-group list-group-sm mt-2" id="listaClientesAdmin" style="max-height: 200px; overflow-y:auto; font-size:0.7rem;"></ul></div></div><div class="col-lg-2 col-md-4"><div class="bg-white p-2 rounded-3 shadow-sm h-100"><h6 class="fw-bold text-primary border-bottom pb-1" style="font-size:0.8rem;">Subclientes</h6><select id="sub_clientePadre" class="form-select form-select-sm mb-1 bg-light"></select><input type="text" id="sub_nombre" class="form-control form-control-sm mb-1 bg-light" placeholder="Sub-empresa"><button onclick="crearSubcliente()" class="btn btn-primary btn-sm w-100 fw-bold rounded-pill py-0">AÃ±adir</button><ul class="list-group list-group-sm mt-2" id="listaSubclientesAdmin" style="max-height: 200px; overflow-y:auto; font-size:0.7rem;"></ul></div></div><div class="col-lg-3 col-md-4"><div class="bg-white p-2 rounded-3 shadow-sm h-100"><h6 class="fw-bold text-primary border-bottom pb-1" style="font-size:0.8rem;">Monitoristas</h6><input type="text" id="usr_id" class="form-control form-control-sm mb-1 bg-light" placeholder="Usuario (login)"><input type="text" id="usr_nom" class="form-control form-control-sm mb-1 bg-light" placeholder="Nombre completo"><input type="text" id="usr_pass" class="form-control form-control-sm mb-1 bg-light" placeholder="ContraseÃ±a"><button onclick="crearUsuario()" class="btn btn-primary btn-sm w-100 fw-bold rounded-pill py-0">Crear</button><ul class="list-group list-group-sm mt-2" id="listaUsuariosAdmin" style="font-size:0.7rem;"></ul></div></div></div></div></div></div></div>

<datalist id="list_clientes"></datalist><datalist id="list_subclientes"></datalist><datalist id="listaGeocercas"></datalist><datalist id="listaConductores"></datalist><datalist id="listaUnidadesTotales"></datalist>

<script type="text/javascript">
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null, configSistema = { tokens: [] }, dataClientes = {}, viajesActivos = {};
    let unidadesGlobales = {}, ramDrivers = {}, dbOperadores = {}, geocercasNativas = [], activeSIDs = {}, pollingInterval = null;
    let lmap = null, mapVisible = false, mapLayerGroup = null, geofenceLayerGroup = null;
    let estadoTokens = {}, datosAgrupadosGlobal = {}; 
    let mapaMarcadores = {}; 

    let geocodeCache = JSON.parse(localStorage.getItem('tms_geoCache')) || {}; 
    let geoQueue = []; let isGeocoding = false; let motorArrancado = false; let isSyncingFlotas = false;
    let currentCaptureBlob = null; 

    // --- PRIORIDADES ESTRICTAS Y TAMAÃ‘OS ---
    const columnasDef = {
        'col-unidad': { titulo: 'UNIDAD', ancho: '110' },
        'col-operador': { titulo: 'OPERADOR GPS', ancho: '150' },
        'col-ruta': { titulo: 'RUTA (O âž” D)', ancho: '160' },
        'col-contenedores': { titulo: 'CONTENEDORES', ancho: '110' },
        'col-horarios': { titulo: 'HORARIOS', ancho: '95' },
        'col-estatus': { titulo: 'ESTATUS', ancho: '120' },
        'col-gps': { titulo: 'UBICACIÃ“N Y GEOCERCA', ancho: '420' },
        'col-alertas': { titulo: 'ALERTAS', ancho: '90' },
        'col-historial': { titulo: 'HISTORIAL LOG', ancho: '240' },
        'col-accion': { titulo: '<i class="fa-solid fa-bars"></i>', ancho: '65' }
    };
    
    // BLINDAJE ANTI-ERRORES: Si la memoria del navegador estÃ¡ corrupta, la reinicia.
    let colOrder;
    try { 
        colOrder = JSON.parse(localStorage.getItem('tms_colOrder')); 
        if (!Array.isArray(colOrder) || colOrder.length !== Object.keys(columnasDef).length) throw "Invalid";
        colOrder.forEach(c => { if(!columnasDef[c]) throw "Invalid"; });
    } catch(e) { 
        colOrder = Object.keys(columnasDef); 
        localStorage.setItem('tms_colOrder', JSON.stringify(colOrder));
    }

    let hiddenCols;
    try { hiddenCols = JSON.parse(localStorage.getItem('tms_hiddenCols')) || { 'col-contenedores': false, 'col-alertas': false, 'col-historial': false }; } 
    catch(e) { hiddenCols = { 'col-contenedores': false, 'col-alertas': false, 'col-historial': false }; }

    window.estatusData = { 
        "s1":{nombre:"1. Ruta",col:"#10b981"}, "s2":{nombre:"1.1 PARADO",col:"#ef4444"}, "s3":{nombre:"1.2 RETEN",col:"#d97706"}, "s4":{nombre:"1.3 Resguardo",col:"#8b5cf6"}, "s5":{nombre:"1.4 REGRESANDO",col:"#f59e0b"}, "s6":{nombre:"2. Incidencia",col:"#be123c"}, "s7":{nombre:"3. Cargando",col:"#64748b"}, "s8":{nombre:"4. Descargando",col:"#0284c7"}, "s9":{nombre:"5. Patio GDL",col:"#06b6d4"}, "s10":{nombre:"6. Patio Reynosa",col:"#14b8a6"}, "s11":{nombre:"7. Taller",col:"#94a3b8"}, "s12":{nombre:"8. Finalizado",col:"#1e40af"}, "s13":{nombre:"9. Baja cobertura",col:"#fbbf24"}, "s14":{nombre:"ALIMENTOS",col:"#f59e0b"} 
    };

    function hexToRgba(hex, alpha) {
        if(!hex || hex.length !== 7) return `rgba(15, 23, 42, ${alpha})`;
        let r = parseInt(hex.slice(1, 3), 16), g = parseInt(hex.slice(3, 5), 16), b = parseInt(hex.slice(5, 7), 16);
        return `rgba(${r}, ${g}, ${b}, ${alpha})`;
    }

    function encontrarUnidad(v, vId) {
        if(!v) return null;
        if(v.wialonId && v.wialonId !== "EXTERNO" && unidadesGlobales[v.wialonId]) return unidadesGlobales[v.wialonId];
        let n = String(v.unidadN || v.unidadFallback || "").trim().toUpperCase();
        let norm = n.replace(/[\s\-]/g, "");
        for(let k in unidadesGlobales) {
            let uName = String(unidadesGlobales[k].name).trim().toUpperCase();
            if(uName === n || uName.replace(/[\s\-]/g, "") === norm) return unidadesGlobales[k];
        }
        if(unidadesGlobales[vId]) return unidadesGlobales[vId];
        return null; 
    }

    function isInsidePolygon(point, vs) {
        let x = point[0], y = point[1], inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            let xi = vs[i].x, yi = vs[i].y, xj = vs[j].x, yj = vs[j].y;
            let intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }
    
    function getDistanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }
    
    function resolverGeocerca(lat, lon) {
        if(!geocercasNativas || geocercasNativas.length === 0) return null;
        for(let z of geocercasNativas) {
            if(!z.p) continue;
            if(z.t === 3) { let r = z.p[0].r || 50; if(getDistanceMeters(lat, lon, z.p[0].y, z.p[0].x) <= r) return z.n; } 
            else { if(isInsidePolygon([lon, lat], z.p)) return z.n; }
        }
        return null;
    }

    function formatearFechaElegante(ms) {
        if (!ms) return "--:--"; let d = new Date(ms); let meses = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
        return `${String(d.getDate()).padStart(2, '0')} ${meses[d.getMonth()]} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }
    
    function formatTimeFriendly(unixSecs) { 
        if(!unixSecs) return "--:--"; let d = new Date(unixSecs * 1000); let today = new Date();
        let timeStr = d.toLocaleTimeString('es-MX', {hour:'2-digit', minute:'2-digit'});
        if(d.toDateString() === today.toDateString()) return timeStr;
        return d.toLocaleDateString('es-MX', {day:'2-digit', month:'short'}) + " " + timeStr; 
    }
    
    function getLocalISO(unixMillis) {
        if(!unixMillis) return ""; let tzoffset = (new Date()).getTimezoneOffset() * 60000;
        return (new Date(unixMillis - tzoffset)).toISOString().slice(0, 16);
    }
    
    function timeAgo(unixSecs) {
        if(!unixSecs) return "N/A"; let diff = Math.floor(Date.now()/1000) - unixSecs;
        if(diff < 60) return `${diff}s`; if(diff < 3600) return `${Math.floor(diff/60)}m`;
        if(diff < 86400) return `${Math.floor(diff/3600)}h`;
        let d = Math.floor(diff/86400); let h = Math.floor((diff%86400)/3600);
        return `${d}d ${h}h`;
    }

    function inicializarMenuColumnas() {
        let menuHtml = '';
        colOrder.forEach((k, index) => {
            let checked = !hiddenCols[k] ? 'checked' : '';
            let btnUp = index > 0 ? `<i class="fa-solid fa-arrow-up mx-1 text-primary cp fs-6" title="Mover Izquierda" onclick="moverColumna(${index}, -1)"></i>` : `<i class="fa-solid fa-arrow-up mx-1 text-muted fs-6" style="opacity:0.2"></i>`;
            let btnDown = index < colOrder.length - 1 ? `<i class="fa-solid fa-arrow-down mx-1 text-primary cp fs-6" title="Mover Derecha" onclick="moverColumna(${index}, 1)"></i>` : `<i class="fa-solid fa-arrow-down mx-1 text-muted fs-6" style="opacity:0.2"></i>`;
            menuHtml += `<li class="dropdown-item d-flex justify-content-between align-items-center py-1 px-3 border-bottom">
                            <label class="cp mb-0 flex-grow-1"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('${k}', this.checked)" ${checked}> <span style="font-size:0.7rem; font-weight:bold;">${columnasDef[k].titulo}</span></label>
                            <div class="d-flex bg-white rounded border px-2 py-1 shadow-sm">${btnUp}${btnDown}</div>
                        </li>`;
        });
        document.getElementById('column-toggles').innerHTML = menuHtml;
        Object.keys(hiddenCols).forEach(k => toggleCol(k, !hiddenCols[k], false));
    }

    function moverColumna(idx, dir) {
        if(idx + dir < 0 || idx + dir >= colOrder.length) return;
        let temp = colOrder[idx]; colOrder[idx] = colOrder[idx + dir]; colOrder[idx + dir] = temp;
        localStorage.setItem('tms_colOrder', JSON.stringify(colOrder));
        inicializarMenuColumnas(); renderizarBitacora();
    }

    function toggleCol(colClass, isVisible, save = true) {
        if(save) { hiddenCols[colClass] = !isVisible; localStorage.setItem('tms_hiddenCols', JSON.stringify(hiddenCols)); }
        document.querySelectorAll('.' + colClass).forEach(el => { if(isVisible) el.classList.remove('d-none'); else el.classList.add('d-none'); });
    }
    
    function resetColumnas() {
        localStorage.removeItem('tms_colOrder'); localStorage.removeItem('tms_hiddenCols'); localStorage.removeItem('tms_colWidths'); location.reload();
    }

    function aplicarAnchosGuardados() {
        let savedWidths;
        try { savedWidths = JSON.parse(localStorage.getItem('tms_colWidths')) || {}; } catch(e) { savedWidths = {}; }
        let css = '';
        Object.keys(columnasDef).forEach(c => {
            let w = savedWidths[c] || columnasDef[c].ancho;
            css += `.${c} { width: ${w}px !important; min-width: ${w}px !important; max-width: ${w}px !important; }\n`;
        });
        let styleEl = document.getElementById('dynamic-col-styles');
        if(!styleEl) { styleEl = document.createElement('style'); styleEl.id = 'dynamic-col-styles'; document.head.appendChild(styleEl); }
        styleEl.innerHTML = css;
    }

    let isResizing = false; let currentTh = null; let startX = 0; let startWidth = 0;
    document.addEventListener('mousedown', function(e) {
        if (e.target.classList.contains('resizer')) {
            isResizing = true; currentTh = e.target.parentElement; startX = e.pageX; startWidth = currentTh.offsetWidth;
            e.target.classList.add('resizing'); document.body.style.userSelect = 'none';
        }
    });
    document.addEventListener('mousemove', function(e) {
        if (isResizing && currentTh) {
            let newWidth = Math.max(60, startWidth + (e.pageX - startX));
            let colClass = Array.from(currentTh.classList).find(c => c.startsWith('col-'));
            if(colClass) {
                let liveStyle = document.getElementById('live-resize-style');
                if(!liveStyle) { liveStyle = document.createElement('style'); liveStyle.id = 'live-resize-style'; document.head.appendChild(liveStyle); }
                liveStyle.innerHTML = `.${colClass} { width: ${newWidth}px !important; min-width: ${newWidth}px !important; max-width: ${newWidth}px !important; }`;
            }
        }
    });
    document.addEventListener('mouseup', function(e) {
        if (isResizing) {
            isResizing = false; let colClass = Array.from(currentTh.classList).find(c => c.startsWith('col-'));
            if (colClass) {
                let savedWidths;
                try { savedWidths = JSON.parse(localStorage.getItem('tms_colWidths')) || {}; } catch(err) { savedWidths = {}; }
                savedWidths[colClass] = currentTh.offsetWidth; localStorage.setItem('tms_colWidths', JSON.stringify(savedWidths));
                aplicarAnchosGuardados();
                let liveStyle = document.getElementById('live-resize-style'); if(liveStyle) liveStyle.innerHTML = '';
            }
            document.querySelectorAll('.resizer').forEach(r => r.classList.remove('resizing'));
            currentTh = null; document.body.style.userSelect = '';
        }
    });

    function getHeadersRow(cId) {
        let html = `<tr class="header-columnas shadow-sm client-group-${cId}">`;
        colOrder.forEach((c) => {
            let titulo = columnasDef[c].titulo; let display = hiddenCols[c] ? 'd-none' : ''; 
            html += `<th class="${c} ${display} position-relative">
                        <div class="d-flex justify-content-center align-items-center h-100 px-1"><span class="text-center">${titulo}</span></div>
                        <div class="resizer" title="Arrastrar para cambiar tamaÃ±o"></div>
                    </th>`;
        });
        return html + `</tr>`;
    }

    function initMap() { 
        lmap = L.map('map').setView([23.6, -102.5], 5); 
        L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(lmap); 
        mapLayerGroup = L.layerGroup().addTo(lmap); geofenceLayerGroup = L.layerGroup().addTo(lmap);
    }
    
    function toggleMap() { 
        document.getElementById("mainWorkspace").classList.toggle("show-map"); 
        if(!lmap) initMap(); mapVisible = !mapVisible; 
        setTimeout(() => { if(lmap) { lmap.invalidateSize(); actualizarMarcadoresMapa(); pintarGeocercasEnMapa(); } }, 400); 
    }
    
    window.clickMapaUnidad = function(vId) {
        let v = viajesActivos[vId]; if(!v) return alert("Unidad no encontrada.");
        let uData = encontrarUnidad(v, vId);
        if(uData && uData.pos && uData.pos.y) {
            centrarUnidadMapa(uData.pos.y, uData.pos.x, vId);
        } else {
            alert("Esta unidad no tiene coordenadas GPS vÃ¡lidas en este momento.");
        }
    };

    function centrarUnidadMapa(lat, lon, vId) { 
        if(!mapVisible) toggleMap(); 
        setTimeout(() => { 
            if(lmap) {
                lmap.flyTo([lat, lon], 16, { animate: true, duration: 1.5 });
                if(vId && mapaMarcadores[vId]) { setTimeout(() => { mapaMarcadores[vId].openPopup(); }, 1500); }
            }
        }, 400); 
    }

    function actualizarMarcadoresMapa() {
        if(!lmap || !mapLayerGroup) return; 
        mapLayerGroup.clearLayers(); mapaMarcadores = {}; 
        
        Object.keys(viajesActivos).forEach(vId => {
            let v = viajesActivos[vId]; if(typeof v !== 'object' || !v) return;
            let uData = encontrarUnidad(v, vId);
            if(uData && uData.pos) {
                let isMoving = uData.pos.s > 0;
                let colorIcon = isMoving ? '#10b981' : '#0ea5e9';
                
                // RESTA DE 45 GRADOS PARA QUE EL ICONO DE FLECHA APUNTE EXACTO AL RUMBO
                let course = uData.pos.c || 0; let correctedCourse = isMoving ? (course - 45) : course;
                
                let markerHtml = isMoving 
                    ? `<div style="transform: rotate(${correctedCourse}deg); color: ${colorIcon}; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;"><i class="fa-solid fa-location-arrow" style="margin-top:-5px; margin-left:-5px;"></i></div>` 
                    : `<div style="color: ${colorIcon}; font-size: 24px; text-shadow: 0 2px 4px rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; width: 100%; height: 100%;"><i class="fa-solid fa-location-dot" style="margin-top:-5px; margin-left:-5px;"></i></div>`;
                let customIcon = L.divIcon({ html: markerHtml, className: '', iconSize: [24, 24], iconAnchor: [12, 12] });
                
                let vel = uData.pos.s; let est = window.estatusData[v.estatus]?.nombre || "En Trayecto";
                let operador = v.operador || (uData.choferObj && uData.choferObj.nombre !== "Sin asignar" ? uData.choferObj.nombre : "Sin Operador");

                let popupContent = `
                    <div style="text-align:center; min-width: 160px; font-family: 'Inter', sans-serif;">
                        <b style="font-size:15px; color:#0f172a; text-transform:uppercase;">${uData.name}</b><br>
                        <span style="font-size:11px; color:#64748b; font-weight:bold;">${operador}</span><br>
                        <div style="margin-top:5px; margin-bottom:5px; background:${isMoving?'#10b981':'#64748b'}; color:white; border-radius:4px; padding:2px; font-weight:bold; font-size:12px;">${vel} km/h</div>
                        <b style="font-size:11px; color:#0284c7;">${est}</b><br>
                        <span style="color:#94a3b8; font-size:10px;">Act: hace ${timeAgo(uData.pos.t)}</span>
                    </div>`;
                let marker = L.marker([uData.pos.y, uData.pos.x], {icon: customIcon}).bindPopup(popupContent, {className: 'custom-popup'}).addTo(mapLayerGroup);
                mapaMarcadores[vId] = marker;
            }
        });
    }

    function pintarGeocercasEnMapa() {
        if(!lmap || !geofenceLayerGroup) return; geofenceLayerGroup.clearLayers();
        geocercasNativas.forEach(z => {
            let colorHex = z.c ? `#${z.c.toString(16).padStart(6, '0')}` : '#3b82f6';
            if(z.t === 3 && z.p && z.p[0]) L.circle([z.p[0].y, z.p[0].x], {radius: z.p[0].r, color: colorHex, weight: 2, fillOpacity: 0.15}).bindTooltip(z.n).addTo(geofenceLayerGroup);
            else if((z.t === 1 || z.t === 2) && z.p) L.polygon(z.p.map(pt => [pt.y, pt.x]), {color: colorHex, weight: 2, fillOpacity: 0.15}).bindTooltip(z.n).addTo(geofenceLayerGroup);
        });
    }

    function cambiarEstatus(val, vId) {
        let txt = window.estatusData[val].nombre; let col = window.estatusData[val].col;
        let row = document.getElementById("row_" + vId);
        if(row && !row.classList.contains("external-connection-row") && !row.classList.contains("stale-row")) { row.style.setProperty('background-color', hexToRgba(col, 0.05), 'important'); }
        registrarLog(vId, 'CambiÃ³ estatus a', txt); db.ref('viajes_activos/'+vId+'/estatus').set(val);
    }

    function enviarWA(vId) {
        let v = viajesActivos[vId]; if(!v) return;
        let uData = encontrarUnidad(v, vId); let nombreCamion = String(v.unidadN || v.unidadFallback || "Desconocida").trim().toUpperCase();
        let estNombre = window.estatusData[v.estatus]?.nombre || "En Trayecto"; let pos = uData ? uData.pos : null; let speed = pos ? pos.s : 0;
        
        let cliId = v.cliente || "Sin_Cliente"; let subId = v.subcliente || "N/A";
        let cliName = (dataClientes[cliId] && dataClientes[cliId].nombre) ? dataClientes[cliId].nombre : "SIN CLIENTE";
        let subName = (dataClientes[cliId] && dataClientes[cliId].subclientes && dataClientes[cliId].subclientes[subId]) ? dataClientes[cliId].subclientes[subId].nombre : "";
        let subText = subName && subName !== "N/A" ? ` -> ${subName}` : '';
        
        let addrText = v.ubicacion_manual || "Buscando..."; let locLink = addrText; let geoTextWA = "";

        if (pos) {
            let zonaGeo = (uData && uData.zonaOficial) ? uData.zonaOficial : resolverGeocerca(pos.y, pos.x);
            if(zonaGeo) geoTextWA = `\nðŸ“ *Geocerca:* ${zonaGeo}`;
            let domAddr = document.getElementById("addr_" + vId);
            if(domAddr && domAddr.innerText !== "Buscando...") { addrText = domAddr.innerText.trim(); } else { addrText = "UbicaciÃ³n GPS"; }
            locLink = `${addrText} \nhttps://www.google.com/maps?q=${pos.y},${pos.x}`;
        }

        let text = `*GRUDICOM TI & GPS - REPORTE DE UNIDAD*\n\nðŸ¢ *Cliente:* ${cliName}${subText}\n\nðŸš› *Unidad:* ${nombreCamion}\nðŸ“¦ *Contenedores:* ${v.contenedores||'N/A'}\nðŸ›£ï¸ *Ruta:* ${v.origen||'N/A'} âž” ${v.destino||'N/A'}\nðŸš¦ *Estatus:* ${estNombre}\nâ±ï¸ *Vel:* ${speed} km/h${geoTextWA}\nðŸ“ *UbicaciÃ³n:* ${locLink}\n\n_Reporte C4_`;
        window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(text)}`, '_blank'); 
    }

    function generarReporteGrupal(cId, sId, titulo) {
        if(!datosAgrupadosGlobal[cId] || !datosAgrupadosGlobal[cId][sId]) return;
        let arrViajes = datosAgrupadosGlobal[cId][sId];
        let txt = `*GRUDICOM TI & GPS - REPORTE DE FLOTA*\nðŸ¢ *${titulo}*\n\n`;
        arrViajes.forEach(({v, vId}) => {
            let uData = encontrarUnidad(v, vId); let name = String(v.unidadN || v.unidadFallback || "Desconocida").trim().toUpperCase();
            let est = window.estatusData[v.estatus]?.nombre || "En Trayecto"; let pos = uData ? uData.pos : null; let vel = pos ? pos.s : 0;
            let addrText = v.ubicacion_manual || "Manual"; let locLink = addrText; let geoTextWA = "";
            if (pos) {
                let zonaGeo = (uData && uData.zonaOficial) ? uData.zonaOficial : resolverGeocerca(pos.y, pos.x);
                if(zonaGeo) geoTextWA = `\nðŸ“ *Geocerca:* ${zonaGeo}`;
                locLink = `https://www.google.com/maps?q=${pos.y},${pos.x}`;
            }
            txt += `ðŸš› *Unidad:* ${name}\nðŸ“¦ *Contenedores:* ${v.contenedores||'N/A'}\nâ±ï¸ *Vel:* ${vel} km/h\nðŸš¦ *Estatus:* ${est}\nðŸ *Ruta:* ${v.origen||'N/A'} âž” ${v.destino||'N/A'}${geoTextWA}\nðŸ“ *UbicaciÃ³n:* ${locLink}\n\n`;
        });
        txt += `_Reporte C4_`; window.open(`https://api.whatsapp.com/send?text=${encodeURIComponent(txt)}`, '_blank');
    }

    async function generarCapturaCliente(cId, cliName) {
        let tableWrap = document.getElementById('scrollContainer');
        let allRows = document.querySelectorAll('#units-body tr');
        let hiddenRows = [];
        
        allRows.forEach(r => {
            if(!r.classList.contains(`client-group-${cId}`)) {
                hiddenRows.push({el: r, display: r.style.display});
                r.style.display = 'none';
            }
        });
        
        let oldHeight = tableWrap.style.height; let oldMaxHeight = tableWrap.style.maxHeight; let oldOverflow = tableWrap.style.overflow;
        tableWrap.style.height = 'auto'; tableWrap.style.maxHeight = 'none'; tableWrap.style.overflow = 'visible';
        let oldW = document.getElementById("mainTable").style.width; document.getElementById("mainTable").style.width = "max-content";

        await new Promise(r => setTimeout(r, 400));
        
        try {
            let canvas = await html2canvas(document.getElementById('mainTable'), { scale: 2, backgroundColor: '#ffffff', useCORS: true });
            
            canvas.toBlob(function(blob) {
                currentCaptureBlob = blob;
                document.getElementById('imgPreviewCaptura').src = URL.createObjectURL(blob);
                new bootstrap.Modal(document.getElementById('modalPreviewCaptura')).show();
            }, 'image/png');
            
        } catch(e) { console.error(e); alert("Error al generar captura de pantalla."); } 
        finally {
            tableWrap.style.height = oldHeight; tableWrap.style.maxHeight = oldMaxHeight; tableWrap.style.overflow = oldOverflow;
            document.getElementById("mainTable").style.width = oldW;
            hiddenRows.forEach(item => item.el.style.display = item.display);
        }
    }

    function descargarCaptura() {
        if(!currentCaptureBlob) return;
        let link = document.createElement('a'); link.download = `Estatus_Bitacora.png`; link.href = URL.createObjectURL(currentCaptureBlob); link.click();
    }

    async function copiarCaptura() {
        if(!currentCaptureBlob) return;
        try { const item = new ClipboardItem({ "image/png": currentCaptureBlob }); await navigator.clipboard.write([item]); alert("Â¡Imagen copiada! PÃ©gala en WhatsApp (Ctrl+V).");
        } catch (err) { alert("Tu navegador no permite copiar directo. Usa el botÃ³n Descargar."); }
    }

    async function compartirCaptura() {
        if(!currentCaptureBlob) return;
        if (navigator.share) {
            try { const file = new File([currentCaptureBlob], "Estatus.png", { type: "image/png" }); await navigator.share({ title: 'Estatus BitÃ¡cora', files: [file] }); } catch (err) { }
        } else { alert("Tu navegador no soporta compartir directo."); }
    }

    function editarUbicacionManual(vId) {
        let v = viajesActivos[vId]; if(!v) return;
        let uName = String(v.unidadN || v.unidadFallback || "Desconocida").trim().toUpperCase();
        let u = prompt(`Escribir ubicaciÃ³n manual para ${uName}:`, v.ubicacion_manual || '');
        if(u !== null) { db.ref(`viajes_activos/${vId}/ubicacion_manual`).set(String(u).toUpperCase()); registrarLog(vId, 'AÃ±adiÃ³ UbicaciÃ³n Manual', String(u).toUpperCase()); }
    }

    function registrarLog(viajeId, accion, detalle = "") { let usrName = currentUser ? currentUser.nom : "Sistema"; db.ref(`viajes_activos/${viajeId}/log`).push({ t: Date.now(), usr: usrName, act: accion, det: detalle }); }

    function abrirModalAcciones(vId, uName) {
        document.getElementById("acc_vId").value = vId; document.getElementById("acc_uName").innerText = uName; new bootstrap.Modal(document.getElementById('modalAcciones')).show();
    }
    
    function ejecutarAccion(tipo) {
        let vId = document.getElementById("acc_vId").value; let uName = document.getElementById("acc_uName").innerText;
        try { bootstrap.Modal.getInstance(document.getElementById('modalAcciones')).hide(); } catch(e){}
        setTimeout(() => { if(tipo === 'edit') abrirEdicionViaje(vId, uName); else if(tipo === 'arch') finalizarViaje(vId, uName); }, 300);
    }

    window.onload = function () {
        aplicarAnchosGuardados();
        inicializarMenuColumnas();
        
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; actualizarListasAdmin(); renderizarBitacora(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; renderizarBitacora(); if(mapVisible) actualizarMarcadoresMapa(); });
        db.ref('sistema/tokens').on('value', s => { let tks = s.val() || {}; configSistema.tokens = Object.values(tks); actualizarListaTokensAdmin(tks); if(currentUser && !motorArrancado) arranqueMotor(); });
        
        document.getElementById("logPass").addEventListener("keyup", e => e.key === "Enter" && autenticarUsuario());
        let sU = localStorage.getItem("tms_user"), sP = localStorage.getItem("tms_pass"); if(sU && sP) autenticarUsuario(sU, sP);
        setInterval(procesarFilaDirecciones, 1100); 
    };

    function autenticarUsuario(aU, aP) {
        const u = (typeof aU === 'string' ? aU : null) || document.getElementById("logUser").value.trim(); 
        const p = (typeof aP === 'string' ? aP : null) || document.getElementById("logPass").value.trim(); 
        if(!u || !p) return;
        document.getElementById("status").innerText = "Conectando..."; document.getElementById("status").className = "mt-3 small fw-bold text-primary";
        
        db.ref(`sistema/usuarios/${u}`).once('value').then(s => {
            let user = s.val(); if(!user && u === "admin" && p === "admin123") user = { pass: "admin123", rol: "admin", nom: "Administrador Maestro" };
            if(user && user.pass === p) {
                currentUser = user; localStorage.setItem("tms_user", u); localStorage.setItem("tms_pass", p);
                document.getElementById("loginOverlay").style.display = "none"; document.getElementById("dashboard").style.display = "flex";
                document.getElementById("lblUsuarioActivo").innerHTML = "<i class='fa-solid fa-user-shield me-1'></i> Monitor: " + currentUser.nom;
                if(currentUser.rol === "admin") document.getElementById("btnAdminMenu").style.display = "block";
                if(!motorArrancado) arranqueMotor();
            } else { document.getElementById("status").innerText = "Credenciales Incorrectas"; document.getElementById("status").className = "mt-3 small fw-bold text-danger"; }
        }).catch(err => { document.getElementById("status").innerText = "Error de red."; document.getElementById("status").className = "mt-3 small fw-bold text-danger"; });
    }

    function peticionWialon(url, svc, params, sid=null) {
        return new Promise(resolve => {
            let script = document.createElement("script"); let cb = "wialon_cb_" + Date.now() + Math.floor(Math.random()*1000);
            let timeout = setTimeout(() => { delete window[cb]; script.remove(); resolve(null); }, 8000);
            window[cb] = d => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(d); };
            script.onerror = () => { clearTimeout(timeout); delete window[cb]; script.remove(); resolve(null); };
            script.src = `${url.replace(/\/$/, '')}/wialon/ajax.html?svc=${svc}&params=${encodeURIComponent(JSON.stringify(params))}&callback=${cb}${sid?'&sid='+sid:''}`; document.head.appendChild(script);
        });
    }

    async function arranqueMotor() { if(pollingInterval) clearInterval(pollingInterval); motorArrancado = true; await sincronizarFlotas(); pollingInterval = setInterval(sincronizarFlotas, 20000); }
    
    function renderStatusTokens() {
        const lista = document.getElementById("listaStatusTokens"); let html = "";
        for(let tk in estadoTokens) { let stat = estadoTokens[tk]; let badge = stat.status === 'OK' ? '<span class="badge bg-success shadow-sm">ONLINE</span>' : '<span class="badge bg-danger shadow-sm">OFFLINE</span>'; html += `<li class="list-group-item d-flex justify-content-between align-items-center p-2"><div class="fw-bold" style="font-size:0.8rem;">${tk}</div> <div><span class="badge bg-secondary me-2 shadow-sm">${stat.count} Unidades</span> ${badge}</div></li>`; }
        lista.innerHTML = html || '<li class="list-group-item text-center">No hay tokens</li>';
    }

    async function sincronizarFlotas() {
        if(isSyncingFlotas) return; isSyncingFlotas = true;
        try {
            let indMenu = document.getElementById("menuSyncIndicator"); if(indMenu) indMenu.innerHTML = `<i class="fa-solid fa-satellite-dish text-warning"></i> Sincronizando...`;
            estadoTokens = {}; let tempUnits = {}, tempGeo = [], listUni = new Set(); let conexionesExitosas = 0;

            let promesas = configSistema.tokens.map(async (tk) => {
                try {
                    if(!tk.url || !tk.token) return;
                    if(!activeSIDs[tk.token]) { let l = await peticionWialon(tk.url, "token/login", {token: tk.token}); if(l && l.eid) activeSIDs[tk.token] = { sid: l.eid }; }
                    let auth = activeSIDs[tk.token]; if(!auth || !auth.sid) { estadoTokens[tk.nombre] = { status: 'ERR', count: 0 }; return; }

                    let reqR = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 1 + 256 + 4096, from: 0, to: 4294967295 }, auth.sid);
                    let diccChoferes = {}; let diccZonasReq = {}; let diccZonasNombres = {};

                    if(reqR && reqR.items) {
                        reqR.items.forEach(r => { 
                            let rId = r.id; diccZonasReq[rId] = []; diccZonasNombres[rId] = {};
                            if(r.zl) { Object.values(r.zl).forEach(z => { diccZonasReq[rId].push(z.id); diccZonasNombres[rId][z.id] = z.n; tempGeo.push(z); }); }
                            if(r.drvrs || r.drv) {
                                let drivers = r.drvrs || r.drv;
                                Object.values(drivers).forEach(d => { 
                                    if(d.bu && d.bu > 0) { 
                                        let telStr = d.p ? String(d.p) : ""; 
                                        diccChoferes[d.bu] = { nombre: d.n, tel: telStr, cod: d.c || "---", rid: rId }; 
                                    } 
                                }); 
                            }
                        });
                    }

                    let reqU = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 1 + 1024, from: 0, to: 4294967295 }, auth.sid);
                    if(reqU && reqU.items) {
                        conexionesExitosas++; estadoTokens[tk.nombre] = { status: 'OK', count: reqU.items.length };
                        let uIds = reqU.items.map(u => u.id); let checkGeo = {};
                        if(uIds.length > 0) checkGeo = await peticionWialon(tk.url, "resource/get_zones_by_unit", { spec: { zoneId: diccZonasReq, units: uIds, time: 0 } }, auth.sid);

                        reqU.items.forEach(u => { 
                            let n = String(u.nm || "Desconocida").toUpperCase(); 
                            let chofer = diccChoferes[u.id] || { nombre: "Sin asignar", tel: "", cod: "---", rid: null };
                            let miZona = null; let recursoDueÃ±o = chofer.rid ? chofer.rid : u.bact;
                            
                            if (recursoDueÃ±o && checkGeo && checkGeo[recursoDueÃ±o]) {
                                for (let zId in checkGeo[recursoDueÃ±o]) { if (checkGeo[recursoDueÃ±o][zId].includes(u.id)) { miZona = diccZonasNombres[recursoDueÃ±o][zId]; break; } }
                            } else if (checkGeo) {
                                for (let rId in checkGeo) {
                                    for (let zId in checkGeo[rId]) { if (checkGeo[rId][zId].includes(u.id)) { miZona = diccZonasNombres[rId][zId]; break; } }
                                    if (miZona) break;
                                }
                            }
                            tempUnits[u.id] = { id: u.id, name: n, pos: u.pos, choferObj: chofer, zonaOficial: miZona }; listUni.add(n); 
                        });
                    } else { estadoTokens[tk.nombre] = { status: 'ERR', count: 0 }; }
                } catch(errTk) { console.error("Token FallÃ³:", tk.nombre); }
            });

            await Promise.all(promesas); 
            unidadesGlobales = tempUnits; geocercasNativas = tempGeo;
            document.getElementById("listaUnidadesTotales").innerHTML = Array.from(listUni).map(n => `<option value="${n}">`).join('');
            document.getElementById("listaGeocercas").innerHTML = tempGeo.map(z => `<option value="${String(z.n).toUpperCase()}">`).join('');
            
            let indMenu = document.getElementById("menuSyncIndicator");
            if(indMenu) {
                if(conexionesExitosas > 0) indMenu.innerHTML = `<span class="badge bg-success shadow-sm rounded-pill py-1 px-2">${Object.keys(unidadesGlobales).length} Camiones Live</span>`;
                else indMenu.innerHTML = `<span class="badge bg-danger shadow-sm rounded-pill py-1 px-2">Error GPS - Offline</span>`;
            }
            renderStatusTokens(); inyectarGPSenTabla(); 
            if(mapVisible) { actualizarMarcadoresMapa(); pintarGeocercasEnMapa(); }
        } catch(errSync) { console.error("Error Global:", errSync); } finally { isSyncingFlotas = false; }
    }

    function inyectarGPSenTabla() {
        Object.keys(viajesActivos).forEach(vId => {
            try {
                let v = viajesActivos[vId]; if(typeof v !== 'object' || !v) return;
                let uData = encontrarUnidad(v, vId); let isExternal = v.wialonId === "EXTERNO"; 
                let pos = uData ? uData.pos : null; let speed = pos ? pos.s : 0; 
                let isLost = !uData || (uData && !pos && !isExternal);
                
                let ageSecs = pos ? Math.floor(Date.now()/1000) - pos.t : 0;
                let isStale = ageSecs > 14400; // Zombie > 4h
                
                let row = document.getElementById("row_" + vId);
                if(row) {
                    row.classList.remove("lost-connection-row", "stale-row");
                    if(isLost && !isExternal) row.classList.add("lost-connection-row");
                    else if (isStale && !isExternal) row.classList.add("stale-row");
                }

                let elGpsCell = document.getElementById("gps_cell_" + vId);
                if(elGpsCell) {
                    if (isExternal) {
                        elGpsCell.innerHTML = `<div class="d-flex flex-column px-1 w-100"><div class="d-flex justify-content-between align-items-center pb-1 border-bottom border-light mb-1"><div class="d-flex align-items-center"><i class="fa-solid fa-globe text-info me-1 fs-6"></i> <span class="speed-badge bg-secondary m-0">-- km/h</span></div><div style="font-size:0.65rem; color:#64748b; font-weight:800;">Externa</div></div><div class="d-flex align-items-center gap-2 text-start"><span class="text-info fw-bold" style="font-size:0.65rem;">GPS EXTERNO</span><i class="fa-solid fa-pencil ms-2 text-primary cp" title="Editar" onclick="editarUbicacionManual('${vId}')"></i><div class="addr-container flex-grow-1">${v.ubicacion_manual||'--'}</div></div></div>`;
                    } else if (isLost) {
                        elGpsCell.innerHTML = `<div class="d-flex flex-column px-1 w-100"><div class="d-flex justify-content-between align-items-center pb-1 border-bottom border-danger mb-1"><div class="d-flex align-items-center"><i class="fa-solid fa-triangle-exclamation text-danger me-1 fs-6"></i> <span class="speed-badge bg-secondary m-0">${speed} km/h</span></div><div style="font-size:0.65rem; color:#ef4444; font-weight:800;">Modo Offline</div></div><div class="d-flex align-items-center gap-2 text-start"><span class="text-danger fw-bold" style="font-size:0.65rem;">SIN SEÃ‘AL</span><i class="fa-solid fa-pencil ms-2 text-primary cp" title="Editar" onclick="editarUbicacionManual('${vId}')"></i><div class="addr-container flex-grow-1">${v.ubicacion_manual||'--'}</div></div></div>`;
                    } else {
                        let speedBg = "#64748b"; if(speed > 0 && speed < 100) speedBg = "#10b981"; if(speed >= 100) speedBg = "#ef4444"; 
                        if(isStale) speedBg = "#ef4444"; 
                        let icon = speed > 0 ? `<i class="fa-solid fa-truck-fast text-success me-1 fs-6"></i>` : `<i class="fa-solid fa-truck text-secondary me-1 fs-6"></i>`;
                        let timeColor = isStale ? 'text-danger' : 'text-primary';
                        
                        let geoKey = `${pos.y.toFixed(4)}_${pos.x.toFixed(4)}`;
                        let zonaGeo = (uData && uData.zonaOficial) ? uData.zonaOficial : resolverGeocerca(pos.y, pos.x);
                        let addrText = `<i class="fa-solid fa-spinner fa-spin text-muted"></i> Buscando...`;
                        if(geocodeCache[geoKey]) addrText = `<i class="fa-solid fa-map-location-dot text-primary me-1"></i>${geocodeCache[geoKey]}`;
                        
                        let geoHtml = zonaGeo ? `<span class="badge-geo text-truncate ms-2" style="max-width:150px;" title="${zonaGeo}"><i class="fa-solid fa-draw-polygon me-1"></i>${zonaGeo}</span>` : '';
                        let timeHover = formatTimeFriendly(pos.t);
                        
                        elGpsCell.innerHTML = `
                            <div class="d-flex flex-column px-1 w-100">
                                <div class="d-flex justify-content-between align-items-center pb-1 border-bottom border-light mb-1">
                                    <div class="d-flex align-items-center">
                                        ${icon} <span class="speed-badge m-0" style="background-color:${speedBg}; padding:2px 6px;">${speed} km/h</span>
                                        ${geoHtml}
                                    </div>
                                    <div style="font-size:0.75rem; font-weight:900; cursor:help;" title="${timeHover}">
                                        <span class="${timeColor}">(${timeAgo(pos.t)})</span>
                                    </div>
                                </div>
                                <div class="d-flex align-items-center w-100">
                                    <a href="https://www.google.com/maps?q=$${pos.y},${pos.x}" target="_blank" class="addr-link text-start flex-grow-1" title="Abrir en Maps">
                                        <div class="addr-container addr-span-${geoKey}" id="addr_${vId}">${addrText}</div>
                                    </a>
                                </div>
                            </div>
                        `;
                    }
                }

                let btnName = document.getElementById("name_btn_" + vId);
                if (btnName && pos && pos.y && pos.x) {
                    btnName.setAttribute("onclick", `centrarUnidadMapa(${pos.y}, ${pos.x}, '${vId}')`);
                } else if (btnName) {
                    btnName.setAttribute("onclick", `centrarUnidadMapa(null, null)`);
                }

                let wialonDriverObj = uData ? uData.choferObj : null;
                let elOpWialon = document.getElementById("op_wialon_" + vId);
                if (elOpWialon) {
                    if (wialonDriverObj && wialonDriverObj.nombre !== "Sin asignar") {
                        let telRaw = wialonDriverObj.tel || ""; let cleanTel = String(telRaw).replace(/\D/g,'');
                        let waBtn = cleanTel ? `<div class="d-flex align-items-center justify-content-center mt-1 bg-white border rounded px-1 shadow-sm" style="width:fit-content; margin:0 auto;"><a href="https://wa.me/${cleanTel}" target="_blank" class="text-success fs-5 me-2 cp" title="Abrir WhatsApp"><i class="fab fa-whatsapp"></i></a><span class="fw-bold" style="font-size:0.75rem; color:#334155; user-select:all;">${telRaw}</span></div>` : '';
                        elOpWialon.innerHTML = `<div class="fw-bold text-truncate text-uppercase" style="font-size:0.75rem; color:#0f172a;"><i class="fa-solid fa-id-card text-muted me-1"></i>${wialonDriverObj.nombre}</div>${waBtn}`;
                    } else if (v.operador) {
                        elOpWialon.innerHTML = `<div class="fw-bold text-truncate text-uppercase" style="font-size:0.75rem; color:#0f172a;"><i class="fa-solid fa-id-card text-muted me-1"></i>${v.operador}</div><div style="font-size:0.6rem; color:#64748b;">(Manual)</div>`;
                    } else { 
                        elOpWialon.innerHTML = '<span class="badge bg-secondary w-100 mt-1" style="font-size:0.65rem;">Sin asignar</span>'; 
                    }
                }
                
                let elAlertas = document.getElementById("alertas_" + vId);
                if (elAlertas) { elAlertas.innerHTML = v.alerta ? `<span class="text-danger fw-bold" style="font-size:0.85rem;">${v.alerta.txt}</span>` : `<span class="text-success fw-bold" style="font-size:0.85rem;">OK</span>`; }

            } catch(e) { console.error("Error GPS:", vId, e); }
        });
        desencadenarGeocoding();
    }

    function desencadenarGeocoding() {
        Object.keys(viajesActivos).forEach(vId => {
            let v = viajesActivos[vId]; if(typeof v !== 'object' || !v) return; let uData = encontrarUnidad(v, vId); 
            if(uData && uData.pos) {
                let zonaGeo = (uData && uData.zonaOficial) ? uData.zonaOficial : resolverGeocerca(uData.pos.y, uData.pos.x);
                if(zonaGeo && v.destino && !v.t_arribo && zonaGeo.toUpperCase().includes(String(v.destino).toUpperCase())) {
                    db.ref('viajes_activos/'+vId+'/t_arribo').set(Date.now()); registrarLog(vId, 'Arribo AutomÃ¡tico (Geocerca)');
                }
                let geoKey = `${uData.pos.y.toFixed(4)}_${uData.pos.x.toFixed(4)}`;
                if(!geocodeCache[geoKey] && !geoQueue.find(i => i.key === geoKey)) { geoQueue.push({ key: geoKey, y: uData.pos.y, x: uData.pos.x, vId: vId, dest: v.destino }); } 
                else if(geocodeCache[geoKey] && v.destino && !v.t_arribo && geocodeCache[geoKey].toUpperCase().includes(String(v.destino).toUpperCase())) {
                    db.ref('viajes_activos/'+vId+'/t_arribo').set(Date.now()); registrarLog(vId, 'Arribo AutomÃ¡tico (CachÃ© GPS)');
                }
            }
        });
    }

    function procesarFilaDirecciones() {
        if(isGeocoding || geoQueue.length === 0) return; isGeocoding = true; let item = geoQueue.shift();
        fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${item.y}&lon=${item.x}&zoom=16`).then(r => r.json()).then(d => {
            let a = d.display_name || "Sin direcciÃ³n"; geocodeCache[item.key] = a; localStorage.setItem('tms_geoCache', JSON.stringify(geocodeCache));
            document.querySelectorAll(`.addr-span-${item.key}`).forEach(span => span.innerHTML = `<i class="fa-solid fa-map-location-dot text-primary me-1"></i>${a}`);
            if(item.dest && a.toUpperCase().includes(String(item.dest).toUpperCase())) {
                let v = viajesActivos[item.vId]; if(v && !v.t_arribo) { db.ref('viajes_activos/'+item.vId+'/t_arribo').set(Date.now()); registrarLog(item.vId, 'Arribo AutomÃ¡tico (Calle)'); }
            }
        }).catch(e => console.log("Geo Err")).finally(() => { isGeocoding = false; });
    }

    function construirBotonHorario(vId, timestampStr, dbField, textoVacio, claseColor) {
        if(!timestampStr) {
            return `<button class="btn btn-sm w-100 bg-white text-${claseColor} shadow-sm" style="font-size:0.6rem; font-weight:800; padding:2px 0; margin-bottom:2px; border: 1px dashed var(--bs-${claseColor});" onclick="registrarLog('${vId}', 'MarcÃ³ ${textoVacio}'); db.ref('viajes_activos/${vId}/${dbField}').set(Date.now());">${textoVacio}</button>`;
        } else {
            let displayDate = formatearFechaElegante(timestampStr);
            return `<div class="position-relative w-100 cp" style="margin-bottom:2px;" title="Clic para editar">
                        <div class="d-flex align-items-center rounded shadow-sm border border-${claseColor}" style="overflow: hidden; height:18px; background: rgba(255,255,255,0.8);">
                            <span class="bg-${claseColor} text-white fw-bold text-center d-flex align-items-center justify-content-center" style="font-size:0.55rem; width:18px; height:100%;">${textoVacio.charAt(0)}</span>
                            <span class="fw-bold text-center w-100 text-${claseColor}" style="font-size:0.6rem; line-height:18px;">${displayDate}</span>
                        </div>
                        <input type="datetime-local" class="position-absolute top-0 start-0 w-100 h-100 cp" style="opacity: 0;" value="${getLocalISO(timestampStr)}" onclick="this.showPicker()" onchange="let d=new Date(this.value).getTime(); if(d){ db.ref('viajes_activos/${vId}/${dbField}').set(d); registrarLog('${vId}', 'ModificÃ³ horario de ${textoVacio}'); }">
                    </div>`;
        }
    }

    function renderizarBitacora() {
        if(document.activeElement.tagName === "INPUT" || document.activeElement.tagName === "SELECT" || document.activeElement.tagName === "TEXTAREA") return;
        const tbody = document.getElementById('units-body'); let html = "";
        let tree = { "Sin_Cliente": { "N/A": [] } };
        
        Object.keys(dataClientes).forEach(cId => { tree[cId] = { "N/A": [] }; if(dataClientes[cId].subclientes) Object.keys(dataClientes[cId].subclientes).forEach(sId => tree[cId][sId] = []); });
        Object.keys(viajesActivos).forEach(vId => { 
            let v = viajesActivos[vId]; if(typeof v !== 'object' || !v) return; 
            let cId = String(v.cliente || "Sin_Cliente"); let sId = String(v.subcliente || "N/A"); 
            if(!tree[cId]) tree[cId] = { "N/A": [] }; if(!tree[cId][sId]) tree[cId][sId] = []; 
            tree[cId][sId].push({vId, v}); 
        });
        datosAgrupadosGlobal = tree; 

        for(let cId in tree) {
            let cliName = "SIN CLIENTE"; if (cId !== "Sin_Cliente" && dataClientes[cId] && dataClientes[cId].nombre) cliName = dataClientes[cId].nombre;
            
            let hasClientUnits = false;
            for(let sId in tree[cId]) { if(tree[cId][sId].length > 0) { hasClientUnits = true; break; } }
            if(!hasClientUnits) continue;

            let logoHtml = (cId !== "Sin_Cliente" && dataClientes[cId] && dataClientes[cId].logo) ? `<img src="${dataClientes[cId].logo}" class="client-logo ms-3" title="${cliName}">` : `<span class="align-middle ms-3 fw-bold text-white fs-4">ðŸ“¦ ${cliName}</span>`;
            
            let clientTitleHtml = `
                <div class="d-flex align-items-center justify-content-center">
                    <img src="TIGPS HD2.png" style="height:36px; margin-right:12px; filter: drop-shadow(0 2px 2px rgba(0,0,0,0.5));">
                    <div class="d-flex flex-column text-start border-end pe-3 border-secondary" style="border-opacity:0.3;">
                        <span style="font-size:0.6rem; color:#94a3b8; font-weight:900; letter-spacing:1px; line-height:1;">BITÃCORA DE VIAJES</span>
                        <span style="font-size:0.75rem; color:#f8fafc; font-weight:900; line-height:1.2; margin-top:2px;">GRUDICOM TI & GPS</span>
                    </div>
                    ${logoHtml}
                </div>
            `;
            
            // BOTONES DE REPORTE SUTILES
            let btnWaCli = cId !== "Sin_Cliente" ? `
                <div class="d-flex align-items-center gap-2">
                    <button class="btn btn-outline-light btn-sm rounded-circle shadow-sm cp" style="width:34px; height:34px;" title="Captura de Estatus" onclick="generarCapturaCliente('${cId}', '${cliName}')"><i class="fa-solid fa-camera"></i></button> 
                    <button class="btn btn-outline-success btn-sm rounded-circle shadow-sm cp" style="width:34px; height:34px; background:white;" title="Enviar Reporte por WhatsApp" onclick="generarReporteGrupal('${cId}', 'N/A', '${cliName}')"><i class="fa-brands fa-whatsapp"></i></button>
                </div>` : '';
            
            html += `<tr class="header-cliente shadow-sm client-group-${cId}" data-client="${cId}"><td colspan="${colOrder.length}"><div class="d-flex justify-content-between align-items-center position-relative w-100">${clientTitleHtml}<div class="position-absolute end-0 pe-2 d-flex">${btnWaCli}</div></div></td></tr>`;

            for(let sId in tree[cId]) {
                if(tree[cId][sId].length === 0) continue;
                let subName = ""; if (sId !== "N/A" && dataClientes[cId] && dataClientes[cId].subclientes && dataClientes[cId].subclientes[sId]) subName = dataClientes[cId].subclientes[sId].nombre || "";
                
                let logoHtmlSub = (cId !== "Sin_Cliente" && dataClientes[cId] && dataClientes[cId].logo) ? `<img src="${dataClientes[cId].logo}" class="client-logo-sub" title="${cliName}">` : '';
                let btnWaSub = sId !== "N/A" ? `<button class="btn btn-outline-success bg-white btn-sm rounded-circle shadow-sm cp float-end" style="width:28px; height:28px;" title="Reporte Subcliente" onclick="generarReporteGrupal('${cId}', '${sId}', '${cliName} -> ${subName}')"><i class="fa-brands fa-whatsapp"></i></button>` : '';
                
                if(sId !== "N/A" && subName !== "") html += `<tr class="header-subcliente client-group-${cId}"><td colspan="${colOrder.length}"><div class="d-flex justify-content-center align-items-center position-relative w-100"><div class="d-flex align-items-center">â†³ ${logoHtmlSub} Subcliente: ${subName}</div><div class="position-absolute end-0 pe-2">${btnWaSub}</div></div></td></tr>`;
                
                html += getHeadersRow(cId);

                tree[cId][sId].sort((a, b) => { let estA = String(a.v.estatus || ""); let estB = String(b.v.estatus || ""); return estA.localeCompare(estB); });

                tree[cId][sId].forEach(({vId, v}) => {
                    try {
                        let nombreCamion = String(v.unidadN || v.unidadFallback || "Desconocida").trim().toUpperCase();
                        let uData = encontrarUnidad(v, vId); let isExternal = v.wialonId === "EXTERNO"; 
                        let colEstatus = window.estatusData[v.estatus]?.col || '#0f172a'; let rowBg = isExternal ? '' : hexToRgba(colEstatus, 0.05);

                        let logsObj = v.log || {}; let logsArr = Object.values(logsObj).sort((a,b)=>b.t - a.t);
                        let lastLog = logsArr.length > 0 ? 
                            `<div class="text-start w-100 d-flex flex-column h-100 justify-content-center">
                                <div style="font-size:0.6rem; color:#64748b; font-weight:800; margin-bottom:2px;"><i class="fa-regular fa-calendar text-primary"></i> ${formatearFechaElegante(logsArr[0].t)} <i class="fa-solid fa-magnifying-glass-plus ms-1 text-primary cp" title="Ver Historial Completo" onclick="abrirModalLog('${vId}', '${nombreCamion}')"></i></div>
                                <div class="bg-white border rounded shadow-sm p-1" style="border-left: 3px solid var(--accent) !important; font-size:0.65rem; line-height:1.2;">
                                    <b class="text-primary">${String(logsArr[0].usr)}:</b> <span class="text-dark fw-bold">${String(logsArr[0].act)}</span>
                                    <div class="text-muted text-truncate mt-1" style="max-width:100%;" title="${String(logsArr[0].det||'')}">${String(logsArr[0].det||'')}</div>
                                </div>
                            </div>` : `<div style="font-size:0.65rem; color:#94a3b8;">Sin eventos</div>`;

                        let searchData = `${nombreCamion} ${v.origen||''} ${v.destino||''} ${v.contenedores||''} ${v.operador||''} ${cliName} ${subName} ${window.estatusData[v.estatus]?.nombre||''}`.toLowerCase();
                        
                        let curEst = window.estatusData[v.estatus] || window.estatusData["s1"];
                        let optionsHtml = `
                        <div class="dropdown w-100">
                            <button class="btn btn-sm w-100 fw-bold dropdown-toggle shadow-sm" style="background:white; color:${curEst.col}; border:1.5px solid ${curEst.col}; font-size:0.65rem; border-radius:12px; padding:2px 6px;" type="button" data-bs-toggle="dropdown" data-bs-boundary="window" aria-expanded="false">
                                ${curEst.nombre}
                            </button>
                            <ul class="dropdown-menu shadow-lg border-0 rounded-3" style="font-size:0.75rem; max-height:250px; overflow-y:auto; z-index:9999 !important;">
                                ${Object.keys(window.estatusData).map(k=>`<li><a class="dropdown-item fw-bold cp py-1" style="color:${window.estatusData[k].col};" onclick="cambiarEstatus('${k}', '${vId}')">${window.estatusData[k].nombre}</a></li>`).join('')}
                            </ul>
                        </div>`;

                        let btnSalida = construirBotonHorario(vId, v.t_salida, 't_salida', 'SALIDA', 'success');
                        let btnArribo = v.t_salida ? construirBotonHorario(vId, v.t_arribo, 't_arribo', 'ARRIBO', 'primary') : '';
                        let btnFin = v.t_arribo ? construirBotonHorario(vId, v.t_fin, 't_fin', 'FINALIZADO', 'dark') : '';

                        let mapClick = `clickMapaUnidad('${vId}')`;

                        let tds = {};
                        tds['col-unidad'] = `<td class="col-unidad align-middle ${hiddenCols['col-unidad'] ? 'd-none' : ''}"><div class="d-flex align-items-center justify-content-center"><span class="unit-name" id="name_btn_${vId}" onclick="${mapClick}">${nombreCamion}</span></div></td>`;
                        tds['col-operador'] = `<td class="col-operador align-middle ${hiddenCols['col-operador'] ? 'd-none' : ''}"><div id="op_wialon_${vId}"><span class="badge bg-secondary w-100 mt-1" style="font-size:0.6rem;"><i class="fa-solid fa-spinner fa-spin"></i> Cargando...</span></div></td>`;
                        tds['col-ruta'] = `<td class="col-ruta align-middle ${hiddenCols['col-ruta'] ? 'd-none' : ''}"><div class="position-relative ps-2"><div style="position:absolute; left:4px; top:10px; bottom:10px; width:1.5px; background:var(--border-col);"></div><div class="d-flex align-items-center position-relative mb-1"><i class="fa-solid fa-circle text-primary position-absolute" style="left:-6px; font-size:6px;"></i><input class="input-ghost text-start ps-2" value="${v.origen||''}" placeholder="ORIGEN" onblur="db.ref('viajes_activos/${vId}/origen').set(this.value.toUpperCase())"></div><div class="d-flex align-items-center position-relative"><i class="fa-solid fa-location-dot text-danger position-absolute" style="left:-6px; font-size:8px;"></i><input class="input-ghost text-start ps-2" value="${v.destino||''}" placeholder="DESTINO" onblur="db.ref('viajes_activos/${vId}/destino').set(this.value.toUpperCase())"></div></div></td>`;
                        tds['col-contenedores'] = `<td class="col-contenedores align-middle ${hiddenCols['col-contenedores'] ? 'd-none' : ''}"><textarea class="input-ghost text-start" style="resize:none; min-height:40px;" placeholder="CONTENEDORES" onblur="db.ref('viajes_activos/${vId}/contenedores').set(this.value.toUpperCase())">${v.contenedores||''}</textarea></td>`;
                        tds['col-horarios'] = `<td class="col-horarios align-middle ${hiddenCols['col-horarios'] ? 'd-none' : ''}"><div class="d-flex flex-column justify-content-center h-100 px-1">${btnSalida}${btnArribo}${btnFin}</div></td>`;
                        tds['col-estatus'] = `<td class="col-estatus align-middle ${hiddenCols['col-estatus'] ? 'd-none' : ''}" style="overflow: visible !important;">${optionsHtml}</td>`;
                        tds['col-gps'] = `<td class="col-gps align-middle ${hiddenCols['col-gps'] ? 'd-none' : ''}" id="gps_cell_${vId}"><div class="d-flex flex-column px-1 w-100"><div class="d-flex justify-content-between align-items-center border-bottom border-light pb-1 mb-1"><div class="d-flex align-items-center"><span id="icon_${vId}"><i class="fa-solid fa-spinner fa-spin text-muted me-1 fs-6"></i></span><span id="speed_${vId}"><span class="speed-badge bg-secondary m-0">-- km/h</span></span></div><div id="time_${vId}" style="font-size:0.65rem; color:#64748b; font-weight:800;">--</div></div><div class="w-100 text-center" id="addr_control_${vId}"><div style="font-size:0.75rem; color:#64748b; font-weight:800;">Sincronizando...</div></div></div></td>`;
                        tds['col-alertas'] = `<td class="col-alertas align-middle ${hiddenCols['col-alertas'] ? 'd-none' : ''}" id="alertas_${vId}">${v.alerta?'<span class="text-danger fw-bold" style="font-size:0.85rem;">'+v.alerta.txt+'</span>':'<span class="text-success fw-bold" style="font-size:0.85rem;">OK</span>'}</td>`;
                        tds['col-historial'] = `<td class="col-historial align-middle ${hiddenCols['col-historial'] ? 'd-none' : ''}">${lastLog}</td>`;
                        
                        tds['col-accion'] = `<td class="col-accion align-middle ${hiddenCols['col-accion'] ? 'd-none' : ''}" style="overflow: visible !important;">
                            <div class="d-flex align-items-center justify-content-center h-100">
                                <div class="dropdown">
                                    <button class="btn btn-light btn-sm shadow-sm border rounded-pill p-1 cp" type="button" data-bs-toggle="dropdown" data-bs-boundary="window" title="MÃ¡s Opciones"><i class="fa-solid fa-ellipsis-vertical mx-2"></i></button>
                                    <ul class="dropdown-menu dropdown-menu-end shadow-lg border-0 rounded-3 dropdown-menu-custom" style="z-index:9999 !important;">
                                        <li><a class="dropdown-item dropdown-item-custom text-primary cp" onclick="abrirEdicionViaje('${vId}', '${nombreCamion}')"><i class="fa-solid fa-pencil me-2 fs-5 align-middle"></i> Editar Viaje</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item dropdown-item-custom text-danger cp" onclick="finalizarViaje('${vId}', '${nombreCamion}')"><i class="fa-solid fa-trash me-2 fs-5 align-middle"></i> Archivar Viaje</a></li>
                                    </ul>
                                </div>
                            </div>
                        </td>`;

                        let savedWidths = JSON.parse(localStorage.getItem('tms_colWidths')) || {};
                        let trInner = colOrder.map(c => {
                            let ancho = savedWidths[c] || columnasDef[c].ancho;
                            return tds[c].replace('class="', `style="width:${ancho}px; min-width:${ancho}px; max-width:${ancho}px;" class="`);
                        }).join('');
                        
                        let trClass = isExternal ? 'external-connection-row data-row' : 'needs-gps-update data-row';
                        html += `<tr class="${trClass} client-group-${cId}" id="row_${vId}" data-search="${searchData}" style="background-color: ${rowBg} !important;">${trInner}</tr>`;

                    } catch(err) { console.error("Fila omitida por error:", vId, err); }
                });
            }
        }
        tbody.innerHTML = html || `<tr><td colspan="${colOrder.length}" class="p-5 text-muted fs-6 text-center"><i class="fa-solid fa-folder-open mb-2 fs-3 text-primary"></i><br>AÃºn no hay viajes activos en la bitÃ¡cora.</td></tr>`;
        filtrarTablaInteligente();
        if (motorArrancado) inyectarGPSenTabla();
    }

    function filtrarTablaInteligente() {
        let t = document.getElementById("buscador").value.toLowerCase(); let rows = Array.from(document.querySelectorAll("#units-body tr"));
        rows.forEach(r => { if(r.classList.contains("data-row")) r.style.display = (r.getAttribute("data-search") || "").includes(t) ? "" : "none"; });
        
        let currentSubclientVisible = false; let currentClientVisible = false;
        for (let i = rows.length - 1; i >= 0; i--) {
            let r = rows[i];
            if (r.classList.contains("data-row")) { 
                if (r.style.display !== "none") { currentSubclientVisible = true; currentClientVisible = true; } 
            } 
            else if (r.classList.contains("header-columnas")) { r.style.display = currentSubclientVisible ? "" : "none"; }
            else if (r.classList.contains("header-subcliente")) { r.style.display = currentSubclientVisible ? "" : "none"; currentSubclientVisible = false; } 
            else if (r.classList.contains("header-cliente")) { r.style.display = currentClientVisible ? "" : "none"; currentClientVisible = false; currentSubclientVisible = false; }
        }
    }

    function abrirModalLog(uId, uName) {
        document.getElementById("log_uid").value = uId; document.getElementById("log_uName").innerText = uName; document.getElementById("log_txt").value = "";
        let logsObj = viajesActivos[uId]?.log || {}; let logsArr = Object.values(logsObj).sort((a,b)=>b.t - a.t);
        let html = logsArr.map(l => `<div class="mb-2 border-bottom pb-1"><div style="font-size:0.65rem; color:#6c757d; font-weight:bold; margin-bottom:1px;"><i class="fa-regular fa-calendar text-primary"></i> ${formatearFechaElegante(l.t)}</div><b class="text-dark">${l.usr}:</b> <span class="text-primary">${l.act}</span> <span class="text-muted">${l.det||''}</span></div>`).join('');
        document.getElementById("log_container").innerHTML = html || '<div class="text-muted text-center p-2 mt-3">Sin eventos.</div>'; new bootstrap.Modal(document.getElementById('modalLog')).show();
    }
    
    function guardarLogManual() {
        let uId = document.getElementById("log_uid").value, txt = document.getElementById("log_txt").value.toUpperCase(); if(!txt) return;
        registrarLog(uId, "AgregÃ³ Nota", txt); try { bootstrap.Modal.getInstance(document.getElementById('modalLog')).hide(); } catch(e){}
    }

    function prepararNuevoViaje() { 
        let listCli = document.getElementById("list_clientes");
        if(!listCli) { listCli = document.createElement('datalist'); listCli.id="list_clientes"; document.body.appendChild(listCli); }
        listCli.innerHTML = Object.keys(dataClientes).map(k => `<option value="${dataClientes[k].nombre}">`).join('');

        let listSub = document.getElementById("list_subclientes");
        if(!listSub) { listSub = document.createElement('datalist'); listSub.id="list_subclientes"; document.body.appendChild(listSub); }
        let subHtml = ""; Object.values(dataClientes).forEach(c => { if(c.subclientes) Object.values(c.subclientes).forEach(s => subHtml += `<option value="${s.nombre}">`); });
        listSub.innerHTML = subHtml;

        document.getElementById("nv_cliente").value = ""; document.getElementById("nv_subcliente").value = "";
        document.getElementById("nv_filas_container").innerHTML = "";
        agregarFilaNV(); 
    }

    function agregarFilaNV() {
        let isExterna = document.getElementById("nv_externa").checked;
        let div = document.createElement("div");
        div.className = "bg-white border rounded p-2 mb-2 nv-fila position-relative shadow-sm";
        div.innerHTML = `
            <button class="btn btn-sm btn-danger position-absolute top-0 end-0 m-1 px-2 py-0 rounded" onclick="this.parentElement.remove()" title="Quitar Unidad"><i class="fa-solid fa-xmark"></i></button>
            <div class="row gx-2 mt-1">
                <div class="col-4"><label style="font-size:0.65rem;" class="fw-bold text-muted mb-1">UNIDAD GPS</label><input type="text" class="form-control form-control-sm border-primary fw-bold text-uppercase nv-unidad" list="listaUnidadesTotales" placeholder="Buscar unidad..." oninput="autofillOp(this)"></div>
                <div class="col-4"><label style="font-size:0.65rem;" class="fw-bold text-muted mb-1">ORIGEN</label><input type="text" class="form-control form-control-sm text-uppercase nv-origen" list="listaGeocercas" placeholder="Escribir o elegir..."></div>
                <div class="col-4"><label style="font-size:0.65rem;" class="fw-bold text-muted mb-1">DESTINO(S)</label><input type="text" class="form-control form-control-sm text-uppercase nv-destino" list="listaGeocercas" placeholder="Ej. Laredo, MTY, GDL..."></div>
            </div>
            <div class="row gx-2 mt-2 nv-operador-row" style="display:${isExterna ? 'flex' : 'none'};">
                <div class="col-12"><input type="text" class="form-control form-control-sm text-uppercase nv-operador" list="listaConductores" placeholder="Nombre de Operador (Requerido para manuales)"></div>
            </div>
        `;
        document.getElementById("nv_filas_container").appendChild(div);
    }

    document.getElementById('nv_externa').addEventListener('change', function() {
        document.querySelectorAll('.nv-operador-row').forEach(el => el.style.display = this.checked ? 'flex' : 'none');
    });

    function autofillOp(inputEl) {
        let uN = inputEl.value.toUpperCase(); let opInput = inputEl.parentElement.parentElement.nextElementSibling.querySelector('.nv-operador');
        if(opInput && (ramDrivers[uN] || dbOperadores[uN])) { opInput.value = ramDrivers[uN] || dbOperadores[uN]; }
    }

    function getClienteIdByName(name) { let found = Object.keys(dataClientes).find(k => String(dataClientes[k].nombre).toUpperCase() === String(name).toUpperCase()); return found || name; }
    function getSubclienteIdByName(cliId, subName) { if(dataClientes[cliId] && dataClientes[cliId].subclientes) { let found = Object.keys(dataClientes[cliId].subclientes).find(k => String(dataClientes[cliId].subclientes[k].nombre).toUpperCase() === String(subName).toUpperCase()); return found || subName; } return subName; }

    function registrarViajesMultiples() {
        let cliName = document.getElementById("nv_cliente").value.trim().toUpperCase();
        let subName = document.getElementById("nv_subcliente").value.trim().toUpperCase();
        if(!cliName) return alert("Debes poner el nombre del Cliente.");

        let cId = getClienteIdByName(cliName); let sId = getSubclienteIdByName(cId, subName);

        if(cId === cliName && cliName !== "") { let ref = db.ref('clientes').push({nombre: cliName, logo: ""}); cId = ref.key; }
        if(sId === subName && subName !== "") { let ref = db.ref('clientes/'+cId+'/subclientes').push({nombre: subName}); sId = ref.key; }
        if(subName === "") sId = "N/A";

        let isExterna = document.getElementById("nv_externa").checked;
        let filas = document.querySelectorAll(".nv-fila");
        if(filas.length === 0) return alert("AÃ±ade al menos una unidad al lote.");
        
        let batchPromises = [];
        filas.forEach(fila => {
            let uInput = fila.querySelector(".nv-unidad").value.trim().toUpperCase(); 
            let opInput = fila.querySelector(".nv-operador").value.trim().toUpperCase();
            let origen = fila.querySelector(".nv-origen").value.trim().toUpperCase();
            let destino = fila.querySelector(".nv-destino").value.trim().toUpperCase();
            if(!uInput) return;
            
            let wId = "EXTERNO";
            if (!isExterna) { let nNorm = uInput.replace(/[\s\-]/g, ""); for(let k in unidadesGlobales){ if(String(unidadesGlobales[k].name).replace(/[\s\-]/g, "") === nNorm) { wId = k; uInput = unidadesGlobales[k].name; break; } } }
            
            let refPush = db.ref('viajes_activos').push();
            let p = refPush.set({ id: refPush.key, wialonId: wId, cliente: cId, subcliente: sId, origen: origen, destino: destino, estatus: "s1", operador: opInput, unidadFallback: uInput, unidadN: uInput }).then(() => {
                registrarLog(refPush.key, "REGISTRÃ“ VIAJE", isExterna ? "Unidad Externa" : "Unidad GPS");
            });
            batchPromises.push(p);
        });
        
        Promise.all(batchPromises).then(() => {
            try{ bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide(); }catch(e){}
        });
    }

    function finalizarViaje(id, n) { 
        if(confirm(`Â¿Archivar viaje de la unidad ${n}?`)) { 
            let v = viajesActivos[id];
            if(v && !v.t_fin) { db.ref('viajes_activos/'+id+'/t_fin').set(Date.now()); registrarLog(id, "MarcÃ³ FINALIZADO", "AutomÃ¡tico"); }
            registrarLog(id, "FINALIZÃ“ VIAJE", "Se archiva registro"); 
            setTimeout(()=>db.ref('viajes_activos/'+id).remove(), 1000); 
        } 
    }
    
    function abrirEdicionViaje(uId, uName) { 
        let v = viajesActivos[uId]; if(!v) return; 
        document.getElementById("edU_id").value = uId; document.getElementById("edU_name").innerText = uName; 
        document.getElementById("ed_operador").value = v.operador || ""; document.getElementById("ed_origen").value = v.origen || ""; document.getElementById("ed_destino").value = v.destino || ""; 
        
        let cName = (v.cliente && v.cliente !== "Sin_Cliente" && dataClientes[v.cliente]) ? dataClientes[v.cliente].nombre : "";
        let sName = (v.subcliente && v.subcliente !== "N/A" && dataClientes[v.cliente] && dataClientes[v.cliente].subclientes && dataClientes[v.cliente].subclientes[v.subcliente]) ? dataClientes[v.cliente].subclientes[v.subcliente].nombre : "";
        
        document.getElementById("ed_cliente").value = cName; document.getElementById("ed_subcliente").value = sName; 
        new bootstrap.Modal(document.getElementById('modalEditarViaje')).show(); 
    }

    function guardarEdicionViaje() { 
        let uId = document.getElementById("edU_id").value; 
        let cliName = document.getElementById("ed_cliente").value.trim().toUpperCase();
        let subName = document.getElementById("ed_subcliente").value.trim().toUpperCase();
        let cId = getClienteIdByName(cliName); let sId = getSubclienteIdByName(cId, subName);

        if(cId === cliName && cliName !== "") { let ref = db.ref('clientes').push({nombre: cliName, logo: ""}); cId = ref.key; }
        if(sId === subName && subName !== "") { let ref = db.ref('clientes/'+cId+'/subclientes').push({nombre: subName}); sId = ref.key; }
        if(cliName === "") cId = "Sin_Cliente"; if(subName === "") sId = "N/A";

        registrarLog(uId, "EditÃ³ Datos", "Rutas/Cliente"); 
        db.ref('viajes_activos/' + uId).update({ cliente: cId, subcliente: sId, origen: document.getElementById("ed_origen").value.toUpperCase(), destino: document.getElementById("ed_destino").value.toUpperCase(), operador: document.getElementById("ed_operador").value.toUpperCase() }).then(() => { try{bootstrap.Modal.getInstance(document.getElementById('modalEditarViaje')).hide();}catch(e){} }); 
    }
    
    function cerrarSesion() { localStorage.clear(); location.reload(); }

    function vincularOperador() { let u = document.getElementById("op_unidad").value.toUpperCase(); let n = document.getElementById("op_nombre").value.toUpperCase(); if(u && n) { db.ref(`operadores/${u}`).set(n); document.getElementById("op_unidad").value = ""; document.getElementById("op_nombre").value = ""; } }
    function crearCliente() { let nom = document.getElementById("cli_nombre").value.toUpperCase(); let fileInput = document.getElementById("cli_logo_file"); if(!nom) return; if (fileInput && fileInput.files && fileInput.files[0]) { let reader = new FileReader(); reader.onload = function(e) { db.ref('clientes').push({nombre: nom, logo: e.target.result}); document.getElementById("cli_nombre").value = ""; fileInput.value = ""; }; reader.readAsDataURL(fileInput.files[0]); } else { db.ref('clientes').push({nombre: nom, logo: ""}); document.getElementById("cli_nombre").value = ""; if(fileInput) fileInput.value = ""; } }
    function crearSubcliente() { db.ref(`clientes/${document.getElementById("sub_clientePadre").value}/subclientes`).push({nombre: document.getElementById("sub_nombre").value.toUpperCase()}); document.getElementById("sub_nombre").value = ""; }
    function crearUsuario() { let id = document.getElementById("usr_id").value.trim().toLowerCase(), nom = document.getElementById("usr_nom").value.trim(), pass = document.getElementById("usr_pass").value.trim(); if(id && nom && pass) { db.ref(`sistema/usuarios/${id}`).set({nom: nom, pass: pass, rol: "monitor"}); document.getElementById("usr_id").value=""; document.getElementById("usr_nom").value=""; document.getElementById("usr_pass").value=""; } }
    
    function actualizarListasAdmin() { 
        let s = document.getElementById("sub_clientePadre"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join(''); 
        document.getElementById("listaClientesAdmin").innerHTML = Object.keys(dataClientes).map(k => { let c = dataClientes[k]; let logoText = c.logo ? `<i class="fa-solid fa-image text-success ms-1" title="Logo"></i>` : ''; let safeNom = (c.nombre || '').replace(/'/g, "\\'"); return `<li class="list-group-item d-flex justify-content-between align-items-center p-1 fs-8"><span class="text-truncate" style="max-width:60%;">${c.nombre} ${logoText}</span><div class="text-nowrap"><i class="fa-solid fa-pencil text-primary cp me-2" onclick="let n=prompt('Editar:', '${safeNom}'); if(n){ db.ref('clientes/${k}').update({nombre: n.toUpperCase()}); }"></i><i class="fa-solid fa-camera text-success cp me-2" onclick="window.currentEditCli='${k}'; document.getElementById('edit_cli_logo_file').click();"></i><i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('Â¿Borrar Cliente?')) db.ref('clientes/${k}').remove()"></i></div></li>`; }).join('');
        let subHtml = ""; Object.keys(dataClientes).forEach(cId => { if(dataClientes[cId].subclientes) { Object.keys(dataClientes[cId].subclientes).forEach(sId => { subHtml += `<li class="list-group-item d-flex justify-content-between p-1 fs-8"><b>${dataClientes[cId].nombre}</b> - ${dataClientes[cId].subclientes[sId].nombre} <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('Â¿Borrar?')) db.ref('clientes/${cId}/subclientes/${sId}').remove()"></i></li>`; }); } }); document.getElementById("listaSubclientesAdmin").innerHTML = subHtml;
        db.ref('sistema/usuarios').once('value', snap => { let usrs = snap.val() || {}; document.getElementById("listaUsuariosAdmin").innerHTML = Object.keys(usrs).map(k => k === 'admin' ? `<li class="list-group-item p-1 fs-8"><b>admin</b> (Maestro)</li>` : `<li class="list-group-item d-flex justify-content-between p-1 fs-8"><b>${k}</b> <span class="ps-1">${usrs[k].nom}</span> <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('Â¿Borrar?')) db.ref('sistema/usuarios/${k}').remove()"></i></li>`).join(''); });
    }
    
    function agregarToken() { db.ref('sistema/tokens').push({nombre:document.getElementById("tk_nom").value.toUpperCase(), token:document.getElementById("tk_val").value, url:document.getElementById("tk_url").value}); document.getElementById("tk_nom").value=""; document.getElementById("tk_val").value=""; }
    function actualizarListaTokensAdmin(tks) { const lista = document.getElementById("listaTokensActivos"); if(lista) { lista.innerHTML = Object.keys(tks || {}).map(id => `<li class="list-group-item d-flex justify-content-between p-1 fs-8"><b>${tks[id].nombre}</b> <i class="fa-solid fa-trash text-danger cp" onclick="if(confirm('Â¿Borrar Token?')) { db.ref('sistema/tokens/${id}').remove().then(()=>location.reload()); }"></i></li>`).join(''); } }
</script>
</body>
</html>
