<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Log√≠stica Cloud - API Directa</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <style>
        body { background: #002a61; color: white; font-family: 'Segoe UI', sans-serif; }
        .login-card { background: white; color: #333; width: 420px; border-radius: 25px; padding: 40px; margin: 15vh auto; }
        #dashboard { display:none; background: #f8f9fa; color: #333; min-height: 100vh; padding: 25px; }
        .table-input { border: 1px solid #dee2e6; padding: 5px; width: 100%; border-radius: 6px; font-size: 0.8rem; }
        .status-badge { font-size: 0.75rem; font-weight: 700; padding: 4px 8px; border-radius: 12px; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card shadow-lg text-center">
        <h2 class="text-primary fw-bold mb-3">Log√≠stica Cloud</h2>
        <p class="text-muted small mb-4">Conexi√≥n Directa por API (Sin SDK)</p>
        <input type="password" id="token" class="form-control mb-4 text-center py-2" placeholder="Wialon API Token">
        <button onclick="conectarAPI()" id="btnGo" class="btn btn-primary w-100 fw-bold py-2 shadow">AUTORIZAR Y ENTRAR</button>
        <div id="status" class="mt-4 small fw-bold text-secondary">Esperando token...</div>
    </div>
</div>

<div id="dashboard">
    <div class="d-flex justify-content-between align-items-center mb-4 bg-white p-3 rounded shadow-sm border-start border-primary border-5">
        <h4 class="fw-bold text-primary m-0">BIT√ÅCORA LOG√çSTICA REAL-TIME</h4>
        <button onclick="exportarExcel()" class="btn btn-success btn-sm fw-bold px-4">üì• Descargar Reporte</button>
    </div>
    <div class="card shadow border-0 overflow-hidden">
        <div class="table-responsive">
            <table class="table table-hover align-middle mb-0 text-center">
                <thead class="table-dark">
                    <tr>
                        <th width="12%">Unidad</th>
                        <th width="10%">Cliente</th>
                        <th width="10%">Subcliente</th>
                        <th width="10%">Origen</th>
                        <th width="10%">Destino</th>
                        <th width="10%">Estatus</th>
                        <th width="10%">Contenedores</th>
                        <th width="8%">Velocidad</th>
                        <th width="15%">Ubicaci√≥n GPS</th>
                        <th width="5%">Estado</th>
                    </tr>
                </thead>
                <tbody id="units-body"></tbody>
            </table>
        </div>
    </div>
</div>

<script type="text/javascript">
    // 1. FIREBASE (Configuraci√≥n verificada)
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables de Sesi√≥n Directa
    let SID = ""; 
    let UID = "";

    // 2. CONEXI√ìN DIRECTA A LA API (Sustituto del SDK)
    async function conectarAPI() {
        const tokenVal = document.getElementById("token").value;
        if (!tokenVal) return alert("Por favor, ingresa tu token");

        const statusEl = document.getElementById("status");
        statusEl.innerText = "Abriendo t√∫nel directo con Wialon...";
        statusEl.className = "mt-4 small fw-bold text-warning";

        try {
            // Petici√≥n directa al servidor (esquivando el archivo bloqueado)
            const response = await fetch(`https://hst-api.wialon.com/wialon/ajax.html?svc=token/login&params={"token":"${tokenVal}"}`);
            const data = await response.json();

            if (data.error) {
                statusEl.innerText = "Error de Token ‚ùå";
                statusEl.className = "mt-4 small text-danger fw-bold";
                alert("Wialon rechaz√≥ el token. C√≥digo de error: " + data.error);
                return;
            }

            // √âxito: Guardamos la credencial de la sesi√≥n
            SID = data.eid;
            UID = data.user.id;
            
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            
            cargarFlota();

        } catch (err) {
            statusEl.innerText = "Red bloqueada ‚ùå";
            statusEl.className = "mt-4 small text-danger fw-bold";
            alert("Tu conexi√≥n de internet est√° bloqueando el dominio hst-api.wialon.com. Intenta compartir datos desde tu celular.");
        }
    }

    // 3. OBTENER UNIDADES (API REST)
    async function cargarFlota() {
        // Configuramos la b√∫squeda de unidades (equivalente a loadLibrary + updateDataFlags)
        const params = {
            "spec": {"itemsType":"avl_unit","propName":"sys_name","propValueMask":"*","sortType":"sys_name"},
            "force": 1,
            "flags": 1025, // 1 (Nombre) + 1024 (Posici√≥n)
            "from": 0,
            "to": 0
        };

        try {
            const url = `https://hst-api.wialon.com/wialon/ajax.html?svc=core/search_items&params=${JSON.stringify(params)}&sid=${SID}`;
            const res = await fetch(url);
            const data = await res.json();
            
            if (data.items) {
                renderizarTabla(data.items);
            }
        } catch(e) {
            console.error("Error cargando flota:", e);
        }
    }

    // 4. DIBUJAR TABLA
    function renderizarTabla(units) {
        let html = "";
        const tbody = document.getElementById("units-body");

        units.forEach(u => {
            const id = u.id;
            const pos = u.pos;
            const speed = pos ? pos.s : 0;
            const mov = speed > 0;

            html += `<tr>
                <td class="fw-bold text-primary">${u.nm}</td>
                <td><input id="cli_${id}" class="table-input" onchange="guardar('${id}','cliente',this.value)"></td>
                <td><input id="sub_${id}" class="table-input" onchange="guardar('${id}','subcliente',this.value)"></td>
                <td><input id="ori_${id}" class="table-input" onchange="guardar('${id}','origen',this.value)"></td>
                <td><input id="des_${id}" class="table-input" onchange="guardar('${id}','destino',this.value)"></td>
                <td>
                    <select id="est_${id}" class="table-input" onchange="guardar('${id}','estatus',this.value)">
                        <option value="Disponible">Disponible</option>
                        <option value="En Tr√°nsito">En Tr√°nsito</option>
                        <option value="Cargando">Cargando</option>
                        <option value="Aduana">Aduana</option>
                    </select>
                </td>
                <td><input id="con_${id}" class="table-input" onchange="guardar('${id}','contenedores',this.value)"></td>
                <td class="fw-bold text-dark">${speed} km/h</td>
                <td id="addr_${id}" style="font-size:0.7rem; color:#666; font-style:italic;">[ Coordenadas: ${pos ? pos.y.toFixed(4)+', '+pos.x.toFixed(4) : 'N/D'} ]</td>
                <td><span class="status-badge ${mov?'bg-success text-white':'bg-danger text-white'}">${mov?'MOV':'STOP'}</span></td>
            </tr>`;

            // Sincronizar datos individuales con Firebase
            db.ref('viajes/' + id).once('value', (s) => {
                const v = s.val();
                if (v) {
                    setTimeout(() => {
                        if(document.getElementById(`cli_${id}`)) document.getElementById(`cli_${id}`).value = v.cliente || "";
                        if(document.getElementById(`sub_${id}`)) document.getElementById(`sub_${id}`).value = v.subcliente || "";
                        if(document.getElementById(`ori_${id}`)) document.getElementById(`ori_${id}`).value = v.origen || "";
                        if(document.getElementById(`des_${id}`)) document.getElementById(`des_${id}`).value = v.destino || "";
                        if(document.getElementById(`est_${id}`)) document.getElementById(`est_${id}`).value = v.estatus || "Disponible";
                        if(document.getElementById(`con_${id}`)) document.getElementById(`con_${id}`).value = v.contenedores || "";
                    }, 100);
                }
            });
        });
        
        tbody.innerHTML = html;
        
        // Refrescar datos cada 15 segundos para mantener el "Real-Time"
        setTimeout(cargarFlota, 15000); 
    }

    function guardar(id, campo, valor) {
        db.ref('viajes/' + id).update({ [campo]: valor });
    }

    function exportarExcel() {
        let csv = "\uFEFFUNIDAD,CLIENTE,SUBCLIENTE,ORIGEN,DESTINO,ESTATUS,CONTENEDORES,VELOCIDAD,UBICACI√ìN\n";
        document.querySelectorAll("#units-body tr").forEach(row => {
            const i = row.querySelectorAll("input, select");
            csv += `${row.cells[0].innerText},${i[0].value},${i[1].value},${i[2].value},${i[3].value},${i[4].value},${i[5].value},${row.cells[7].innerText},${row.cells[8].innerText.replace(/,/g, " ")}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Bitacora_Flota_Maestra.csv";
        link.click();
    }
</script>
</body>
</html>
