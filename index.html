<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4 - OPERATIVO FINAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-main: #f4f7fa; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body.dark-mode { --bg-main: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --header-bg: #0d1b2a; --table-bg: #2c2c2c; --border-col: #444; }
        
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.8rem; transition: 0.3s; margin: 0; overflow-x: hidden;}
        .login-bg { background: linear-gradient(135deg, #002a61 0%, #001122 100%); min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: var(--bg-card); color: var(--text-main); width: 380px; border-radius: 12px; padding: 40px; box-shadow: 0 15px 35px rgba(0,0,0,0.5);}
        
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 70px); width: 100%; overflow: hidden; }
        .map-panel { height: 0%; width: 100%; transition: height 0.4s ease; border-bottom: 0 solid var(--header-bg); position: relative;}
        .workspace-container.show-map .map-panel { height: 45%; border-bottom: 4px solid var(--header-bg); }
        .table-panel { height: 100%; width: 100%; transition: height 0.4s ease; overflow-y: auto; padding: 15px; }
        .workspace-container.show-map .table-panel { height: 55%; }
        #map { width: 100%; height: 100%; z-index: 1;}
        
        .table-input { border: 1px solid var(--border-col); padding: 4px 6px; width: 100%; border-radius: 6px; font-size: 0.75rem; text-align: center; font-weight: 600; background: var(--bg-main); color: var(--text-main); text-transform: uppercase; transition: 0.2s; box-shadow: inset 0 1px 2px rgba(0,0,0,0.05);}
        .table-input:focus { background: #fff; border-color: #0d6efd; outline: none; box-shadow: 0 0 0 3px rgba(13,110,253,0.25); }
        
        #mainTableHeader { position: sticky; top: 0; z-index: 10; }
        
        .header-columnas th { 
            background-color: var(--header-bg) !important; color: white !important; font-size: 0.65rem; font-weight: 700; text-align: center; vertical-align: middle; padding: 10px 6px; text-transform: uppercase; border-right: 1px solid rgba(255,255,255,0.15); 
            resize: horizontal; overflow: hidden; position: relative; letter-spacing: 0.5px;
        }
        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 0.90rem; font-weight: bold; text-align: left; padding: 8px 15px !important; text-transform: uppercase; }
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.80rem; font-weight: bold; text-align: left; padding: 5px 25px !important; }
        
        /* ANCHOS √ìPTIMOS FLEXIBLES */
        .col-unidad { min-width: 90px; }
        .col-operador { min-width: 120px; }
        .col-ruta { min-width: 160px; }
        .col-contenedores { min-width: 110px; }
        .col-horarios { min-width: 130px; }
        .col-estatus { min-width: 130px; }
        .col-gps { min-width: 280px; } /* M√°xima prioridad de espacio */
        .col-alertas { min-width: 60px; }
        .col-historial { min-width: 200px; }
        .col-accion { min-width: 45px; }

        .status-select { border-radius: 8px; font-weight: bold; cursor: pointer; text-align: center; font-size: 0.8rem; padding: 6px; background-color: transparent; outline: none; transition: all 0.2s;}
        
        .unit-name { cursor: pointer; color: #002a61; font-weight: 900; font-size: 1.15rem; letter-spacing: 0.5px; display: block; text-align: center; }
        .unit-name:hover { color: #0d6efd; text-decoration: underline; }
        .lost-connection-row td { background-color: #fff5f5 !important; }
        
        .speed-badge { font-size: 0.95rem; font-weight: 900; border-radius: 6px; padding: 4px 10px; text-align: center; color: white; display: inline-block; margin-bottom: 5px; box-shadow: 0 2px 4px rgba(0,0,0,0.15);}
        .addr-link { font-size: 0.85rem; line-height: 1.2; color: #0d6efd; text-decoration: none; display: block; width: 100%; margin: 0 auto; font-weight: 700; text-align: center; transition: 0.2s;}
        .addr-link:hover { text-decoration: underline; color: #0a58ca; }
        
        .cp { cursor: pointer; }
        .border-dashed { border-style: dashed !important; border-color: #aaa !important; background-color: #f8f9fa; }
        .border-dashed:hover { background-color: #e2e6ea; }

        .leaflet-popup-content-wrapper { background: #2c3e50; color: #fff; border-radius: 6px; }
        .leaflet-popup-tip { background: #2c3e50; }
        .data-row { transition: background-color 0.15s ease; }
        .data-row:hover { background-color: #f1f5fa !important; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="height: 65px; margin-bottom: 20px;">
        <h5 class="text-primary fw-bold mb-4">GRUDICOM TI & GPS</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a">
        <button onclick="autenticarUsuario()" class="btn btn-primary w-100 fw-bold py-2 shadow-sm"><i class="fa-solid fa-right-to-bracket"></i> INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Motor Multi-Host v10.3 (Geocercas)</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 40px;" class="me-3">
            <div>
                <h6 class="fw-bold m-0" style="color: var(--text-main);">C4 - BIT√ÅCORA GRUDICOM TI & GPS</h6>
                <small class="text-muted fw-bold" id="lblUsuarioActivo" style="font-size: 10px;">Monitor: </small>
            </div>
        </div>
        <div>
            <div class="dropdown d-inline-block me-2">
                <button class="btn btn-secondary btn-sm fw-bold dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" data-bs-auto-close="outside">
                    <i class="fa-solid fa-eye"></i> Columnas
                </button>
                <ul class="dropdown-menu shadow" style="font-size: 0.8rem;" id="colTogglerMenu">
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-operador', this.checked)"> Operador</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-ruta', this.checked)"> Ruta</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-contenedores', this.checked)"> Contenedores</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-horarios', this.checked)"> Horarios</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-alertas', this.checked)"> Alertas</label></li>
                    <li><label class="dropdown-item cp"><input type="checkbox" class="form-check-input me-2" onchange="toggleCol('col-historial', this.checked)"> Historial Log</label></li>
                </ul>
            </div>

            <button class="btn btn-warning btn-sm fw-bold me-2 text-dark" data-bs-toggle="modal" data-bs-target="#modalStatusTokens"><i class="fa-solid fa-satellite-dish"></i> Tokens</button>
            <button class="btn btn-info btn-sm fw-bold me-2 text-dark" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Ver Mapa</button>
            <button class="btn btn-dark btn-sm fw-bold me-2" onclick="toggleDarkMode()"><i class="fa-solid fa-moon"></i></button>
            <button class="btn btn-outline-primary btn-sm fw-bold me-1" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje" onclick="prepararNuevoViaje()"><i class="fa-solid fa-truck-fast"></i> Registrar Viaje</button>
            <button class="btn btn-danger btn-sm fw-bold me-2" id="btnAdmin" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i> ADMIN</button>
            <button class="btn btn-secondary btn-sm fw-bold" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i> Salir</button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map"></div></div>
        <div class="table-panel">
            <div class="row mb-2 align-items-center">
                <div class="col-md-4"><input type="text" id="buscador" class="form-control form-control-sm border-primary" placeholder="üîç Buscar unidad, destino, estatus..." onkeyup="filtrarTablaInteligente()"></div>
                <div class="col-md-8 text-end"><span id="syncIndicator" class="badge bg-secondary">Cargando flotas...</span></div>
            </div>
            <div class="card shadow-sm border-0 h-100 bg-transparent">
                <div class="table-responsive h-100" style="overflow-x: auto;">
                    <table class="table table-bordered align-middle text-center mb-0 bg-white" id="mainTable" style="table-layout: auto;">
                        <thead id="mainTableHeader">
                            <tr class="header-columnas">
                                <th class="col-unidad">UNIDAD</th>
                                <th class="col-operador">OPERADOR</th>
                                <th class="col-ruta">RUTA (O ‚ûî D)</th>
                                <th class="col-contenedores">CONTENEDORES</th>
                                <th class="col-horarios">HORARIOS</th>
                                <th class="col-estatus">ESTATUS <i class="fa-solid fa-sort"></i></th>
                                <th class="col-gps">GPS & UBICACI√ìN</th>
                                <th class="col-alertas">ALERTAS</th>
                                <th class="col-historial">HISTORIAL LOG</th>
                                <th class="col-accion"><i class="fa-solid fa-gear"></i></th>
                            </tr>
                        </thead>
                        <tbody id="units-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalStatusTokens" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-warning text-dark"><h6 class="modal-title fw-bold"><i class="fa-solid fa-satellite-dish"></i> ESTATUS GPS</h6><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div><div class="modal-body p-0"><ul class="list-group list-group-flush" id="listaStatusTokens"><li class="list-group-item text-muted text-center p-4">Cargando...</li></ul></div></div></div></div>
<div class="modal fade" id="modalAdmin" tabindex="-1"><div class="modal-dialog modal-xl"><div class="modal-content"><div class="modal-header bg-danger text-white"><h6 class="modal-title fw-bold">ADMINISTRACI√ìN MAESTRA</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body"><div class="row"><div class="col-md-3 border-end"><h6>Tokens GPS</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="tk_nom" class="form-control form-control-sm mb-1" placeholder="Ej. RACEL"><input type="text" id="tk_url" class="form-control form-control-sm mb-1" value="https://hst-api.wialon.com"><input type="text" id="tk_val" class="form-control form-control-sm mb-1" placeholder="Token Largo"><button class="btn btn-success btn-sm w-100" onclick="agregarToken()">Guardar</button></div><ul class="list-group list-group-sm mt-2" id="listaTokensActivos"></ul></div><div class="col-md-3 border-end"><h6>Clientes</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="cli_nombre" class="form-control form-control-sm mb-1" placeholder="Empresa"><button onclick="crearCliente()" class="btn btn-success btn-sm w-100">A√±adir</button></div><ul class="list-group list-group-sm" id="listaClientesAdmin"></ul></div><div class="col-md-3 border-end"><h6>Subclientes</h6><div class="p-2 bg-light border rounded mb-2"><select id="sub_clientePadre" class="form-select form-select-sm mb-1"></select><input type="text" id="sub_nombre" class="form-control form-control-sm mb-1" placeholder="Sub-empresa"><button onclick="crearSubcliente()" class="btn btn-success btn-sm w-100">A√±adir</button></div><ul class="list-group list-group-sm" id="listaSubclientesAdmin"></ul></div><div class="col-md-3"><h6>Monitoristas</h6><div class="p-2 bg-light border rounded mb-2"><input type="text" id="usr_id" class="form-control form-control-sm mb-1" placeholder="Usuario (login)"><input type="text" id="usr_nom" class="form-control form-control-sm mb-1" placeholder="Nombre completo"><input type="text" id="usr_pass" class="form-control form-control-sm mb-1" placeholder="Contrase√±a"><button onclick="crearUsuario()" class="btn btn-success btn-sm w-100">Crear</button></div><ul class="list-group list-group-sm" id="listaUsuariosAdmin"></ul></div></div></div></div></div></div>
<div class="modal fade" id="modalNuevoViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold">REGISTRAR UNIDAD</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><label>Unidad GPS:</label><input type="text" class="form-control form-control-sm mb-2 border-primary fw-bold" list="listaUnidadesTotales" id="nv_unidad_input" autocomplete="off" placeholder="Selecciona o escribe el nombre exacto..."><label>Operador:</label><input type="text" id="nv_operador" class="form-control form-control-sm mb-2" list="listaConductores" autocomplete="off"><div class="row mb-2"><div class="col-6"><label>Cliente:</label><select id="nv_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('nv_subcliente', this.value)"></select></div><div class="col-6"><label>Subcliente:</label><select id="nv_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div></div><div class="row"><div class="col-6"><label>Origen:</label><input type="text" id="nv_origen" class="form-control form-control-sm mb-2" list="listaGeocercas"></div><div class="col-6"><label>Destino:</label><input type="text" id="nv_destino" class="form-control form-control-sm mb-2" list="listaGeocercas"></div></div><button onclick="registrarViaje()" class="btn btn-primary btn-sm w-100 fw-bold mt-2">REGISTRAR EN BIT√ÅCORA</button></div></div></div></div>
<div class="modal fade" id="modalEditarViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-success text-white"><h6>EDITAR VIAJE: <span id="edU_name"></span></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body small"><input type="hidden" id="edU_id"><div class="row mb-2"><div class="col-6"><label>Cliente:</label><select id="ed_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('ed_subcliente', this.value)"></select></div><div class="col-6"><label>Subcliente:</label><select id="ed_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div></div><div class="row mb-2"><div class="col-6"><label>Origen:</label><input type="text" id="ed_origen" class="form-control form-control-sm" list="listaGeocercas"></div><div class="col-6"><label>Destino:</label><input type="text" id="ed_destino" class="form-control form-control-sm" list="listaGeocercas"></div></div><label>Operador:</label><input type="text" id="ed_operador" class="form-control form-control-sm mb-3" list="listaConductores"><button onclick="guardarEdicionViaje()" class="btn btn-success btn-sm w-100 fw-bold">ACTUALIZAR DATOS</button></div></div></div></div>
<div class="modal fade" id="modalLog" tabindex="-1"><div class="modal-dialog"><div class="modal-content"><div class="modal-header bg-dark text-white"><h6 class="modal-title fw-bold"><i class="fa-solid fa-list-ul"></i> HISTORIAL: <span id="log_uName"></span></h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div><div class="modal-body p-2"><div id="log_container" class="mb-3 border rounded p-2 bg-light" style="height:250px; overflow-y:auto; font-size:0.75rem;"></div><input type="hidden" id="log_uid"><div class="input-group"><input type="text" id="log_txt" class="form-control form-control-sm text-uppercase border-primary" placeholder="Escribe un evento o nota manual..."><button class="btn btn-primary btn-sm fw-bold" onclick="guardarLogManual()"><i class="fa-solid fa-paper-plane"></i></button></div></div></div></div></div>

<datalist id="listaGeocercas"></datalist><datalist id="listaConductores"></datalist><datalist id="listaUnidadesTotales"></datalist>

<script type="text/javascript">
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let currentUser = null, configSistema = { tokens: [] }, dataClientes = {}, viajesActivos = {};
    let unidadesGlobales = {}, ramDrivers = {}, geocercasNativas = [], activeSIDs = {}, pollingInterval = null;
    let lmap = null, mapVisible = false, mapLayerGroup = null;
    let estadoTokens = {}; 
    let datosAgrupadosGlobal = {}; 

    // SISTEMA GEOCODING NOMINATIM Y CACH√â
    let geocodeCache = JSON.parse(localStorage.getItem('tms_geoCache')) || {}; 
    let geoQueue = [];
    let isGeocoding = false;

    let hiddenCols = JSON.parse(localStorage.getItem('tms_hiddenCols')) || {
        'col-operador': false, 'col-ruta': false, 'col-contenedores': false, 'col-horarios': false, 'col-alertas': false, 'col-historial': false
    };

    window.estatusData = { 
        "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s3":{nombre:"1.2 RETEN",col:"#7D3F00"}, "s4":{nombre:"1.3 Resguardo",col:"#5C338A"}, "s5":{nombre:"1.4 REGRESANDO",col:"#D97706"}, "s6":{nombre:"2. Incidencia",col:"#DC2626"}, "s7":{nombre:"3. Cargando",col:"#5c6c7c"}, "s8":{nombre:"4. Descargando",col:"#336699"}, "s9":{nombre:"5. Patio GDL",col:"#17a2b8"}, "s10":{nombre:"6. Patio Reynosa",col:"#20c997"}, "s11":{nombre:"7. Taller",col:"#9CA3AF"}, "s12":{nombre:"8. Finalizado",col:"#0055A5"}, "s13":{nombre:"9. Baja cobertura",col:"#FBBF24"}, "s14":{nombre:"ALIMENTOS",col:"#F59E0B"} 
    };

    // MOTOR MATEM√ÅTICO DE GEOCERCAS WIALON (Point in Polygon / Circle / BBox)
    function isInsidePolygon(point, vs) {
        let x = point[0], y = point[1], inside = false;
        for (let i = 0, j = vs.length - 1; i < vs.length; j = i++) {
            let xi = vs[i].x, yi = vs[i].y, xj = vs[j].x, yj = vs[j].y;
            let intersect = ((yi > y) !== (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi);
            if (intersect) inside = !inside;
        }
        return inside;
    }

    function getDistanceMeters(lat1, lon1, lat2, lon2) {
        const R = 6371000; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
        const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    }

    function resolverGeocerca(lat, lon) {
        if(!geocercasNativas || geocercasNativas.length === 0) return null;
        for(let z of geocercasNativas) {
            if(!z.p) continue;
            if(z.b) { if(lon < z.b.min_x || lon > z.b.max_x || lat < z.b.min_y || lat > z.b.max_y) continue; }
            if(z.t === 3) { let r = z.p[0].r || 50; if(getDistanceMeters(lat, lon, z.p[0].y, z.p[0].x) <= r) return z.n; } 
            else { if(isInsidePolygon([lon, lat], z.p)) return z.n; }
        }
        return null;
    }

    function formatearFechaElegante(ms) {
        if (!ms) return "--:--";
        let d = new Date(ms); let meses = ["ene", "feb", "mar", "abr", "may", "jun", "jul", "ago", "sep", "oct", "nov", "dic"];
        return `${String(d.getDate()).padStart(2, '0')} ${meses[d.getMonth()]} ${String(d.getHours()).padStart(2, '0')}:${String(d.getMinutes()).padStart(2, '0')}`;
    }

    function getLocalISO(unixMillis) {
        if(!unixMillis) return ""; let tzoffset = (new Date()).getTimezoneOffset() * 60000;
        return (new Date(unixMillis - tz
