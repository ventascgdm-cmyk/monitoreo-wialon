<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Radiografía Geocercas MRL-501</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { background-color: #1e1e1e; color: #00ff00; font-family: monospace; padding: 20px; }
        .console-box { background: #000; border: 1px solid #00ff00; padding: 15px; border-radius: 5px; max-height: 300px; overflow-y: auto; white-space: pre-wrap; word-wrap: break-word; font-size: 0.85rem; color: #fff; margin-bottom: 20px; }
        h4 { color: #00ff00; border-bottom: 1px dashed #00ff00; padding-bottom: 5px; font-size: 1.1rem; text-transform: uppercase;}
        .btn-scan { background: #00ff00; color: #000; font-weight: bold; padding: 10px 20px; border: none; cursor: pointer; border-radius: 5px; margin-bottom: 20px; font-size: 1.2rem; }
        .btn-scan:hover { background: #00cc00; }
    </style>
</head>
<body>

    <h2><i class="fa fa-bug"></i> MODO DIAGNÓSTICO: GEOCERCAS MRL-501</h2>
    <p>Vamos a ver qué demonios está respondiendo Wialon cuando le preguntamos por la ubicación.</p>
    
    <button class="btn-scan" onclick="escanear()">INICIAR RADIOGRAFÍA DE GEOCERCAS</button>

    <div class="row">
        <div class="col-md-4">
            <h4>1. Posición GPS de MRL-501</h4>
            <div id="out-pos" class="console-box">Esperando...</div>
        </div>
        <div class="col-md-4">
            <h4>2. Recursos y sus Geocercas (Zonas)</h4>
            <div id="out-res" class="console-box">Esperando...</div>
        </div>
        <div class="col-md-4">
            <h4>3. Respuesta API Oficial (get_zones_by_unit)</h4>
            <div id="out-api" class="console-box">Esperando...</div>
        </div>
    </div>

<script>
const TOKEN = "c75483c3bfdfac7b23852ca21dae8939311C012BD70E829C09FDF344A903689C2C6A6418";
const HOST = "https://hst-api.wialon.com";
const ID_MRL501 = 600805211; // Ya sabemos que este es el ID del MRL-501 por la radiografía pasada

async function escanear() {
    document.getElementById("out-pos").innerText = "Consultando...";
    document.getElementById("out-res").innerText = "Consultando...";
    document.getElementById("out-api").innerText = "Consultando...";

    try {
        const login = await api(HOST, "token/login", { token: TOKEN });
        const sid = login.eid;
        if (!sid) throw "Error de sesión.";

        // 1. OBTENER POSICIÓN DE MRL-501 (Flag 1024)
        const unitReq = await api(HOST, "core/search_items", {
            spec: { itemsType: "avl_unit", propName: "sys_name", propValueMask: "MRL-501", sortType: "sys_name" },
            force: 1, flags: 1024, from: 0, to: 0
        }, sid);
        
        if (unitReq.items && unitReq.items.length > 0) {
            document.getElementById("out-pos").innerText = JSON.stringify(unitReq.items[0].pos, null, 4);
        } else {
            document.getElementById("out-pos").innerText = "No se encontró pos de MRL-501";
        }

        // 2. OBTENER TODOS LOS RECURSOS Y SUS GEOCERCAS (Flag 4096)
        const resReq = await api(HOST, "core/search_items", {
            spec: { itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
            force: 1, flags: 4096, from: 0, to: 0
        }, sid);

        let reporteZonas = "";
        let diccZoneIdParams = {}; // Esto lo vamos a armar para pasárselo a la API oficial
        
        if (resReq.items) {
            resReq.items.forEach(res => {
                let totalZonas = res.zl ? Object.keys(res.zl).length : 0;
                reporteZonas += `RECURSO ID: ${res.id}\nNombre: ${res.nm}\nTotal Geocercas: ${totalZonas}\n`;
                
                if (totalZonas > 0) {
                    diccZoneIdParams[res.id] = [];
                    // Mostrar los nombres de las primeras 3 zonas para no saturar la caja
                    let contador = 0;
                    Object.values(res.zl).forEach(z => {
                        diccZoneIdParams[res.id].push(z.id);
                        if (contador < 3) {
                            reporteZonas += `  -> [ID: ${z.id}] ${z.n}\n`;
                        }
                        contador++;
                    });
                    if (totalZonas > 3) reporteZonas += `  -> ...y ${totalZonas - 3} más\n`;
                }
                reporteZonas += "-------------------------\n";
            });
        }
        document.getElementById("out-res").innerText = reporteZonas;

        // 3. CONSULTAR API OFICIAL GET_ZONES_BY_UNIT
        const checkGeo = await api(HOST, "resource/get_zones_by_unit", {
            spec: { 
                zoneId: diccZoneIdParams, 
                units: [ID_MRL501], 
                time: 0 
            }
        }, sid);

        document.getElementById("out-api").innerText = JSON.stringify(checkGeo, null, 4);

    } catch (e) {
        document.getElementById("out-pos").innerText = "ERROR: " + e;
        document.getElementById("out-res").innerText = "ERROR: " + e;
        document.getElementById("out-api").innerText = "ERROR: " + e;
    }
}

function api(url, svc, params, sid = null) {
    return new Promise(resolve => {
        const cb = "cb_" + Math.random().toString(36).substring(7);
        window[cb] = d => { delete window[cb]; resolve(d); };
        const script = document.createElement("script");
        script.src = `${url}/wialon/ajax.html?svc=${svc}&params=${JSON.stringify(params)}&callback=${cb}${sid ? '&sid=' + sid : ''}`;
        document.head.appendChild(script);
    });
}
</script>
</body>
</html>
