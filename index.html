<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>Log√≠stica Cloud - Sistema TMS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>

    <style>
        body { background: #f0f2f5; color: #333; font-family: 'Segoe UI', sans-serif; font-size: 0.85rem; }
        .login-bg { background: #002a61; min-height: 100vh; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; }
        .login-card { background: white; width: 400px; border-radius: 20px; padding: 40px; }
        
        .header-bar { background: #002a61; color: white; padding: 15px 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .table-input { border: 1px solid #ced4da; padding: 4px; width: 100%; border-radius: 4px; font-size: 0.8rem; }
        .table-input:focus { border-color: #0d6efd; outline: none; }
        
        .group-img { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 5px; border: 2px solid #002a61; }
        .btn-action { font-size: 0.75rem; padding: 3px 8px; font-weight: bold; }
        
        th { cursor: pointer; user-select: none; }
        th:hover { background-color: #e9ecef !important; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card shadow-lg text-center">
        <h3 class="text-primary fw-bold mb-3">Log√≠stica Cloud 2.0</h3>
        <p class="text-muted small mb-4">Control de Viajes y Grupos</p>
        <input type="password" id="token" class="form-control mb-4 text-center py-2" placeholder="Wialon API Token">
        <button onclick="login()" class="btn btn-primary w-100 fw-bold py-2 shadow">Conectar Sistema</button>
        <div id="status" class="mt-4 small fw-bold text-secondary">Verificando SDK...</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center mb-4">
        <h4 class="fw-bold m-0">BIT√ÅCORA DE VIAJES ACTIVOS</h4>
        <div>
            <button class="btn btn-light btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje">‚ûï Nuevo Viaje</button>
            <button class="btn btn-light btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalGrupos">üìÅ Grupos</button>
            <button class="btn btn-warning btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalHistorial">üìú Historial</button>
            <button onclick="exportarExcel()" class="btn btn-success btn-sm fw-bold">üì• Excel</button>
        </div>
    </div>

    <div class="container-fluid px-4">
        <div class="row mb-3">
            <div class="col-md-4">
                <input type="text" id="buscador" class="form-control shadow-sm" placeholder="üîç Filtrar por unidad, origen, destino..." onkeyup="filtrarTabla()">
            </div>
        </div>

        <div class="card shadow border-0">
            <div class="table-responsive" style="min-height: 70vh;">
                <table class="table table-hover align-middle text-center mb-0" id="tablaViajes">
                    <thead class="table-dark">
                        <tr>
                            <th onclick="ordenar(0)">Unidad ‚Üï</th>
                            <th onclick="ordenar(1)">Grupo ‚Üï</th>
                            <th>Origen</th>
                            <th>Destino</th>
                            <th>Estatus</th>
                            <th>Comentarios</th>
                            <th onclick="ordenar(6)">Vel. ‚Üï</th>
                            <th onclick="ordenar(7)">√öltimo Msj ‚Üï</th>
                            <th>Ubicaci√≥n</th>
                            <th>Acci√≥n</th>
                        </tr>
                    </thead>
                    <tbody id="units-body"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-primary text-white"><h5 class="modal-title fw-bold">Asignar Unidad a Viaje</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <label class="fw-bold small">Seleccionar Unidad Disponible:</label>
          <select id="nv_unidad" class="form-select mb-3"></select>
          <label class="fw-bold small">Asignar Grupo:</label>
          <select id="nv_grupo" class="form-select mb-3"></select>
          <button onclick="iniciarViaje()" class="btn btn-primary w-100 fw-bold">Comenzar Viaje</button>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalGrupos" tabindex="-1">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header bg-dark text-white"><h5 class="modal-title fw-bold">Administrar Grupos</h5><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div class="d-flex mb-3">
              <input type="text" id="mg_nombre" class="form-control me-2" placeholder="Nombre (Ej. Ruta Norte)">
              <input type="text" id="mg_img" class="form-control me-2" placeholder="URL Imagen (opcional)">
              <button onclick="crearGrupo()" class="btn btn-success fw-bold">Crear</button>
          </div>
          <ul class="list-group" id="listaGrupos"></ul>
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="modalHistorial" tabindex="-1">
  <div class="modal-dialog modal-xl">
    <div class="modal-content">
      <div class="modal-header bg-warning"><h5 class="modal-title fw-bold">Historial de Viajes Finalizados</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
      <div class="modal-body">
          <div class="table-responsive">
              <table class="table table-sm table-striped text-center text-nowrap">
                  <thead class="table-dark"><tr><th>Unidad</th><th>Inicio</th><th>Fin</th><th>Origen</th><th>Destino</th><th>Comentarios</th></tr></thead>
                  <tbody id="listaHistorial"></tbody>
              </table>
          </div>
      </div>
    </div>
  </div>
</div>

<script type="text/javascript">
    // 1. CONFIGURACI√ìN FIREBASE
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // Variables Globales
    let dataGrupos = {};
    let viajesActivos = {};
    let unidadesWialon = [];

    // 2. ARRANQUE
    window.onload = function () {
        if (typeof wialon !== 'undefined') {
            document.getElementById("status").innerHTML = "SDK Listo ‚úÖ";
            document.getElementById("status").className = "mt-4 small fw-bold text-success";
        } else {
            document.getElementById("status").innerHTML = "Error: El SDK no carg√≥.";
            document.getElementById("status").className = "mt-4 small fw-bold text-danger";
        }
        
        // Cargar listas de Firebase en tiempo real
        db.ref('grupos').on('value', s => { dataGrupos = s.val() || {}; actualizarListasGrupos(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; });
        db.ref('historial').on('value', s => { renderizarHistorial(s.val() || {}); });
    };

    function login() {
        const token = document.getElementById("token").value;
        if (!token) return alert("Ingresa tu token primero");
        if (typeof wialon === 'undefined') return alert("SDK no disponible.");

        document.getElementById("status").innerText = "Conectando...";
        const sess = wialon.core.Session.getInstance();
        sess.initSession("https://hst-api.wialon.com");
        
        sess.loginToken(token, "", function (code) {
            if (code) return alert("Error de Acceso: " + wialon.core.Errors.getErrorText(code));
            
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("dashboard").style.display = "block";
            
            sess.loadLibrary("itemUnit");
            sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], function () {
                unidadesWialon = sess.getItems("avl_unit") || [];
                actualizarSelectUnidades();
                renderizarBitacora();
                sess.addListener("dataUpdated", renderizarBitacora); // Actualizaci√≥n en tiempo real Wialon
            });
        });
    }

    // 3. BIT√ÅCORA Y VIAJES
    function iniciarViaje() {
        const uId = document.getElementById("nv_unidad").value;
        const gId = document.getElementById("nv_grupo").value;
        if (!uId) return alert("Selecciona una unidad.");
        
        db.ref('viajes_activos/' + uId).set({
            grupo: gId, origen: "", destino: "", estatus: "Disponible", comentarios: "", 
            inicioTs: Date.now()
        });
        
        const modal = bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje'));
        modal.hide();
        renderizarBitacora();
    }

    function finalizarViaje(id, nombre) {
        if(!confirm(`¬øFinalizar el viaje de la unidad ${nombre}? Se guardar√° en el historial.`)) return;
        
        const viaje = viajesActivos[id];
        viaje.unidad = nombre;
        viaje.finTs = Date.now();
        
        db.ref('historial').push(viaje);
        db.ref('viajes_activos/' + id).remove();
        renderizarBitacora();
        actualizarSelectUnidades();
    }

    // 4. TABLA PRINCIPAL (Se dibuja SOLO con las unidades en "viajes_activos")
    function renderizarBitacora() {
        const tbody = document.getElementById('units-body');
        let html = "";

        unidadesWialon.forEach(u => {
            const id = u.getId();
            // Si la unidad NO tiene viaje activo en Firebase, la saltamos
            if (!viajesActivos[id]) return;

            const viaje = viajesActivos[id];
            const pos = u.getPosition();
            const speed = pos ? pos.s : 0;
            const mov = speed > 0;
            
            // C√°lculo del √∫ltimo mensaje
            let lastMsgTxt = "N/D";
            if (pos && pos.t) {
                const date = new Date(pos.t * 1000); // Wialon da el tiempo en segundos (Unix)
                lastMsgTxt = date.toLocaleString('es-MX', {day:'2-digit', month:'short', hour:'2-digit', minute:'2-digit'});
            }

            // Opciones del Grupo
            let opcionesGrupo = `<option value="">Sin Grupo</option>`;
            Object.keys(dataGrupos).forEach(k => {
                const selected = viaje.grupo === k ? "selected" : "";
                opcionesGrupo += `<option value="${k}" ${selected}>${dataGrupos[k].nombre}</option>`;
            });

            // Imagen del grupo actual
            const imgGrupo = (viaje.grupo && dataGrupos[viaje.grupo] && dataGrupos[viaje.grupo].imagen) 
                           ? `<img src="${dataGrupos[viaje.grupo].imagen}" class="group-img">` 
                           : '';

            html += `<tr>
                <td class="fw-bold text-primary">${u.getName()}</td>
                <td class="d-flex align-items-center justify-content-center">
                    ${imgGrupo}
                    <select class="form-select form-select-sm w-auto" onchange="guardar('${id}','grupo',this.value)">${opcionesGrupo}</select>
                </td>
                <td><input class="table-input" value="${viaje.origen||''}" onblur="guardar('${id}','origen',this.value)"></td>
                <td><input class="table-input" value="${viaje.destino||''}" onblur="guardar('${id}','destino',this.value)"></td>
                <td>
                    <select class="table-input" onchange="guardar('${id}','estatus',this.value)">
                        <option value="Disponible" ${viaje.estatus==='Disponible'?'selected':''}>Disponible</option>
                        <option value="En Tr√°nsito" ${viaje.estatus==='En Tr√°nsito'?'selected':''}>En Tr√°nsito</option>
                        <option value="Cargando" ${viaje.estatus==='Cargando'?'selected':''}>Cargando</option>
                    </select>
                </td>
                <td><input class="table-input text-warning fw-bold" value="${viaje.comentarios||''}" placeholder="Escribe aqu√≠..." onblur="guardar('${id}','comentarios',this.value)"></td>
                <td class="fw-bold ${mov?'text-success':'text-danger'}">${speed} km/h</td>
                <td class="small text-muted">${lastMsgTxt}</td>
                <td id="addr_${id}" style="font-size:0.7rem; color:#666; font-style:italic;">Buscando...</td>
                <td><button onclick="finalizarViaje('${id}', '${u.getName()}')" class="btn btn-danger btn-action">Finalizar</button></td>
            </tr>`;
            
            if (pos) {
                wialon.util.Gis.getLocations([{lon: pos.x, lat: pos.y}], function(code, addr) {
                    const el = document.getElementById(`addr_${id}`);
                    if (el && addr) el.innerText = addr[0];
                });
            }
        });
        
        // Si el usuario no est√° filtrando/escribiendo, actualizar html
        if(document.activeElement.tagName !== "INPUT" && document.activeElement.tagName !== "SELECT") {
             tbody.innerHTML = html;
        }
    }

    function guardar(id, campo, valor) {
        db.ref(`viajes_activos/${id}/${campo}`).set(valor);
    }

    // 5. GESTI√ìN DE GRUPOS
    function crearGrupo() {
        const nom = document.getElementById("mg_nombre").value;
        const img = document.getElementById("mg_img").value;
        if (!nom) return alert("El nombre es obligatorio");
        db.ref('grupos').push({ nombre: nom, imagen: img || "https://cdn-icons-png.flaticon.com/512/3063/3063822.png" });
        document.getElementById("mg_nombre").value = "";
        document.getElementById("mg_img").value = "";
    }

    function actualizarListasGrupos() {
        const sel = document.getElementById("nv_grupo");
        const list = document.getElementById("listaGrupos");
        sel.innerHTML = `<option value="">Seleccionar Grupo (Opcional)</option>`;
        list.innerHTML = "";
        
        Object.keys(dataGrupos).forEach(k => {
            const g = dataGrupos[k];
            sel.innerHTML += `<option value="${k}">${g.nombre}</option>`;
            list.innerHTML += `<li class="list-group-item d-flex justify-content-between align-items-center">
                <div><img src="${g.imagen}" class="group-img">${g.nombre}</div>
                <button onclick="db.ref('grupos/${k}').remove()" class="btn btn-sm btn-outline-danger">X</button>
            </li>`;
        });
        // Refrescar bit√°cora si estamos logueados
        if(unidadesWialon.length > 0) renderizarBitacora();
    }

    function actualizarSelectUnidades() {
        const sel = document.getElementById("nv_unidad");
        sel.innerHTML = `<option value="">Seleccionar Unidad Libre...</option>`;
        unidadesWialon.forEach(u => {
            if (!viajesActivos[u.getId()]) { // Solo unidades que no est√©n en viaje
                sel.innerHTML += `<option value="${u.getId()}">${u.getName()}</option>`;
            }
        });
    }

    // 6. HISTORIAL Y EXTRAS
    function renderizarHistorial(data) {
        let html = "";
        Object.keys(data).reverse().forEach(k => {
            const h = data[k];
            const fInicio = h.inicioTs ? new Date(h.inicioTs).toLocaleDateString() : 'N/D';
            const fFin = h.finTs ? new Date(h.finTs).toLocaleDateString() : 'N/D';
            html += `<tr><td>${h.unidad||'N/D'}</td><td>${fInicio}</td><td>${fFin}</td><td>${h.origen||''}</td><td>${h.destino||''}</td><td>${h.comentarios||''}</td></tr>`;
        });
        document.getElementById("listaHistorial").innerHTML = html;
    }

    function filtrarTabla() {
        const txt = document.getElementById("buscador").value.toLowerCase();
        const filas = document.querySelectorAll("#units-body tr");
        filas.forEach(f => {
            f.style.display = f.innerText.toLowerCase().includes(txt) ? "" : "none";
        });
    }

    function ordenar(columnaIdx) {
        const tabla = document.getElementById("tablaViajes");
        const tbody = document.getElementById("units-body");
        const filas = Array.from(tbody.querySelectorAll("tr"));
        
        // Determinar direcci√≥n de orden (asc o desc) alternando por clics
        const asc = tabla.getAttribute("data-orden") === "asc";
        tabla.setAttribute("data-orden", asc ? "desc" : "asc");
        
        filas.sort((a, b) => {
            const valA = a.cells[columnaIdx].innerText.toLowerCase();
            const valB = b.cells[columnaIdx].innerText.toLowerCase();
            if (valA < valB) return asc ? -1 : 1;
            if (valA > valB) return asc ? 1 : -1;
            return 0;
        });
        filas.forEach(f => tbody.appendChild(f));
    }

    function exportarExcel() {
        // Simple export para Active Trips
        let csv = "\uFEFFUNIDAD,GRUPO,ORIGEN,DESTINO,ESTATUS,COMENTARIOS,VELOCIDAD,√öLTIMO MSJ,DIRECCI√ìN\n";
        document.querySelectorAll("#units-body tr").forEach(row => {
            if(row.style.display !== "none") {
                const i = row.querySelectorAll("input, select");
                const grupoTxt = i[0].options[i[0].selectedIndex].text;
                csv += `${row.cells[0].innerText},${grupoTxt},${i[1].value},${i[2].value},${i[3].value},${i[4].value},${row.cells[6].innerText},${row.cells[7].innerText},${row.cells[8].innerText.replace(/,/g, " ")}\n`;
            }
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Bitacora_Activa.csv";
        link.click();
    }
</script>
</body>
</html>
