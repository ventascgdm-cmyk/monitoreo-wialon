<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4 - RACEL Ready</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; margin: 0; overflow: hidden;}
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); display: flex; justify-content: space-between; align-items: center; }
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 75px); width: 100%; }
        .map-panel { height: 0%; width: 100%; transition: height 0.4s ease; border-bottom: 0 solid var(--header-bg); position: relative; z-index: 10; overflow: hidden; }
        .workspace-container.show-map .map-panel { height: 40%; }
        .table-panel { height: 100%; overflow-y: auto; padding: 15px; }
        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 1rem; font-weight: bold; text-align: left; padding: 10px !important; }
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding: 8px 25px !important; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.7rem; font-weight: 700; text-align: center; }
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; background: var(--table-bg); text-transform: uppercase;}
        .diag-pill { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-weight: bold; }
        .diag-ok { background: #d1e7dd; color: #0f5132; }
        .diag-err { background: #f8d7da; color: #842029; }
    </style>
</head>
<body>

<div id="dashboard">
    <div class="header-bar shadow-sm">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 45px;" class="me-3" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
            <div><h5 class="fw-bold m-0">GRUDICOM TI & GPS</h5><div id="tokenStatus"></div></div>
        </div>
        <div class="d-flex">
            <button class="btn btn-info btn-sm fw-bold me-2" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Mapa</button>
            <button class="btn btn-primary btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje"><i class="fa-solid fa-plus"></i> Registrar Viaje</button>
            <button class="btn btn-danger btn-sm fw-bold" onclick="location.reload()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map" style="height: 100%;"></div></div>
        <div class="table-panel">
            <div class="card shadow border-0">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center mb-0" id="mainTable">
                        <tbody id="units-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h6>NUEVO REGISTRO DE VIAJE</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body small">
        <div class="row mb-2">
            <div class="col-6"><label>Cliente:</label><select id="nv_c" class="form-select form-select-sm" onchange="actualizarSubSelect(this.value)"></select></div>
            <div class="col-6"><label>Subcliente:</label><select id="nv_s" class="form-select form-select-sm"></select></div>
        </div>
        <label>Unidad GPS:</label><input type="text" id="nv_u" class="form-control form-control-sm mb-2" list="dl_u" placeholder="RACEL-...">
        <label>Operador:</label><input type="text" id="nv_o" class="form-control form-control-sm mb-2" list="dl_d">
        <div class="row mb-3">
            <div class="col-6"><label>Origen:</label><input type="text" id="nv_or" class="form-control form-control-sm" list="dl_g"></div>
            <div class="col-6"><label>Destino:</label><input type="text" id="nv_de" class="form-control form-control-sm" list="dl_g"></div>
        </div>
        <button onclick="guardarViaje()" class="btn btn-primary w-100 fw-bold">INICIAR VIAJE</button>
    </div>
</div></div></div>

<datalist id="dl_u"></datalist><datalist id="dl_d"></datalist><datalist id="dl_g"></datalist>

<script>
    const db = firebase.database({ databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" });
    let dataClientes = {}, viajesActivos = {}, unidadesWialon = {}, conductoresWialon = {}, activeSIDs = {}, lmap = null;

    const estatusData = { "s1":{n:"Ruta",c:"#0F7D42"}, "s2":{n:"Parado",c:"#B50000"}, "s11":{n:"Finalizado",c:"#0055A5"} };

    function init() {
        db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; renderizar(); actualizarModals(); });
        db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; renderizar(); });
        
        // MOTOR MULTI-HOST
        db.ref('sistema/tokens').on('value', s => {
            const tks = s.val() ? Object.values(s.val()) : [];
            document.getElementById("tokenStatus").innerHTML = "";
            tks.forEach(tk => conectarWialon(tk));
        });
    }

    function conectarWialon(tk) {
        let sc = document.createElement("script"), cb = "w_"+Math.random().toString(36).substr(2,5);
        window[cb] = (d) => {
            const diag = document.getElementById("tokenStatus");
            if(d && d.eid) {
                activeSIDs[tk.token] = d.eid;
                diag.innerHTML += `<span class="diag-pill diag-ok">${tk.nombre}: Online</span>`;
                descargarData(tk, d.eid);
            } else {
                diag.innerHTML += `<span class="diag-pill diag-err">${tk.nombre}: Error</span>`;
            }
            sc.remove();
        };
        // Usa la URL guardada en Firebase para RACEL o Wialon
        sc.src = `${tk.url || 'https://hst-api.wialon.com'}/wialon/ajax.html?svc=token/login&params={"token":"${tk.token}"}&callback=${cb}`;
        document.head.appendChild(sc);
    }

    function descargarData(tk, sid) {
        // Unidades
        let sc = document.createElement("script"), cb = "u_"+Math.random().toString(36).substr(2,5);
        window[cb] = (d) => {
            if(d && d.items) d.items.forEach(u => { unidadesWialon[u.id] = u; });
            actualizarDatalists(); renderizar(); sc.remove();
        };
        sc.src = `${tk.url || 'https://hst-api.wialon.com'}/wialon/ajax.html?svc=core/search_items&params={"spec":{"itemsType":"avl_unit","propName":"sys_name","propValueMask":"*","sortType":"sys_name"},"force":1,"flags":1025}&sid=${sid}&callback=${cb}`;
        document.head.appendChild(sc);
    }

    function renderizar() {
        if(document.activeElement.tagName === "INPUT") return;
        const tbody = document.getElementById('units-body');
        let html = "";
        
        Object.keys(dataClientes).forEach(cId => {
            html += `<tr><td colspan="7" class="header-cliente shadow">ðŸ“¦ CLIENTE: ${dataClientes[cId].nombre}</td></tr>`;
            const sub = dataClientes[cId].subclientes || { "N/A": {nombre: "GENERAL"} };
            
            Object.keys(sub).forEach(sId => {
                html += `<tr><td colspan="7" class="header-subcliente">â†³ ${sub[sId].nombre}</td></tr>`;
                html += `<tr class="header-columnas"><th>UNIDAD</th><th>OPERADOR</th><th>RUTA</th><th>ðŸ“¦</th><th>ESTATUS</th><th>GPS</th><th>ACCIONES</th></tr>`;
                
                Object.keys(viajesActivos).forEach(vId => {
                    const v = viajesActivos[vId];
                    if(v.cliente === cId && (v.subcliente === sId || sId === "N/A")) {
                        const u = unidadesWialon[vId] || { pos: {s:0, t:0} };
                        const sp = u.pos ? u.pos.s : 0;
                        html += `<tr>
                            <td class="fw-bold text-primary">${v.unidadN}</td>
                            <td><input class="table-input" value="${v.operador||''}" onblur="db.ref('viajes_activos/'+vId+'/operador').set(this.value.toUpperCase())"></td>
                            <td>${v.origen||''} âž” ${v.destino||''}</td>
                            <td><textarea class="table-input" rows="1">${v.contenedores||''}</textarea></td>
                            <td><select class="status-select" style="background:${estatusData[v.estatus]?.c}" onchange="db.ref('viajes_activos/'+vId+'/estatus').set(this.value)">
                                ${Object.keys(estatusData).map(k=>`<option value="${k}" ${v.estatus===k?'selected':''}>${estatusData[k].n}</option>`).join('')}
                            </select></td>
                            <td><span class="badge ${sp>0?'bg-success':'bg-secondary'}">${sp} km/h</span></td>
                            <td><button class="btn btn-success btn-sm" onclick="sendWA('${vId}')"><i class="fa-brands fa-whatsapp"></i></button></td>
                        </tr>`;
                    }
                });
            });
        });
        tbody.innerHTML = html || '<tr><td colspan="7" class="p-5 text-muted">Configura Clientes y Tokens en el botÃ³n Admin.</td></tr>';
    }

    function actualizarDatalists() {
        document.getElementById("dl_u").innerHTML = Object.values(unidadesWialon).map(u => `<option value="${u.nm.toUpperCase()}">`).join('');
    }

    function guardarViaje() {
        const uN = document.getElementById("nv_u").value.toUpperCase();
        let uId = "M-" + Date.now();
        Object.keys(unidadesWialon).forEach(id => { if(unidadesWialon[id].nm.toUpperCase() === uN) uId = id; });

        db.ref('viajes_activos/' + uId).set({
            unidadN: uN, operador: document.getElementById("nv_o").value.toUpperCase(),
            cliente: document.getElementById("nv_c").value, subcliente: document.getElementById("nv_s").value,
            origen: document.getElementById("nv_or").value.toUpperCase(), destino: document.getElementById("nv_de").value.toUpperCase(),
            estatus: "s1"
        });
        bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide();
    }

    function actualizarModals() {
        const sel = document.getElementById("nv_c");
        sel.innerHTML = Object.keys(dataClientes).map(id => `<option value="${id}">${dataClientes[id].nombre}</option>`).join('');
        actualizarSubSelect(sel.value);
    }

    function actualizarSubSelect(cId) {
        const sel = document.getElementById("nv_s");
        const sub = dataClientes[cId]?.subclientes || {};
        sel.innerHTML = '<option value="N/A">GENERAL</option>' + Object.keys(sub).map(id => `<option value="${id}">${sub[id].nombre}</option>`).join('');
    }

    function toggleMap() { document.getElementById("mainWorkspace").classList.toggle("show-map"); if(!lmap) { lmap = L.map('map').setView([23.6, -102.5], 5); L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png').addTo(lmap); } setTimeout(()=>lmap.invalidateSize(), 400); }

    init();
</script>
</body>
</html>
