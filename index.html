<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body.dark-mode { --bg-main: #121212; --bg-card: #1e1e1e; --text-main: #e0e0e0; --header-bg: #0d1b2a; --table-bg: #2c2c2c; --border-col: #444; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; transition: 0.3s; margin: 0; overflow: hidden;}
        
        .login-bg { background: #001a33; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 400px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); }
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 75px); width: 100%; }
        
        .map-panel { height: 0%; width: 100%; transition: height 0.4s ease; border-bottom: 0 solid var(--header-bg); position: relative; z-index: 10; overflow: hidden; }
        .workspace-container.show-map .map-panel { height: 40%; border-bottom: 4px solid var(--header-bg); }
        .table-panel { height: 100%; width: 100%; transition: height 0.4s ease; overflow-y: auto; padding: 15px; }
        .workspace-container.show-map .table-panel { height: 60%; }
        #map { width: 100%; height: 100%; }

        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 1rem; font-weight: bold; text-align: left; padding: 10px !important; }
        .header-subcliente { background-color: #5c6c7c !important; color: white !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding: 8px 25px !important; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.7rem; font-weight: 700; text-align: center; vertical-align: middle; }
        
        .lost-connection-row td { background-color: #ffe6e6 !important; color: #990000 !important; }
        .dark-mode .lost-connection-row td { background-color: #4a1515 !important; color: #ffcccc !important; }
        
        .unit-name { cursor: pointer; text-decoration: underline; color: #0d6efd; font-weight: bold; }
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; background: var(--table-bg); color: var(--text-main); text-transform: uppercase;}
        
        .diag-pill { font-size: 10px; padding: 2px 8px; border-radius: 10px; margin-left: 5px; font-weight: bold; }
        .diag-ok { background: #d1e7dd; color: #0f5132; }
        .diag-error { background: #f8d7da; color: #842029; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="width: 220px; margin-bottom: 25px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
        <h5 class="text-primary fw-bold mb-4">GRUDICOM TI & GPS</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a">
        <button id="btnIngresar" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Presiona Enter para entrar</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 45px;" class="me-3">
            <div>
                <h5 class="fw-bold m-0" style="color: var(--header-bg);">C4 - BIT√ÅCORA GRUDICOM TI & GPS</h5>
                <small class="text-muted fw-bold" id="lblUsuarioActivo">Monitor: ...</small>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <div id="tokenDiagnostics" class="me-3 d-flex"></div>
            <button class="btn btn-info btn-sm fw-bold me-2" onclick="toggleMap()"><i class="fa-solid fa-map"></i> Mapa</button>
            <button class="btn btn-outline-primary btn-sm fw-bold me-2" data-bs-toggle="modal" data-bs-target="#modalNuevoViaje" onclick="prepararNuevoViaje()"><i class="fa-solid fa-truck-fast"></i> Nuevo Viaje</button>
            <button class="btn btn-danger btn-sm fw-bold" id="btnAdmin" style="display:none;" data-bs-toggle="modal" data-bs-target="#modalAdmin"><i class="fa-solid fa-gears"></i></button>
            <button class="btn btn-secondary btn-sm fw-bold ms-2" onclick="cerrarSesion()"><i class="fa-solid fa-power-off"></i></button>
        </div>
    </div>

    <div class="workspace-container" id="mainWorkspace">
        <div class="map-panel"><div id="map"></div></div>
        <div class="table-panel">
            <div class="row mb-2">
                <div class="col-md-4"><input type="text" id="buscador" class="form-control form-control-sm shadow-sm" placeholder="üîç Filtrar bit√°cora..." onkeyup="filtrarTabla()"></div>
            </div>
            <div class="card shadow border-0 h-100">
                <div class="table-responsive h-100">
                    <table class="table table-bordered align-middle text-center mb-0" id="mainTable"><tbody id="units-body"></tbody></table>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="modalNuevoViaje" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-primary text-white"><h6 class="modal-title fw-bold">REGISTRAR NUEVO VIAJE</h6><button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button></div>
    <div class="modal-body small">
        <label class="fw-bold">Unidad GPS:</label><input type="text" class="form-control form-control-sm mb-2" list="listaUnidadesTotales" id="nv_unidad_input" autocomplete="off" placeholder="Ej. RACEL-01">
        <label class="fw-bold">Operador:</label><input type="text" id="nv_operador" class="form-control form-control-sm mb-2 border-primary" list="listaConductores" autocomplete="off" placeholder="Nombre ch√≥fer">
        <div class="row mb-2">
            <div class="col-6"><label class="fw-bold">Cliente:</label><select id="nv_cliente" class="form-select form-select-sm" onchange="cargarSubclientesEnSelect('nv_subcliente', this.value)"></select></div>
            <div class="col-6"><label class="fw-bold">Subcliente:</label><select id="nv_subcliente" class="form-select form-select-sm"><option value="">N/A</option></select></div>
        </div>
        <div class="row">
            <div class="col-6"><label class="fw-bold">Origen:</label><input type="text" id="nv_origen" class="form-control form-control-sm mb-2" list="listaGeocercas" placeholder="Salida"></div>
            <div class="col-6"><label class="fw-bold">Destino:</label><input type="text" id="nv_destino" class="form-control form-control-sm mb-2" list="listaGeocercas" placeholder="Llegada"></div>
        </div>
        <button onclick="registrarViaje()" class="btn btn-primary w-100 fw-bold mt-2">GUARDAR VIAJE</button>
    </div>
</div></div></div>

<datalist id="listaGeocercas"></datalist><datalist id="listaConductores"></datalist><datalist id="listaUnidadesTotales"></datalist>

<script type="text/javascript">
    const db = firebase.database();
    let currentUser = null, dataClientes = {}, viajesActivos = {};
    let configTokens = [], unidadesWialon = {}, ramDrivers = {}, activeSIDs = {}, pollingInterval = null, lmap = null;

    const estatusData = { "s1":{nombre:"1. Ruta",col:"#0F7D42"}, "s2":{nombre:"1.1 PARADO",col:"#B50000"}, "s3":{nombre:"1.2 RETEN",col:"#7D3F00"}, "s4":{nombre:"1.3 Resguardo",col:"#5C338A"}, "s5":{nombre:"2. Incidencia",col:"#FFCCCC"}, "s6":{nombre:"3. Cargando",col:"#EAEAEA"}, "s7":{nombre:"4. Descargando",col:"#D0F0C0"}, "s8":{nombre:"5. Patio GDL",col:"#BCE3F9"}, "s9":{nombre:"6. Patio Reynosa",col:"#C2DEDB"}, "s10":{nombre:"7. Taller",col:"#B5A6A6"}, "s11":{nombre:"8. Finalizado",col:"#0055A5"} };

    // 1. LOGIN BLINDADO (ENTER)
    document.getElementById("logPass").addEventListener("keyup", e => { if (e.key === "Enter") autenticarUsuario(); });
    document.getElementById("logUser").addEventListener("keyup", e => { if (e.key === "Enter") document.getElementById("logPass").focus(); });
    document.getElementById("btnIngresar").onclick = autenticarUsuario;

    function autenticarUsuario() {
        const u = document.getElementById("logUser").value.trim() || localStorage.getItem("tms_user");
        const p = document.getElementById("logPass").value.trim() || localStorage.getItem("tms_pass");
        if(!u || !p) return;
        
        document.getElementById("status").innerText = "Validando en Firebase...";
        db.ref('sistema/usuarios/' + u).once('value', s => {
            const user = s.val();
            if(user && user.pass === p) {
                currentUser = user;
                localStorage.setItem("tms_user", u);
                localStorage.setItem("tms_pass", p);
                // ENTRADA INMEDIATA
                document.getElementById("loginOverlay").style.display = "none";
                document.getElementById("dashboard").style.display = "block";
                document.getElementById("lblUsuarioActivo").innerText = "Monitor: " + u;
                if(user.rol === "admin") document.getElementById("btnAdmin").style.display = "inline-block";
                
                // DESPERTAR WIALON EN SEGUNDO PLANO
                arranqueWialon();
            } else {
                document.getElementById("status").innerHTML = "<span class='text-danger'>Error de acceso</span>";
            }
        });
    }

    // 2. RENDERIZADO DE TABLA (PRIORIDAD FIREBASE)
    function renderizarBitacora() {
        if(document.activeElement.tagName === "INPUT") return;
        const tbody = document.getElementById('units-body');
        let html = "";
        let tree = { "Sin_Cliente": { "N/A": [] } };

        // Construir √°rbol basado en Clientes registrados en Firebase
        Object.keys(dataClientes).forEach(cId => {
            tree[cId] = { "N/A": [] };
            if(dataClientes[cId].subclientes) {
                Object.keys(dataClientes[cId].subclientes).forEach(sId => tree[cId][sId] = []);
            }
        });

        // Llenar √°rbol con viajes de Firebase
        Object.keys(viajesActivos).forEach(vId => {
            let v = viajesActivos[vId];
            let u = unidadesWialon[vId] || { nm: v.unidadN, pos: null };
            let cId = v.cliente || "Sin_Cliente";
            let sId = v.subcliente || "N/A";
            if(!tree[cId]) tree[cId] = { "N/A": [] };
            if(!tree[cId][sId]) tree[cId][sId] = [];
            tree[cId][sId].push({vId, v, u});
        });

        const hCols = `<tr class="header-columnas"><th>UNIDAD</th><th>OPERADOR</th><th>RUTA (O ‚ûî D)</th><th>üì¶</th><th>HORARIOS</th><th>ESTATUS</th><th>GPS</th><th>ACCI√ìN</th></tr>`;

        for(let cId in tree) {
            let hasUnits = false, cliH = "", cliD = dataClientes[cId] || {nombre: "SIN CLIENTE ASIGNADO"};
            for(let sId in tree[cId]) {
                if(tree[cId][sId].length === 0) continue;
                hasUnits = true;
                if(sId !== "N/A") cliH += `<tr><td colspan="8" class="header-subcliente">‚Ü≥ Subcliente: ${dataClientes[cId].subclientes[sId].nombre}</td></tr>`;
                cliH += hCols;
                tree[cId][sId].forEach(({vId, v, u}) => {
                    let sp = u.pos ? u.pos.s : 0, spB = sp === 0 ? "bg-secondary" : (sp < 100 ? "bg-success" : "bg-danger");
                    let lastT = u.pos ? u.pos.t : 0, diffMin = (Date.now()/1000 - lastT) / 60, lost = (diffMin > 10 && lastT > 0);
                    cliH += `<tr class="${lost?'lost-connection-row':''}">
                        <td class="unit-name">${v.unidadN}</td>
                        <td><input class="table-input" value="${v.operador||ramDrivers[v.unidadN]||''}" onblur="db.ref('viajes_activos/'+vId+'/operador').set(this.value.toUpperCase())"></td>
                        <td><input class="table-input mb-1" value="${v.origen||''}" onblur="db.ref('viajes_activos/'+vId+'/origen').set(this.value.toUpperCase())"><input class="table-input" value="${v.destino||''}" onblur="db.ref('viajes_activos/'+vId+'/destino').set(this.value.toUpperCase())"></td>
                        <td><textarea class="table-input" placeholder="üì¶" onblur="db.ref('viajes_activos/'+vId+'/contenedores').set(this.value.toUpperCase())">${v.contenedores||''}</textarea></td>
                        <td><button class="btn btn-sm btn-outline-success w-100 mb-1" onclick="db.ref('viajes_activos/'+vId+'/t_salida').set(Date.now())">${v.t_salida?new Date(v.t_salida).toLocaleTimeString():'Salida'}</button></td>
                        <td><select class="form-select status-select" style="background:${estatusData[v.estatus]?.col}" onchange="db.ref('viajes_activos/'+vId+'/estatus').set(this.value)">${Object.keys(estatusData).map(k=>`<option value="${k}" ${v.estatus===k?'selected':''}>${estatusData[k].nombre}</option>`).join('')}</select></td>
                        <td><span class="badge ${spB}">${sp} km/h</span><br><small>${u.pos?formatTimeFriendly(lastT):'Desconectado'}</small></td>
                        <td><button onclick="shareWA('${vId}')" class="btn btn-success btn-sm"><i class="fa-brands fa-whatsapp"></i></button></td>
                    </tr>`;
                });
            }
            if(hasUnits) html += `<tr><td colspan="8" class="header-cliente">üì¶ CLIENTE: ${cliD.nombre}</td></tr>` + cliH;
        }
        tbody.innerHTML = html;
    }

    // 3. MOTOR WIALON (SIN BLOQUEOS)
    function peticionWialon(url, svc, params, sid=null) {
        return new Promise(resolve => {
            let script = document.createElement("script"), cb = "w_cb_" + Date.now() + Math.floor(Math.random()*100);
            window[cb] = d => { delete window[cb]; script.remove(); resolve(d); };
            script.src = `${url.replace(/\/$/, '')}/wialon/ajax.html?svc=${svc}&params=${encodeURIComponent(JSON.stringify(params))}&callback=${cb}${sid?'&sid='+sid:''}`;
            script.onerror = () => { delete window[cb]; script.remove(); resolve({error: 1}); };
            document.head.appendChild(script);
        });
    }

    async function arranqueWialon() {
        db.ref('sistema/tokens').on('value', async s => {
            configTokens = s.val() ? Object.values(s.val()) : [];
            if(pollingInterval) clearInterval(pollingInterval);
            await sincronizar();
            pollingInterval = setInterval(sincronizar, 25000);
        });
    }

    async function sincronizar() {
        let diagDiv = document.getElementById("tokenDiagnostics"); diagDiv.innerHTML = "";
        let listUni = new Set(), listDrv = new Set(), listGeo = new Set();
        
        for(let tk of configTokens) {
            let sid = activeSIDs[tk.token];
            let statusClass = "diag-ok", statusText = tk.nombre + ": OK";
            if(!sid) { 
                let l = await peticionWialon(tk.url, "token/login", {token: tk.token}); 
                if(l && l.eid) { sid = l.eid; activeSIDs[tk.token] = sid; }
                else { statusClass = "diag-error"; statusText = tk.nombre + ": Error"; }
            }
            if(sid) {
                let reqU = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 1025 }, sid);
                if(reqU && reqU.items) reqU.items.forEach(u => { unidadesWialon[u.id] = u; listUni.add(u.nm.toUpperCase()); });
                let reqR = await peticionWialon(tk.url, "core/search_items", { spec: {itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name"}, force: 1, flags: 4353 }, sid);
                if(reqR && reqR.items) reqR.items.forEach(r => {
                    if(r.drv) Object.values(r.drv).forEach(d => { listDrv.add(d.n.toUpperCase()); if(d.bu) ramDrivers[unidadesWialon[d.bu]?.nm.toUpperCase()] = d.n.toUpperCase(); });
                    if(r.zl) Object.values(r.zl).forEach(z => listGeo.add(z.n.toUpperCase()));
                });
            }
            diagDiv.innerHTML += `<span class="diag-pill ${statusClass}">${statusText}</span>`;
        }
        document.getElementById("listaUnidadesTotales").innerHTML = Array.from(listUni).map(n => `<option value="${n}">`).join('');
        document.getElementById("listaConductores").innerHTML = Array.from(listDrv).map(n => `<option value="${n}">`).join('');
        document.getElementById("listaGeocercas").innerHTML = Array.from(listGeo).map(n => `<option value="${n}">`).join('');
        renderizarBitacora();
    }

    // LISTENER DE FIREBASE (Escuchando cambios en la nube siempre)
    db.ref('clientes').on('value', s => { dataClientes = s.val() || {}; renderizarBitacora(); });
    db.ref('viajes_activos').on('value', s => { viajesActivos = s.val() || {}; renderizarBitacora(); });

    function registrarViaje() {
        let n = document.getElementById("nv_unidad_input").value.toUpperCase(); if(!n) return;
        let id = "M-" + Date.now();
        db.ref('viajes_activos/'+id).set({ unidadN: n, cliente: document.getElementById("nv_cliente").value, subcliente: document.getElementById("nv_subcliente").value, origen: document.getElementById("nv_origen").value.toUpperCase(), destino: document.getElementById("nv_destino").value.toUpperCase(), estatus: "s1", operador: document.getElementById("nv_operador").value.toUpperCase() });
        bootstrap.Modal.getInstance(document.getElementById('modalNuevoViaje')).hide();
    }
    function shareWA(id) {
        const v = viajesActivos[id]; const u = unidadesWialon[id] || { nm: v.unidadN, pos: {y:0,x:0,s:0} };
        const p = u.pos || {y:0,x:0,s:0};
        let msg = `*Reporte de Viaje*\nüöõ *Unidad:* ${v.unidadN}\nüì¶ *Cont:* ${v.contenedores || 'S/N'}\nüìç http://googleusercontent.com/maps.google.com/?q=${p.y},${p.x}\n‚è±Ô∏è ${p.s} km/h\nüèÅ ${v.origen} -> ${v.destino}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(msg)}`, '_blank');
    }
    function toggleMap() { document.getElementById("mainWorkspace").classList.toggle("show-map"); if(!lmap) initMap(); setTimeout(()=>lmap.invalidateSize(), 400); }
    function filtrarTabla() { let t = document.getElementById("buscador").value.toLowerCase(); document.querySelectorAll("#mainTable tbody tr").forEach(r => { if(r.classList.contains("header-cliente")||r.classList.contains("header-subcliente")) return; r.style.display = r.innerText.toLowerCase().includes(t)?"":"none"; }); }
    function prepararNuevoViaje() { let s = document.getElementById("nv_cliente"); s.innerHTML = Object.keys(dataClientes).map(k => `<option value="${k}">${dataClientes[k].nombre}</option>`).join(''); }
    function cargarSubclientesEnSelect(e, c) { let s = document.getElementById(e); s.innerHTML = '<option value="">N/A</option>'; if(c && dataClientes[c].subclientes) Object.keys(dataClientes[c].subclientes).forEach(k => s.innerHTML += `<option value="${k}">${dataClientes[c].subclientes[k].nombre}</option>`); }
    function cerrarSesion() { localStorage.clear(); location.reload(); }
</script>
</body>
</html>
