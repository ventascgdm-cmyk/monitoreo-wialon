<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>GRUDICOM TI & GPS | C4</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg-main: #f0f4f8; --bg-card: #ffffff; --text-main: #2c3e50; --header-bg: #002a61; --table-bg: rgba(255,255,255,0.85); --border-col: #ced4da; }
        body { background: var(--bg-main); color: var(--text-main); font-family: 'Segoe UI', sans-serif; font-size: 0.75rem; margin: 0; overflow: hidden;}
        .login-bg { background: #001a33; display: flex; align-items: center; justify-content: center; position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 9999; }
        .login-card { background: white; padding: 40px; border-radius: 12px; width: 380px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .header-bar { background: var(--bg-card); padding: 10px 20px; border-bottom: 4px solid var(--header-bg); }
        .workspace-container { display: flex; flex-direction: column; height: calc(100vh - 75px); width: 100%; }
        .table-panel { height: 100%; overflow-y: auto; padding: 15px; }
        .header-cliente { background-color: #336699 !important; color: white !important; font-size: 1rem; font-weight: bold; text-align: left; padding: 10px !important; }
        .header-subcliente { background-color: #e9ecef !important; color: #333 !important; font-size: 0.85rem; font-weight: bold; text-align: left; padding: 8px 25px !important; }
        .header-columnas th { background-color: var(--header-bg) !important; color: white !important; font-size: 0.7rem; font-weight: 700; text-align: center; }
        .table-input { border: 1px solid var(--border-col); padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; text-align: center; background: var(--table-bg); color: var(--text-main); text-transform: uppercase;}
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card text-center">
        <img src="TIGPS HD2.png" alt="Logo" style="width: 200px; margin-bottom: 25px;" onerror="this.src='https://cdn-icons-png.flaticon.com/512/3063/3063822.png'">
        <h5 class="text-primary fw-bold mb-4">SISTEMA C4 LOG√çSTICA</h5>
        <input type="text" id="logUser" class="form-control mb-3 text-center" placeholder="Usuario" value="admin">
        <input type="password" id="logPass" class="form-control mb-4 text-center" placeholder="Contrase√±a" value="admin123">
        <button id="btnEnter" class="btn btn-primary w-100 fw-bold py-2 shadow-sm">INGRESAR</button>
        <div id="status" class="mt-3 small fw-bold text-secondary">Acceso Directo Activado</div>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header-bar d-flex justify-content-between align-items-center">
        <div class="d-flex align-items-center">
            <img src="TIGPS HD2.png" alt="Logo" style="height: 40px;" class="me-3">
            <div><h5 class="fw-bold m-0">GRUDICOM TI & GPS</h5><small id="lblMonitor" class="text-muted">Conectado a Firebase</small></div>
        </div>
        <button class="btn btn-secondary btn-sm fw-bold" onclick="location.reload()"><i class="fa-solid fa-power-off"></i> Salir</button>
    </div>
    <div class="workspace-container">
        <div class="table-panel">
            <div class="card shadow border-0">
                <div class="table-responsive">
                    <table class="table table-bordered align-middle text-center mb-0">
                        <tbody id="units-body"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script type="text/javascript">
    // CONFIGURACI√ìN
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    const app = firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ACCESO FORZADO (BYPASS)
    const btnEnter = document.getElementById("btnEnter");
    const loginOverlay = document.getElementById("loginOverlay");
    const dashboard = document.getElementById("dashboard");

    function forzarEntrada() {
        const u = document.getElementById("logUser").value.trim();
        const p = document.getElementById("logPass").value.trim();

        // Si es el admin de tu base de datos, entra sin preguntar a nadie m√°s
        if (u === "admin" && p === "admin123") {
            loginOverlay.style.display = "none";
            dashboard.style.display = "block";
            iniciarSistema();
        } else {
            document.getElementById("status").innerText = "Credenciales incorrectas";
        }
    }

    btnEnter.onclick = forzarEntrada;
    document.getElementById("logPass").onkeyup = e => { if(e.key === "Enter") forzarEntrada(); };

    // CARGA DE DATOS (FIREBASE PRIMERO)
    function iniciarSistema() {
        // Escuchar Viajes Activos
        db.ref('viajes_activos').on('value', s => {
            const viajes = s.val() || {};
            const tbody = document.getElementById('units-body');
            let html = `<tr class="header-columnas"><th>UNIDAD</th><th>OPERADOR</th><th>RUTA</th><th>üì¶ CONTENEDORES</th><th>ESTATUS</th><th>GPS</th></tr>`;
            
            Object.keys(viajes).forEach(id => {
                const v = viajes[id];
                html += `<tr>
                    <td class="unit-name">${v.unidadN || id}</td>
                    <td><input class="table-input" value="${v.operador||''}" onblur="firebase.database().ref('viajes_activos/${id}/operador').set(this.value.toUpperCase())"></td>
                    <td>${v.origen || ''} ‚ûî ${v.destino || ''}</td>
                    <td><textarea class="table-input" onblur="firebase.database().ref('viajes_activos/${id}/contenedores').set(this.value.toUpperCase())">${v.contenedores || ''}</textarea></td>
                    <td><span class="badge bg-success">En Ruta</span></td>
                    <td><small class="text-muted">Manual Mode</small></td>
                </tr>`;
            });

            if(Object.keys(viajes).length === 0) {
                html += `<tr><td colspan="6" class="p-5 text-muted">No hay viajes activos en Firebase.</td></tr>`;
            }
            tbody.innerHTML = html;
        });
    }
</script>
</body>
</html>
