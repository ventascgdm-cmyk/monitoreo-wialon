<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>SISTEMA C4 | RECONSTRUCCI√ìN V1.1</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        :root { --bg: #001a33; --card: #ffffff; --primary: #002a61; }
        body { background: #f0f4f8; font-family: 'Segoe UI', sans-serif; font-size: 0.8rem; }
        .login-bg { background: var(--bg); position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 999; display: flex; align-items: center; justify-content: center; }
        .login-card { background: var(--card); padding: 40px; border-radius: 12px; width: 350px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .header-bar { background: var(--card); padding: 10px 20px; border-bottom: 4px solid var(--primary); display: flex; justify-content: space-between; align-items: center; }
        .cliente-row { background: #336699; color: white; font-weight: bold; padding: 10px; }
    </style>
</head>
<body>

<div id="loginOverlay" class="login-bg">
    <div class="login-card">
        <h4 class="text-primary fw-bold mb-4">C4 LOG√çSTICA</h4>
        <input type="text" id="u" class="form-control mb-2 text-center" placeholder="admin">
        <input type="password" id="p" class="form-control mb-3 text-center" placeholder="admin123">
        <button onclick="login()" class="btn btn-primary w-100 fw-bold">ENTRAR</button>
        <div id="msg" class="mt-3 small text-muted">Escribe admin / admin123</div>
    </div>
</div>

<div id="app" style="display:none;">
    <div class="header-bar shadow-sm">
        <h5 class="m-0 fw-bold text-primary">GRUDICOM TI & GPS</h5>
        <button class="btn btn-danger btn-sm fw-bold" data-bs-toggle="modal" data-bs-target="#mAdmin">ADMIN</button>
    </div>
    
    <div class="container-fluid mt-3">
        <div class="card shadow-sm border-0">
            <table class="table table-bordered mb-0">
                <thead class="table-dark small">
                    <tr><th>UNIDAD</th><th>OPERADOR</th><th>ESTATUS</th></tr>
                </thead>
                <tbody id="tabla"></tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="mAdmin" tabindex="-1"><div class="modal-dialog"><div class="modal-content">
    <div class="modal-header bg-danger text-white"><h6 class="modal-title">PANEL DE CONTROL</h6></div>
    <div class="modal-body">
        <h6>1. Crear Cliente</h6>
        <div class="input-group mb-3">
            <input type="text" id="nc" class="form-control" placeholder="Nombre (Ej. DSG)">
            <button class="btn btn-success" onclick="addCli()">A√±adir</button>
        </div>
        <hr>
        <h6>2. Configurar Token GPS</h6>
        <input type="text" id="tn" class="form-control mb-1" placeholder="Nombre Flota">
        <input type="text" id="tv" class="form-control mb-2" placeholder="Token Wialon">
        <button class="btn btn-primary w-100" onclick="addTk()">Guardar Token</button>
    </div>
</div></div></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // 1. CONEXI√ìN DIRECTA
    const conf = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    firebase.initializeApp(conf);
    const db = firebase.database();

    // 2. LOGIN AUTO-INSTALABLE
    function login() {
        const user = document.getElementById("u").value.trim();
        const pass = document.getElementById("p").value.trim();

        if(user === "admin" && pass === "admin123") {
            // Aseguramos que existas en Firebase tras el borrado
            db.ref('sistema/usuarios/admin').set({nom: "Admin Maestro", pass: "admin123", rol: "admin"});
            
            document.getElementById("loginOverlay").style.display = "none";
            document.getElementById("app").style.display = "block";
            init();
        } else {
            document.getElementById("msg").innerText = "Error de acceso";
        }
    }

    // 3. CARGA DE TABLA LIGERA
    function init() {
        db.ref('clientes').on('value', s => {
            const clis = s.val() || {};
            const t = document.getElementById("tabla");
            t.innerHTML = "";
            
            Object.keys(clis).forEach(id => {
                t.innerHTML += `<tr><td colspan="3" class="cliente-row">üì¶ CLIENTE: ${clis[id].nombre}</td></tr>`;
            });
            
            if(Object.keys(clis).length === 0) {
                t.innerHTML = "<tr><td colspan='3' class='text-center p-4 text-muted'>Base vac√≠a. Usa ADMIN para empezar.</td></tr>";
            }
        });
    }

    // 4. FUNCIONES ADMIN
    function addCli() {
        const n = document.getElementById("nc").value.toUpperCase();
        if(n) db.ref('clientes').push({nombre: n});
        document.getElementById("nc").value = "";
    }

    function addTk() {
        const n = document.getElementById("tn").value.toUpperCase();
        const v = document.getElementById("tv").value;
        if(n && v) db.ref('sistema/tokens').push({nombre: n, token: v, url: "https://hst-api.wialon.com"});
        alert("Token guardado");
    }
</script>
</body>
</html>
