// Variable global para almacenar los datos extendidos
var conductoresMap = {}; 
var geocercasGlobales = [];

function init() {
    var sess = wialon.core.Session.getInstance();
    
    // Cargamos librerías para manejar conductores y geocercas
    sess.loadLibrary("resourceDrivers");
    sess.loadLibrary("resourceZones"); // Nueva librería para geocercas
    sess.loadLibrary("itemIcon");

    // Flags: 1(Base), 256(Conductores), 4096(Geocercas)
    var res_flags = wialon.util.Number.or(
        wialon.item.Item.dataFlag.base, 
        wialon.item.Resource.dataFlag.drivers,
        wialon.item.Resource.dataFlag.zones
    );
    var unit_flags = wialon.util.Number.or(wialon.item.Item.dataFlag.base, 1024); // 1024 para posición

    sess.updateDataFlags(
        [{type: "type", data: "avl_unit", flags: unit_flags, mode: 0},
         {type: "type", data: "avl_resource", flags: res_flags, mode: 0}],
        function (code) {
            if (code) return;

            var ress = sess.getItems("avl_resource");
            var units = sess.getItems("avl_unit");

            // 1. Procesar Conductores y Geocercas de todos los Recursos
            ress.forEach(res => {
                // Conductores
                var drivers = res.getDrivers() || {};
                for (var dId in drivers) {
                    var d = drivers[dId];
                    // Extraer teléfono de pprops (propiedades personalizadas)
                    var pprops = d.p || {}; 
                    conductoresMap[d.id] = {
                        name: d.n,
                        phone: pprops.ph || "S/N", // Igual que en tu Sheets
                        resId: res.getId(),
                        bu: d.bu // Unidad vinculada
                    };
                }
                // Geocercas
                var zones = res.getZones() || {};
                for (var zId in zones) {
                    geocercasGlobales.push(zones[zId]);
                }
            });

            // 2. Renderizar Tabla
            renderTable(units);
        }
    );
}

function renderTable(units) {
    var html = "";
    units.forEach(u => {
        var u_id = u.getId();
        var pos = u.getPosition();
        
        // Buscar conductor vinculado por la propiedad 'bu'
        var conductorAct = "<i>Sin asignar</i>";
        var telAct = "---";
        
        for (var cid in conductoresMap) {
            if (conductoresMap[cid].bu == u_id) {
                conductorAct = conductoresMap[cid].name;
                telAct = conductoresMap[cid].phone;
                break;
            }
        }

        // Detectar si está en una geocerca (Lógica geométrica del SDK)
        var zonaActual = "En ruta";
        if (pos) {
            geocercasGlobales.forEach(z => {
                if (z.pointIn(pos.x, pos.y)) { // Verifica si lat/lon están dentro
                    zonaActual = `<b style="color: #10b981;">${z.n}</b>`;
                }
            });
        }

        html += `
            <tr>
                <td><b>${u.getName()}</b></td>
                <td>${conductorAct}</td>
                <td><a href="tel:${telAct}">${telAct}</a></td>
                <td>${zonaActual}</td>
                <td>${pos ? pos.s + " km/h" : "Offline"}</td>
            </tr>`;
    });
    $("#units-body").html(html);
}
