<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Monitor de Unidades Wialon</title>
    <style>
        body { font-family: sans-serif; padding: 20px; background-color: #f4f4f9; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 12px; border: 1px solid #ddd; text-align: left; }
        th { background-color: #004a99; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
    </style>
</head>
<body>

    <h2>Unidades y Conductores en Tiempo Real</h2>
    <div id="status">Cargando datos...</div>
    <br>
    <table id="unitTable">
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Conductor</th>
                <th>ID Unidad</th>
            </tr>
        </thead>
        <tbody id="tableBody">
            </tbody>
    </table>

    <script>
        const TOKEN = "9929a644617dd97b53d18cd6491fad66CEFFEDAAAEA1386033D128438DC0D19FFEA54F87";
        const HOST = "https://hst-api.wialon.com/wialon/ajax.html";

        async function getWialonData() {
            try {
                // 1. Login para obtener SID
                const loginRes = await fetch(`${HOST}?svc=token/login&params=${JSON.stringify({token: TOKEN})}`);
                const loginData = await loginRes.json();
                const sid = loginData.eid;

                // 2. Buscar Unidades
                const searchParams = {
                    spec: { itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
                    force: 1,
                    flags: 1 + 256, // Nombre y Conductores
                    from: 0, to: 0
                };

                const searchRes = await fetch(`${HOST}?svc=core/search_items&params=${JSON.stringify(searchParams)}&sid=${sid}`);
                const searchData = await searchRes.json();
                
                renderTable(searchData.items);
                document.getElementById('status').innerText = "Datos actualizados correctamente.";

            } catch (error) {
                console.error("Error:", error);
                document.getElementById('status').innerText = "Error al conectar con Wialon.";
            }
        }

        function renderTable(units) {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = ""; // Limpiar tabla

            units.forEach(unit => {
                const row = document.createElement('tr');
                const driverName = unit.prms?.driver?.v || "Sin conductor";
                
                row.innerHTML = `
                    <td>${unit.nm}</td>
                    <td>${driverName}</td>
                    <td>${unit.id}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Ejecutar al cargar la p√°gina
        getWialonData();
    </script>
</body>
</html>
