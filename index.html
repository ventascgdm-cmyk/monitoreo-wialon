<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>C4 - SINCRONIZACIÓN TOTAL</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>

    <style>
        body { background: #f8f9fa; font-family: sans-serif; font-size: 0.75rem; }
        .header { background: #002a61; color: white; padding: 10px; display: flex; justify-content: space-between; }
        .badge-info { background: #17a2b8; font-size: 0.7rem; margin-right: 5px; }
    </style>
</head>
<body>

<div class="header shadow">
    <h6 class="m-0">GRUDICOM TI & GPS | C4 Operativo</h6>
    <div id="diagnostico"></div>
    <button class="btn btn-danger btn-sm" data-bs-toggle="modal" data-bs-target="#mAdmin">ADMIN</button>
</div>

<div class="container-fluid mt-3" id="tabla-logistica">
    </div>

<script>
    // Inicialización Limpia (Corrige error de consola image_8994a9)
    const firebaseConfig = { databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" };
    if (!firebase.apps.length) { firebase.initializeApp(firebaseConfig); }
    const db = firebase.database();

    let unidadesGPS = {};

    function iniciar() {
        // 1. Escuchar Clientes y Viajes
        db.ref('clientes').on('value', () => render());
        db.ref('viajes_activos').on('value', () => render());

        // 2. Motor de Recuperación Forzada
        db.ref('sistema/tokens').once('value', s => {
            const tokens = s.val() ? Object.values(s.val()) : [];
            tokens.forEach(tk => {
                // Forzamos conexión limpia ignorando errores previos
                const url = `${tk.url}/wialon/ajax.html?svc=token/login&params={"token":"${tk.token}"}`;
                fetch(url).then(r => r.json()).then(d => {
                    if(d.eid) {
                        document.getElementById("diagnostico").innerHTML += `<span class="badge badge-info">${tk.nombre} OK</span>`;
                        // Pedimos TODAS las unidades sin filtros
                        fetch(`${tk.url}/wialon/ajax.html?svc=core/search_items&sid=${d.eid}&params={"spec":{"itemsType":"avl_unit","propName":"sys_name","propValueMask":"*","sortType":"sys_name"},"force":1,"flags":1025}`)
                        .then(r => r.json()).then(res => {
                            if(res.items) res.items.forEach(u => { unidadesGPS[u.nm.toUpperCase()] = u; });
                            render();
                        });
                    }
                });
            });
        });
    }

    function render() {
        const cont = document.getElementById("tabla-logistica");
        db.ref('viajes_activos').once('value', s => {
            const viajes = s.val() || {};
            let html = '<table class="table table-bordered bg-white"><thead><tr><th>UNIDAD</th><th>ESTATUS</th><th>VELOCIDAD</th></tr></thead><tbody>';
            Object.keys(viajes).forEach(id => {
                const v = viajes[id];
                const gps = unidadesGPS[v.unidadN.toUpperCase()] || null;
                html += `<tr>
                    <td><b>${v.unidadN}</b></td>
                    <td><span class="badge bg-success">En Ruta</span></td>
                    <td>${gps ? `<b class="text-primary">${gps.pos.s} km/h</b>` : '<span class="text-muted">Buscando señal...</span>'}</td>
                </tr>`;
            });
            html += '</tbody></table>';
            cont.innerHTML = html;
        });
    }

    iniciar();
</script>
</body>
</html>
