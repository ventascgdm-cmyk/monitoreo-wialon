<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Wialon - Unidades y Conductores</title>
    <script type="text/javascript" src="https://hst-api.wialon.com/wsdk/script/wialon.js"></script>
    <style>
        body { font-family: 'Segoe UI', sans-serif; margin: 20px; background-color: #f4f7f6; }
        table { width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #00529b; color: white; }
        tr:nth-child(even) { background-color: #f9f9f9; }
        .status { padding: 10px; margin-bottom: 10px; font-weight: bold; border-radius: 4px; }
        .ok { background: #d4edda; color: #155724; }
    </style>
</head>
<body>

    <h2>Monitoreo de Unidades y Conductores</h2>
    <div id="log" class="status">Conectando...</div>

    <table>
        <thead>
            <tr>
                <th>Unidad</th>
                <th>Conductor Actual</th>
                <th>Teléfono</th>
                <th>Último Mensaje</th>
            </tr>
        </thead>
        <tbody id="units-body"></tbody>
    </table>

    <script type="text/javascript">
        const TOKEN = "9929a644617dd97b53d18cd6491fad66CEFFEDAAAEA1386033D128438DC0D19FFEA54F87";
        let conductoresMap = {}; // Aquí guardaremos ID_Conductor -> Nombre

        function init() {
            const sess = wialon.core.Session.getInstance();
            sess.initSession("https://hst-api.wialon.com");
            sess.loginToken(TOKEN, "", (code) => {
                if (code) {
                    document.getElementById("log").innerText = "Error de Login: " + code;
                    return;
                }
                document.getElementById("log").innerText = "Conectado con éxito";
                document.getElementById("log").classList.add("ok");
                
                // 1. Primero cargamos los conductores (como en tu Sheets)
                cargarConductores();
            });
        }

        function cargarConductores() {
            const sess = wialon.core.Session.getInstance();
            // Flag 1: Propiedades básicas (nombre), Flag 256: Propiedades personalizadas (teléfono)
            sess.updateDataFlags([{type: "type", data: "avl_driver", flags: 1 | 256, mode: 0}], (code) => {
                const drivers = sess.getItems("avl_driver");
                drivers.forEach(d => {
                    const phone = d.getCustomProperty("ph", d.getCustomProperty("phone", "---"));
                    conductoresMap[d.getId()] = {
                        nombre: d.getName(),
                        telefono: phone
                    };
                });
                
                // 2. Una vez que tenemos el mapa de conductores, cargamos las unidades
                cargarUnidades();
            });
        }

        function cargarUnidades() {
            const sess = wialon.core.Session.getInstance();
            // Flag 1: Nombre, Flag 1024: Posición/Mensajes
            sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], (code) => {
                const units = sess.getItems("avl_unit");
                const tbody = document.getElementById("units-body");
                tbody.innerHTML = "";

                units.forEach(unit => {
                    const row = tbody.insertRow();
                    
                    // Obtener ID del conductor asignado a esta unidad
                    // En el SDK se obtiene usualmente mediante getDriverId()
                    const driverId = unit.getDriverId ? unit.getDriverId() : 0;
                    const infoDriver = conductoresMap[driverId] || { nombre: "Sin conductor", telefono: "---" };

                    const lastMsg = unit.getLastMessage();
                    const fecha = lastMsg ? new Date(lastMsg.t * 1000).toLocaleString() : "---";

                    row.innerHTML = `
                        <td><strong>${unit.getName()}</strong></td>
                        <td>${infoDriver.nombre}</td>
                        <td>${infoDriver.telefono}</td>
                        <td>${fecha}</td>
                    `;
                });
            });
        }

        window.onload = init;
    </script>
</body>
</html>
