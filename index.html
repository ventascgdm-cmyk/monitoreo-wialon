<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bitácora de Monitoreo Pro</title>
    
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script type="text/javascript" src="https://hst-api.wialon.com/wscommon/js/wialon.js"></script>

    <style>
        :root { --wialon-blue: #0045a5; }
        body { background-color: #f1f3f5; font-family: 'Segoe UI', sans-serif; }
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: linear-gradient(135deg, #0045a5 0%, #002d6b 100%);
            display: flex; align-items: center; justify-content: center;
            z-index: 9999;
        }
        .login-card { background: white; padding: 2.5rem; border-radius: 20px; width: 100%; max-width: 400px; box-shadow: 0 15px 35px rgba(0,0,0,0.3); }
        #dashboard { display: none; }
        .header-app { background: var(--wialon-blue); color: white; padding: 1.5rem; border-radius: 0 0 15px 15px; margin-bottom: 20px; }
        .card { border: none; box-shadow: 0 4px 10px rgba(0,0,0,0.05); border-radius: 12px; }
    </style>
</head>
<body>

    <div id="loginOverlay">
        <div class="login-card text-center shadow-lg">
            <h3 class="mb-3 fw-bold">Bienvenido</h3>
            <p class="text-muted small mb-4">Ingresa tu Token de Wialon para conectar la flota</p>
            <input type="password" id="tokenInput" class="form-control mb-3" placeholder="Wialon API Token">
            <div class="form-check text-start mb-4">
                <input class="form-check-input" type="checkbox" id="rememberMe">
                <label class="form-check-label small" for="rememberMe">Recordar mi sesión en este navegador</label>
            </div>
            <button onclick="attemptLogin()" id="btnLogin" class="btn btn-primary w-100 py-2 fw-bold">Entrar al Sistema</button>
            <div id="statusMsg" class="mt-3 small text-primary fw-bold">Sincronizando con Wialon...</div>
        </div>
    </div>

    <div id="dashboard" class="container-fluid">
        <div class="header-app shadow">
            <div class="row align-items-center">
                <div class="col-md-6">
                    <h2 class="h4 mb-0">Monitor de Flota Real-Time</h2>
                    <span class="badge bg-light text-primary mt-1">Conexión Segura HTTPS</span>
                </div>
                <div class="col-md-6 text-md-end mt-2 mt-md-0">
                    <button onclick="exportToExcel()" class="btn btn-success btn-sm fw-bold">Generar Reporte Excel</button>
                    <button onclick="logout()" class="btn btn-outline-light btn-sm ms-2">Salir</button>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-3">
                <div class="card p-4 text-center mb-4">
                    <h6 class="fw-bold mb-3">Distribución de Unidades</h6>
                    <canvas id="fleetChart"></canvas>
                </div>
            </div>
            <div class="col-lg-9">
                <div class="card p-3 table-responsive">
                    <table class="table table-hover align-middle">
                        <thead class="table-light text-secondary">
                            <tr>
                                <th>Cliente</th><th>Subcliente</th><th>Unidad</th><th>Estado</th><th>Velocidad</th>
                            </tr>
                        </thead>
                        <tbody id="unitList"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <script>
        var sess = null;
        var myChart = null;

        // Función de inicialización ultra-segura
        function checkSDK() {
            if (typeof wialon !== 'undefined' && wialon.core && wialon.core.Session) {
                sess = wialon.core.Session.getInstance();
                document.getElementById('statusMsg').innerText = "Sistema Listo";
                document.getElementById('statusMsg').className = "mt-3 small text-success";
                console.log("Wialon SDK cargado exitosamente.");
            } else {
                setTimeout(checkSDK, 500); // Reintenta cada medio segundo
            }
        }

        window.onload = () => {
            checkSDK();
            const savedToken = localStorage.getItem('wialon_token');
            if(savedToken) {
                document.getElementById('tokenInput').value = savedToken;
                document.getElementById('rememberMe').checked = true;
            }
        };

        function attemptLogin() {
            if (!sess) {
                alert("El SDK aún no responde. Por favor, asegúrate de tener buena conexión y espera un momento.");
                return;
            }

            const token = document.getElementById('tokenInput').value;
            const btn = document.getElementById('btnLogin');
            if (!token) { alert("Ingresa un token válido"); return; }

            btn.disabled = true;
            btn.innerText = "Validando...";

            sess.initSession("https://hst-api.wialon.com");
            sess.loginToken(token, "", (code) => {
                if (code) {
                    btn.disabled = false;
                    btn.innerText = "Entrar al Sistema";
                    alert("Error de Wialon: " + wialon.core.Errors.getErrorText(code));
                    return;
                }

                if(document.getElementById('rememberMe').checked) {
                    localStorage.setItem('wialon_token', token);
                }

                document.getElementById('loginOverlay').style.display = "none";
                document.getElementById('dashboard').style.display = "block";
                
                startMonitoring();
            });
        }

        function startMonitoring() {
            sess.loadLibrary("itemUnit");
            // Flags: 1 (Nombre) + 1024 (Posición)
            sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], () => {
                updateUI();
                sess.addListener("dataUpdated", updateUI);
            });
        }

        function updateUI() {
            const units = sess.getItems("avl_unit") || [];
            const tbody = document.getElementById('unitList');
            tbody.innerHTML = "";
            let on = 0, off = 0;

            units.forEach(unit => {
                const id = unit.getId();
                const pos = unit.getPosition();
                const isMoving = pos && pos.s > 0;
                if(isMoving) on++; else off++;

                const c = localStorage.getItem(`c_${id}`) || "";
                const s = localStorage.getItem(`s_${id}`) || "";

                tbody.innerHTML += `
                    <tr>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light shadow-sm" value="${c}" onchange="localStorage.setItem('c_${id}', this.value)" placeholder="---"></td>
                        <td><input type="text" class="form-control form-control-sm border-0 bg-light shadow-sm" value="${s}" onchange="localStorage.setItem('s_${id}', this.value)" placeholder="---"></td>
                        <td class="fw-bold">${unit.getName()}</td>
                        <td><span class="badge ${isMoving ? 'bg-success' : 'bg-danger'} shadow-sm">${isMoving ? 'EN MOVIMIENTO' : 'DETENIDO'}</span></td>
                        <td class="text-primary fw-bold">${pos ? pos.s : 0} km/h</td>
                    </tr>
                `;
            });
            drawChart(on, off);
        }

        function drawChart(on, off) {
            const ctx = document.getElementById('fleetChart').getContext('2d');
            if (myChart) myChart.destroy();
            myChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Activo', 'Inactivo'],
                    datasets: [{ data: [on, off], backgroundColor: ['#28a745', '#dc3545'], borderWidth: 0 }]
                },
                options: { cutout: '70%', plugins: { legend: { position: 'bottom' } } }
            });
        }

        function exportToExcel() {
            const units = sess.getItems("avl_unit") || [];
            let csv = "\uFEFFCLIENTE,SUBCLIENTE,UNIDAD,ESTADO,VELOCIDAD\n";
            units.forEach(u => {
                const pos = u.getPosition();
                const id = u.getId();
                csv += `${localStorage.getItem('c_'+id)||'N/A'},${localStorage.getItem('s_'+id)||'N/A'},${u.getName()},${(pos && pos.s > 0)?'MOV':'STOP'},${pos?pos.s:0}\n`;
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = "Reporte_Flota.csv";
            link.click();
        }

        function logout() {
            localStorage.removeItem('wialon_token');
            location.reload();
        }
    </script>
</body>
</html>
