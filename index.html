<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="utf-8" />
    <title>C4 - Bitácora Multitoken Pro</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { background-color: #f1f5f9; font-family: 'Inter', sans-serif; font-size: 0.85rem; }
        .card-bitacora { border: none; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0,0,0,0.1); }
        .header-table { background-color: #0f172a; color: white; text-transform: uppercase; font-size: 0.7rem; letter-spacing: 0.05em; }
        .unit-name { font-weight: 800; color: #0284c7; }
        .badge-geo { background-color: #d1fae5; color: #065f46; border: 1px solid #10b981; font-weight: 700; }
        .platform-tag { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; color: #475569; }
    </style>
</head>
<body>

<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="fw-black text-dark m-0">OPERATIVO C4 <small class="text-muted fs-6">| Multitoken Live</small></h2>
        <button onclick="arranqueMaestro()" class="btn btn-primary rounded-pill px-4 fw-bold">
            <i class="fa-solid fa-sync-alt me-2"></i> Actualizar Flotas
        </button>
    </div>

    <div class="card card-bitacora">
        <div class="table-responsive">
            <table class="table table-hover align-middle m-0" id="mainTable">
                <thead class="header-table">
                    <tr>
                        <th>Plataforma</th>
                        <th>Unidad</th>
                        <th>Conductor</th>
                        <th>Teléfono</th>
                        <th>Geocerca / Ubicación</th>
                        <th>Estatus</th>
                    </tr>
                </thead>
                <tbody id="units-body">
                    <tr><td colspan="6" class="text-center p-5">Presione "Actualizar Flotas" para iniciar...</td></tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
// --- CONFIGURACIÓN DE PLATAFORMAS ---
const plataformas = [
    { 
        nombre: "PLATAFORMA 1", 
        url: "https://hst-api.wialon.com", 
        token: "9929a644617dd97b53d18cd6491fad66CEFFEDAAAEA1386033D128438DC0D19FFEA54F87" 
    },
    { 
        nombre: "PLATAFORMA 2", 
        url: "https://hst-api.wialon.com", 
        token: "TU_SEGUNDO_TOKEN_AQUI" 
    }
];

let dataGlobal = {
    unidades: [],
    conductores: {} // Mapa global ID_CONDUCTOR -> DATOS
};

// 1. FUNCIÓN DE ARRANQUE (ASÍNCRONA)
async function arranqueMaestro() {
    document.getElementById("units-body").innerHTML = `<tr><td colspan="6" class="text-center p-5"><i class="fas fa-circle-notch fa-spin fa-2x"></i><br>Sincronizando todas las plataformas...</td></tr>`;
    
    dataGlobal.unidades = [];
    dataGlobal.conductores = {};

    // Procesamos todas las plataformas en paralelo para máxima velocidad
    const promesas = plataformas.map(p => procesarPlataforma(p));
    await Promise.all(promesas);
    
    renderizarTabla();
}

// 2. PROCESAMIENTO POR PLATAFORMA
async function procesarPlataforma(p) {
    try {
        // Login para obtener SID
        const login = await peticionAjax(p.url, "token/login", { token: p.token });
        const sid = login.eid;
        if (!sid) return;

        // Cargar Conductores (avl_driver) con pprops para teléfono
        const drvReq = await peticionAjax(p.url, "core/search_items", {
            spec: { itemsType: "avl_driver", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
            force: 1, flags: 1 + 256, from: 0, to: 0
        }, sid);

        if (drvReq.items) {
            drvReq.items.forEach(d => {
                const props = d.pprops || {};
                dataGlobal.conductores[d.id] = {
                    nombre: d.nm,
                    telefono: props.ph || props.phone || "S/N", // Extraído como en tu Sheets
                    uIdVinculada: d.bu // Bind Unit
                };
            });
        }

        // Cargar Unidades y Geocercas (en el mismo host)
        const unitReq = await peticionAjax(p.url, "core/search_items", {
            spec: { itemsType: "avl_unit", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
            force: 1, flags: 1 + 1024, from: 0, to: 0
        }, sid);

        const resReq = await peticionAjax(p.url, "core/search_items", {
            spec: { itemsType: "avl_resource", propName: "sys_name", propValueMask: "*", sortType: "sys_name" },
            force: 1, flags: 4096, from: 0, to: 0
        }, sid);

        let geocercasLocal = [];
        if (resReq.items) {
            resReq.items.forEach(r => { if(r.zl) Object.values(r.zl).forEach(z => geocercasLocal.push(z)); });
        }

        if (unitReq.items) {
            unitReq.items.forEach(u => {
                // Lógica de detección de Geocerca
                let zonaActual = "En ruta";
                if (u.pos) {
                    geocercasLocal.forEach(z => {
                        if (isPointInPolygon(u.pos.x, u.pos.y, z.p)) zonaActual = z.n;
                    });
                }

                dataGlobal.unidades.push({
                    nombre: u.nm,
                    plataforma: p.nombre,
                    pos: u.pos,
                    uId: u.id,
                    zona: zonaActual,
                    conductor: buscarConductor(u.id)
                });
            });
        }
    } catch (e) {
        console.error("Error en plataforma " + p.nombre, e);
    }
}

// 3. BUSCADOR DE CONDUCTOR (Cruce de datos)
function buscarConductor(uId) {
    for (let id in dataGlobal.conductores) {
        if (dataGlobal.conductores[id].uIdVinculada == uId) return dataGlobal.conductores[id];
    }
    return { nombre: "Sin asignar", telefono: "---" };
}

// 4. RENDERIZADO DE TABLA
function renderizarTabla() {
    const tbody = document.getElementById("units-body");
    let html = "";

    dataGlobal.unidades.sort((a, b) => a.nombre.localeCompare(b.nombre));

    dataGlobal.unidades.forEach(u => {
        const speed = u.pos ? u.pos.s : 0;
        const speedClass = speed > 0 ? 'text-success' : 'text-muted';
        const zonaBadge = u.zona !== "En ruta" ? `<span class="badge badge-geo"><i class="fa-solid fa-draw-polygon me-1"></i>${u.zona}</span>` : `<span class="text-muted small">En ruta</span>`;

        html += `
            <tr>
                <td><span class="platform-tag">${u.plataforma}</span></td>
                <td><span class="unit-name">${u.nombre}</span></td>
                <td><i class="fa-solid fa-user-tie me-2 text-secondary"></i>${u.conductor.nombre}</td>
                <td><a href="tel:${u.conductor.telefono}" class="text-decoration-none"><i class="fa-solid fa-phone me-2 text-primary"></i>${u.conductor.telefono}</a></td>
                <td>${zonaBadge}</td>
                <td><b class="${speedClass}">${speed} km/h</b></td>
            </tr>`;
    });

    tbody.innerHTML = html || '<tr><td colspan="6" class="text-center">No se encontraron unidades.</td></tr>';
}

// 5. UTILIDADES TÉCNICAS (JSONP & GEOMETRÍA)
function peticionAjax(url, svc, params, sid = null) {
    return new Promise(resolve => {
        const cb = "cb_" + Math.random().toString(36).substring(7);
        window[cb] = d => { delete window[cb]; resolve(d); };
        const script = document.createElement("script");
        script.src = `${url}/wialon/ajax.html?svc=${svc}&params=${JSON.stringify(params)}&callback=${cb}${sid ? '&sid=' + sid : ''}`;
        document.head.appendChild(script);
    });
}

function isPointInPolygon(x, y, poly) {
    if (!poly) return false;
    let inside = false;
    for (let i = 0, j = poly.length - 1; i < poly.length; j = i++) {
        let xi = poly[i].x, yi = poly[i].y, xj = poly[j].x, yj = poly[j].y;
        if (((yi > y) != (yj > y)) && (x < (xj - xi) * (y - yi) / (yj - yi) + xi)) inside = !inside;
    }
    return inside;
}
</script>
</body>
</html>
