<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Bit谩cora Log铆stica Inteligente - Wialon Cloud</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.15.0/firebase-database-compat.js"></script>
    <script type="text/javascript" src="https://hst-api.wialon.com/wscommon/js/wialon.js"></script>

    <style>
        :root { --blue: #0045a5; --green: #28a745; }
        body { background: #f4f7f6; font-size: 0.75rem; color: #333; }
        .header { background: var(--blue); color: white; padding: 15px; border-bottom: 4px solid var(--green); }
        .table-input { border: 1px solid #ced4da; padding: 4px; width: 100%; border-radius: 4px; font-size: 0.75rem; transition: 0.2s; }
        .table-input:focus { border-color: var(--blue); outline: none; background: #fff; box-shadow: 0 0 4px rgba(0,69,165,0.2); }
        .address-text { font-size: 0.7rem; color: #666; font-style: italic; max-width: 180px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        #loginOverlay { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--blue); display:flex; align-items:center; justify-content:center; z-index:999; }
        .badge-mov { background-color: var(--green); box-shadow: 0 0 5px var(--green); }
        .badge-stop { background-color: #dc3545; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="card p-4 text-center shadow-lg" style="width: 360px; border-radius: 20px;">
        <h4 class="fw-bold mb-3 text-primary">Log铆stica Cloud</h4>
        <p class="small text-muted mb-4">Ingresa tu token para sincronizar la flota</p>
        <input type="password" id="tokenInput" class="form-control mb-3 text-center" placeholder="Wialon API Token">
        <button onclick="login()" class="btn btn-primary w-100 fw-bold py-2">Sincronizar Sistema</button>
    </div>
</div>

<div id="dashboard" style="display:none;">
    <div class="header shadow-sm mb-3">
        <div class="container-fluid d-flex justify-content-between align-items-center">
            <h5 class="m-0 fw-bold text-uppercase tracking-wider">Panel de Control Log铆stico Real-Time</h5>
            <button onclick="exportarExcel()" class="btn btn-sm btn-light fw-bold shadow-sm"> Descargar Reporte Maestro</button>
        </div>
    </div>

    <div class="container-fluid">
        <div class="card shadow-sm border-0" style="border-radius: 12px;">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0 text-center">
                    <thead class="table-dark">
                        <tr>
                            <th width="10%">Unidad</th>
                            <th width="10%">Cliente</th>
                            <th width="10%">Subcliente</th>
                            <th width="10%">Origen</th>
                            <th width="10%">Destino</th>
                            <th width="10%">Estatus</th>
                            <th width="10%">Contenedores</th>
                            <th width="8%">Velocidad</th>
                            <th width="15%">Ubicaci贸n</th>
                            <th width="7%">Estado</th>
                        </tr>
                    </thead>
                    <tbody id="unitList"></tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<script>
    // CONFIGURACIN DE TU FIREBASE (Pegar URL de la imagen d0e777.png)
    const firebaseConfig = {
        databaseURL: "https://monitoreo-logistica-default-rtdb.firebaseio.com/" 
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    let sess = null;

    window.onload = () => { 
        if (typeof wialon !== 'undefined') sess = wialon.core.Session.getInstance(); 
    };

    function login() {
        const token = document.getElementById('tokenInput').value;
        if(!token) return alert("Por favor ingresa tu token");
        
        sess.initSession("https://hst-api.wialon.com");
        sess.loginToken(token, "", (code) => {
            if (code) return alert("Error de Conexi贸n: " + wialon.core.Errors.getErrorText(code));
            document.getElementById('loginOverlay').style.display = 'none';
            document.getElementById('dashboard').style.display = 'block';
            iniciarMonitoreo();
        });
    }

    function iniciarMonitoreo() {
        sess.loadLibrary("itemUnit");
        // Flags: 1 (Nombre) + 1024 (Posici贸n/Velocidad)
        sess.updateDataFlags([{type: "type", data: "avl_unit", flags: 1 | 1024, mode: 0}], () => {
            renderizarTabla();
            sess.addListener("dataUpdated", renderizarTabla);
        });
    }

    function renderizarTabla() {
        const units = sess.getItems("avl_unit") || [];
        const tbody = document.getElementById('unitList');
        tbody.innerHTML = "";

        units.forEach(u => {
            const id = u.getId();
            const pos = u.getPosition();
            const speed = pos ? pos.s : 0;
            const mov = speed > 0;

            const row = document.createElement('tr');
            row.innerHTML = `
                <td class="fw-bold text-primary">${u.getName()}</td>
                <td><input id="cli_${id}" class="table-input" onchange="save('${id}','cliente',this.value)"></td>
                <td><input id="sub_${id}" class="table-input" onchange="save('${id}','subcliente',this.value)"></td>
                <td><input id="ori_${id}" class="table-input" onchange="save('${id}','origen',this.value)"></td>
                <td><input id="des_${id}" class="table-input" onchange="save('${id}','destino',this.value)"></td>
                <td>
                    <select id="est_${id}" class="table-input" onchange="save('${id}','estatus',this.value)">
                        <option value="Disponible">Disponible</option>
                        <option value="En Tr谩nsito">En Tr谩nsito</option>
                        <option value="Cargando">Cargando</option>
                        <option value="En Aduana">En Aduana</option>
                        <option value="Descargando">Descargando</option>
                    </select>
                </td>
                <td><input id="con_${id}" class="table-input" onchange="save('${id}','contenedores',this.value)"></td>
                <td class="fw-bold text-dark">${speed} km/h</td>
                <td id="addr_${id}"><span class="address-text">Obteniendo direcci贸n...</span></td>
                <td><span class="badge ${mov?'badge-mov':'badge-stop'}">${mov?'MOV':'STOP'}</span></td>
            `;
            tbody.appendChild(row);

            //  Obtener direcci贸n real (Geocodificaci贸n)
            if (pos) {
                wialon.util.Gis.getLocations([{lon: pos.x, lat: pos.y}], (code, address) => {
                    const el = document.getElementById(`addr_${id}`);
                    if (el) el.innerHTML = `<span class="address-text" title="${address[0]}">${address[0] || "No detectada"}</span>`;
                });
            }

            // 锔 Cargar datos desde Firebase para este ID 煤nico
            db.ref('viajes/' + id).once('value', (snapshot) => {
                const val = snapshot.val();
                if (val) {
                    document.getElementById(`cli_${id}`).value = val.cliente || "";
                    document.getElementById(`sub_${id}`).value = val.subcliente || "";
                    document.getElementById(`ori_${id}`).value = val.origen || "";
                    document.getElementById(`des_${id}`).value = val.destino || "";
                    document.getElementById(`est_${id}`).value = val.estatus || "Disponible";
                    document.getElementById(`con_${id}`).value = val.contenedores || "";
                }
            });
        });
    }

    function save(unitId, campo, valor) {
        // La clave es 'viajes/ID_UNIDAD' para que Nancy u otros datos sean independientes por veh铆culo
        db.ref('viajes/' + unitId).update({ [campo]: valor });
    }

    function exportarExcel() {
        let csv = "\uFEFFUNIDAD,CLIENTE,SUBCLIENTE,ORIGEN,DESTINO,ESTATUS,CONTENEDORES,VELOCIDAD,DIRECCIN\n";
        document.querySelectorAll("#unitList tr").forEach(row => {
            const inputs = row.querySelectorAll("input, select");
            const addr = row.cells[8].innerText.replace(/,/g, ""); // Limpiar comas para CSV
            csv += `${row.cells[0].innerText},${inputs[0].value},${inputs[1].value},${inputs[2].value},${inputs[3].value},${inputs[4].value},${inputs[5].value},${row.cells[7].innerText},${addr}\n`;
        });
        const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement("a");
        link.href = URL.createObjectURL(blob);
        link.download = "Bitacora_Logistica_Cloud.csv";
        link.click();
    }
</script>
</body>
</html>
